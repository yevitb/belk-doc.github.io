

# Tabla de contenidos.

1. [Tabla de contenidos.  2](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.j3tt24eznz8n)

2. [Definición del proyecto.  4](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.iys9ktn05qbp)

3. [Objetivos planteados.  4](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.6pybp3uoggbh)

4. [Instalación de ambientes.  5](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.kbtaan6gtw1n)

 - [Windows.  5](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.vruws7mew314)

 * [Hyper-V.  5](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.8rk1mmik9hsn)

 * [IIS.  14](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.bwgkl17t95ei)

 * [Active Directory.  17](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.p56ia2aohzye)

  * [DNS.  24](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.p56ia2aohzye)

 * [DHCP.  39](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.p56ia2aohzye)

 * [SQL Server.  52](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.p56ia2aohzye)

 - [Linux.  60](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.qwqa65ptxkrz)

[Correo electrónico.  60](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[SMTP, SMTPS  60](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ogfq9fw3k9i7)

[POP3, POP3S, IMAP, IMAPS  64](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.7uryooasl9mu)

[Amavis y Spamassassin  68](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.whnwfrcas5u4)

[LDAP  71](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[LDAPS.  74](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[Apache HTTPD (HTTP, HTTPS).  76](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[NginX (HTTP, HTTPS).  88](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[SSH  93](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[Firewall (Netfilter, fail2ban).  93](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[WAF (modSecurity para Apache HTTPD y NginX).  103](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[PostgreSQL.  117](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[MySQL/MariaDB.  119](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.i7y6ilwon7xu)

[ProFTPD.  122](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[Dispositivos de red.  123](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.eo64xgxzgh2l)

[Instalación de BELK Stack  127](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.fa6mw77fx93b)

[Beats  127](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.4aghjnhws0ku)

[CentOS  127](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.gijt66u3vess)

[Debian  129](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.o52aj0rf2546)

[Windows.  129](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.i4vs05p413ed)

[Elasticsearch  132](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.lbzaxndbv759)

[Logstash  135](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ipai6exwxx0e)

[Kibana  137](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.z7nzdrmzvxr6)

[Configuración de TLS-HTTPS  141](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ucj65pwdog9z)

[Generación de visualizaciones en Kibana  148](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.6dmaeuskp811)

[Dashboards  148](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.9pnsa3mn4xhl)

[Email Dashboard  151](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.mczq3uvkmnn9)

[Web Dashboard  154](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.33c7dc3yvxu4)

[WAF Dashboard  172](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.tt2iid1n5dd)

[Iptables Dashboard  184](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.xyp1ktbp12dt)

[FTP-DB Dashboard  197](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.kiu1w7g07ov1)

[Windows Dashboard  199](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.8hhsj7t3ona7)

[Alertas  201](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.t44idrkm1kvb)

[Alertas de Email  207](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.hfxwrwdnnez0)

[Alertas de Waf  209](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.5xmm3uv98zw9)

[Alertas de web  219](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.4r1fbhv8rbeb)

[Alertas de iptables y fail2ban  228](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.5c0zbivsabf2)

[Alertas para Bases de datos  230](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.2g0wutbdwnzh)

[Alertas FTP  232](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.zhml77937rfq)

[Conectores  232](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.eeskrc9t3x02)

[Reportes  237](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.kw33xn20bs2k)

[Conclusión.  241](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.i660skopq26z)

[Bibliografía.  241](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.4l0cirg4qgbn)

# Definición del proyecto.

El proyecto consiste en desarrollo de una infraestructura que implemente la pila BELK (Beats, Elasticsearch, Logstash, Kibaba) para que de esta forma tenga la capacidad de generar reportes, informes, tablas, gráficos e identificar patrones anómalos a través de la correlación de eventos.

Los elementos de la pila BELK son los siguientes:

-   Beats: Son agentes de datos de código abierto que se instalan en los servidores para enviar datos operativos a Elasticsearch. Beats puede enviar datos directamente a Elasticsearch o a través de Logstash.
    
-   Elasticsearch: Es un motor de análisis, búsqueda y almacenamiento distribuido en tiempo real.
    
-   Logstash: Es un motor de recopilación de datos de código abierto con capacidades de canalización en tiempo real. Logstash puede unificar dinámicamente datos de fuentes dispares y normalizar los datos en destinos de su elección.
    
-   Kibana: Es una plataforma de análisis y visualización de código abierto que permite la integración con Elasticsearch. Los principales usos de Kibana son las búsquedas, visualizaciones e interacciones con los datos almacenados en los índices de Elasticsearch, así como la posibilidad de generar una gran variedad de gráficos, tablas y mapas.
    

También se cuenta con una infraestructura de servicios en ambientes Windows y Linux que servirán como insumo para el análisis y procesamiento de bitácoras por medio de los servicios provistos por la pila BELK.

  

# Objetivos planteados.

El principal objetivo es el desarrollo de una infraestructura que implemente la pila BELK, para ello es necesario implementar una estructura con equipos que puedan ser monitoreados y que generan logs para ser recopilados por la pila BELK.

Otro objetivo que se tiene es la creación de un script que permita establecer la línea base de seguridad de los distintos equipos que serán monitoreados.

  
  
  
  
  

# Instalación de ambientes.

En esta sección de la documentación se encuentra registrado la instalación de los servicios separados de acuerdo al ambiente al cual pertenecen.

  
  
  

## Windows.

Para esta infraestructura se tomó la decisión de crear dos servidores con sistemas Windows Server 2019 para una mejor distribución del trabajo. Una de estas máquinas cuenta con los servicios de Hyper-V, IIS y Active Directory, el otro servidor Windows tiene los servicios de DNS, DHCP y SQLServer, ambos servidores son virtualizados en VMWare.

  

### Hyper-V.

Para realizar la instalación de Hyper-V en un servidor Windows Server 2019 hacemos uso del programa Server Manager en el cual seleccionamos la opción de “Add roles and features”.

  

![](https://lh3.googleusercontent.com/NkYYjcw6JMmNV5qGrCtgYdmr04S3_cp8Ch3dvV0bnsO0jNEp0aUA3bMoLQYvgKsarMrGEnlW1zEKu7vATLKjOGeunAn00WFlQLlx0MzDpSN1gK_9Sdlhql9eX7lApfD9PBHxOt55)

  
  
  

Se ejecuta un wizard el cual nos apoyara en la instalación, en la primera pantalla nos muestra una breve explicación de lo que puede hacer este asistente de instalación.

![](https://lh3.googleusercontent.com/tCqUl7pmPM6xsGT_TkIPSdvN_vnIx654FNJXM945M2oVAFdWADzWJ9ftIUfGapqwGr5Peyts1XHGKQV8MuvjN4hoIwoqTGK86G1DxrTlqNtA-Lm5zVoymX22toBQez-xYDFViHO1)

Seleccionamos el tipo de instalación que para nuestro caso “Role-based or feature-based installation” y damos siguiente.

![](https://lh3.googleusercontent.com/fHL1zIz_oHmC5LRR60DM_vXLY-i6j0xcemH6EzgDPpaHikcD2ojDuMFsiVPzket0pg_uIXogBhO7M4Z63QDb9RyX0Zu4V0brvHIx9fQfidnomuKrYAU6VpYbx35OR8ztlcVVokri)

Posteriormente debemos seleccionar en qué servidor deseamos instalar. Estas últimas tres pantallas se repiten siempre que se realiza una instalación de algún rol o característica de Windows por ello se omitirá su explicación en las siguientes instalaciones.

![](https://lh6.googleusercontent.com/ztodvHeS8PV-MQP3Ukhql752nKtZNmw-N8_DboQZtwshWAU8hwhRhfoCyinYkGE0XrBzB_j9gvOIZYgYQvIWqvIy1mO5DYBpLwSHI53ujaGfPKSb83cvLXE52v1zD1uf1MXyS9kP)

Seleccionamos el rol que queremos instalar que en este caso concreto es Hyper-V.

![](https://lh5.googleusercontent.com/pzlS5s0bWzDW65m8uWiBFsDrCo_xGznKgM9ZoGHJjs0LpPOtxivwRNxUIwv54n_xfvO6zxbYaTpHkZv8RsvrPjuJW10SVkMYYfr1mNLq5-WK1Qg_ycTkVh5M1DFa1S8OrRyBGoXf)

Una vez seleccionado nos muestra que características son las que se instalarán o para que el servicio funcione.

![](https://lh5.googleusercontent.com/xSeb631oCQbt6650uWCgFqy_O2Xuem0h04N7QBlqq_7xQqFXwSD5dUNoSO2g4ucN4OM-IlZizfUw7TZMr2wBktnkHmbvaeNMPNJjPx12bFmf_MFvi8QwpKZlHf5imofc9wWUUzLP)

  

Después nos muestra una pantalla para agregar características en el cual no se realiza nada. Posterior a esa pantalla nos mostrará una breve descripción de Hyper-V

![](https://lh4.googleusercontent.com/-GwWupDzFzYWeyQaLnMcoKpsEavtD2tViiD3bs_MbMyvGX-3wMW7nNmpZMJmQp1NcWEevzWhET3FumnOipdjzD-ythY2XfQ1THfikRXLRbVZDPRZR83d4qmqA_M9g-Qmt844D2SL)

  
  

Después creamos un switch virtual para que el futuro uso de las máquinas virtuales.

![](https://lh4.googleusercontent.com/akoFbBYiPGvE-uJHAeXP1zH_cCYEpFJ85519vEgoPpWayLzlGlX7egKG-k73_PULHBAK0zJaOQSSTO1AXldENmF2kYgHYLEKFHgJ9GRE4OoJAnf-viig3pZQ8Oiyg7hRuyJ6cXB6)

Después se debe configurar la migración de máquinas virtuales, para nuestro caso no es necesario así que no habilitamos tal opción.

![](https://lh6.googleusercontent.com/a46bYJBxmjuC-x2iC97w1O-fujY7sjZDy0mpgkTQzA64adujTzj9z7UwoRhjqWP7lXF1mSG3xEE8GeZHoRSg6y4-j3Gx1xgUE8kiCDbanyzb6qmdG7FtOSBtLDFWwTGl33S-u9J3)

  

Posteriormente se configura las rutas en las cuales se guardarán las máquinas virtuales y los discos virtuales.

![](https://lh4.googleusercontent.com/MNQ8zI0l3A4JbKiSbcvr-u8vANIy7qAoZHiNdtgApNEvzjJducmhAWx9YJUedDuGy2RiQAi6pAkQ4PdiyVEsL9BLkT_Acw93u1jK8GjzQVTWCM77_0CHUPcbedWAx_kJbDGpryva)

Por último nos mostrará una pantalla donde se puede observar un resumen de lo que se instalará.

![](https://lh6.googleusercontent.com/MrJrxgAEY67JXlzOLdQIC84MebopmCGx0c43yPK9k4DOsfinIYYNNMVC4Li2Svxj55B5g7uhI--jRgkuzU3RwCn4c9lsuB4Kft38B71dlx5jPzaAebAifUnLp3SIifbl6TFvV3cM)

  

Una vez instalado es necesario reiniciar el equipo.

![](https://lh3.googleusercontent.com/qwajgtMvlhetERLASQlXrZV0CkMq-DnK6QtrdFUOJVS0qw4JaZXCdn6YX0e9xFzNTn2HK4j5Vsc9X3zHxf2STxBevaHzU-9IPuriQcX3xe68AHueDFiI9uzFtyuTZPNAAw2MOwXO)

  

Posterior al reinicio en el mismo Server Manager podemos apreciar que el servicio de Hyper-V se encuentra instalado y habilitado.

![](https://lh5.googleusercontent.com/EwXRfQciO8e8n_PFuwQMZ3JmxicXAVtMs_1uJIezPKlBCSCT_WUzW295889Z_WkKZmTF-7A-6CFTGFFUbQN_BJPammKfj1AlSe5ar-8PC62vWYvnOIckrBjSx5I2WawOExEQJiQD)

  
  
  

Posterior a su instalación podemos abrir el administrador de Hyper-V en el cual se ha creado una máquina virtual para comprobar el funcionamiento.

![](https://lh6.googleusercontent.com/tD1fJdgXSRW7QkMIT89g9ce9y9Wd6yjRm4b2AXQp6NNrw4WL46IhstfU3YyCyEppILt8E4Y9h3aJ8ZI3AMkEqIvMHJbVKrZfb6cYanwiTXwv9MMt3q3MqlTc7_XcY5fQFGvHNV83)

En esta imagen podemos ver como en efecto es posible virtualizar equipos comprobando así el funcionamiento de Hyper-V.

  

![](https://lh4.googleusercontent.com/Ej8HlxyNkOdAEoC-IREe-dqT3sX6dQXdP2If7EzGPvGwJdbfsFIMrokTqN_KIXdq0c1HhnVl0m2jNSVRkC5-Ls0VvRnOkkzwTzePP2p4G2LIRYerFY5af9db68ddux0Pc9SEc-Zz)

  
  
  
  

### IIS.

Para instalar IIS hacemos uso nuevamente del wizard para la instalación de roles y características. En la sección de roles seleccionamos la opción del rol de IIS.

  

![](https://lh4.googleusercontent.com/McrkDeRHOrGMHg_Wk8CgTCIuwLEoRYW4ue-ILIpHFmgdfVmgOsQTpZ0dib8QGPj5tL6WdbrfVBv5Oxx7wpBEurJ32Q70yjujNFPavWVPlNfY10MdecBdmUQLyGGHWNCE7qjnsYhD)

Nos muestra las características que son necesarias y permitimos su instalación.

![](https://lh5.googleusercontent.com/3wNruxnOw2qd0uFHDvVpnHlqhSpKlz-FeMvOyxX1tGuYSoF31WHV3g1ZHp4PelfPeobSpc2nQHRsbR3kVqYglH1z1uXrzILBninjPO9Z2YNw4e5XpEIpkW2xJVqeayIsoEUzHNMp)

Nos muestra una breve descripción del servicio de IIS.

![](https://lh4.googleusercontent.com/KJEPkRlgvGXefs2jQCxNM-4sSDIQ6QsMPaA2Fb1Hgs7s48jnwaHL6FkdMhUOm2WJrhaNKZmYpyqPmAtS6UDIltz76EdjjcFc7KGOYvG_b5sW11ftyBEm7k4xlUCahGoPQv7lOoOL)

Después podemos seleccionar los roles para el servicio de IIS que sean necesarios para su funcionamiento.

![](https://lh6.googleusercontent.com/qugYqyIOtpaj0Fgc0z-edNDoGWO4Xpz_r3F7yW4dIGo0lHfAxRPbfwkFVkOCEgGOZo_3HBRxavCsJEJ5bq-q3MT5I5u18oEwIKKcfvyWW0bZ115GuaGe_PBppHWOLs7wxKzNxES6)

  

Después de seleccionar los roles nos muestra la pantalla para confirmar e instalar.

![](https://lh4.googleusercontent.com/8hPWwwU3r7JLT3hDO9ZgvqaI_9Qq6xpc3IMnF06khX9lCYuY1rNWUwjCZpGBl78ugeR4-uf8A7wLsz2NLQFfWbSUmeoDbM1v_Pt9tevqZ2prFQyBru9ZUWHaKmThoeGL2_yvg6TC)

Este servicio no requiere de reinicio así que podemos comprobar su funcionamiento accediendo a la página principal de IIS mediante un navegador web y accediendo al localhost.

![](https://lh3.googleusercontent.com/YDHvQp1QaMMDK-qeyMGnIWhMrnC46Sy34-BaGTPMqWYLoOR-nqTSC9QxAsLhLUzbz6eMUWX7luUhmlvCLTgFOc05kbpCsaF9yOx5y25BWUSyRvl3gOjwitG-m3l7Lc8fAuWLHAZe)

  

### Active Directory.

Antes de realizar la instalación de Active Directory es necesario configurar una IP estática al servidor que esté en el rango de los demás servidores, además de asignarle un nombre para su identificación.

![](https://lh4.googleusercontent.com/rTJUeB5wZbGJq_WnIZb7VWLBoebfX5uBpeWnnCTrV8GJADzp9n0BMwooBD4ibls1rk4C1x3QTa40KpCPqYse7Yj4M7AG2JdlJpLbHun_LYaTQyg-z6WapMHtCV4bbkQo3oQv5d87)

Una vez configurado estos detalles volvemos a usar el Server Manager para realizar la instalación de Active Directory Domain Services.

![](https://lh4.googleusercontent.com/toIVYgQb4HfjCK3S2Uhm1qT5heUbiDgJ6ZJmCn0s2AREFh50Fw0KwsdHy5F8ekXwnavbDkOFqAKn4Hdfbdwj9TBgh0TitHJGW-FohBy6zZtT0UL-pMnzxjWl8qUmKvmPzOEXj2CO)

  

Una vez seleccionado el rol nos muestra que las siguientes características serán instaladas conjuntamente con este servicio.

![](https://lh6.googleusercontent.com/ejyRvXYgWvZZGr4izoNKWJG8oqeOrlQanlvPwEftxrCtgzx-pHL9e5J5JaLZDEFakqQsl68RtdUS5ayasF1tlTLFXh5BUsssJhXRm_sDx3lEZPYRRYooslDFnsPoepibL3DLt4BA)

Posteriormente se puede observar una breve descripción del rol de Active Directory, continuamos con la instalación.

![](https://lh3.googleusercontent.com/O7q4CaEOM8JfNOLI0CsP-wQPkvjEAyVBRsWLjyKktdTzEA5CmtgjZDcd7-EF8iTvVRR2WOcLN0qru5rbCFs3MVnc9z_cy9Eopbjh-8wb6VtlkhyR8gR3AHwQ12R1Sln0rlK5Eab6)

  
  
  

En la siguiente pantalla se muestra la confirmación de lo que se instalará.

![](https://lh6.googleusercontent.com/JOJ5T7VHCD4lZ-f2ZEqFrfrf8nD54Hej5mTd7yldfbFbg_QTJqtZH8o7pQd1zuBdJ9406TW68Wn5BtqD1tn3-78-ldcZleLo_n4pbxXnqF-9RqBJ96CPjaFJCuZN3QY7ALPFBNRw)

  

Una vez terminado necesitamos de promover el servidor a controlador.

![](https://lh4.googleusercontent.com/DliWtT_59W3QP31gbG0PqFr8emaR0OcE-M4NWIkiT_8OGOAoQQo6GtuyODhFQ2y5NfoA8R8PBktbNOSCtmLQ_emCPck7gI2dvnDgBthWlZTl7CBcLbWkrUpvakGq-oH6g4S5oZVS)

  
  
  
  

Seleccionamos que será un nuevo árbol el que se creara y especificamos el dominio que es aafa.local

![](https://lh5.googleusercontent.com/EtbGmxkMsnTiT0ZXzDtKHTt4AyV23d7kOQWybr77JYTZGoDv5SqzXHimxZq3v3g3jjyzbpLPvHekYvlGu5MtXoFzgpXNBNJ6irGwlQd6B_oFk0spJUu5YnQka9X9rv0j3KS2s7Oh)

Configuramos el nivel de funciones que alcanzará el servidor así como una contraseña.

![](https://lh6.googleusercontent.com/uZtpUXn40jcl2Qp0_RpDWt13DNgCj5Wv0xwRNmsGrmrSW5GGRtW-zfldLWv3L374HqnJyfR18bZnxpP_T67eYqrRYc5FFm74W85IemPK6mYOL_miN61dgCWrg6-qLUMMSRJV3O4o)

  

También definimos el nombre del NetBIOS como AAFA.

![](https://lh3.googleusercontent.com/9Y0V-Rz5AtiIn9Cdj2viaftnSfD7LjB_6ALGh2MlX4deLSD5oT6MIcnEeyiQJi_U0QuBHZMI0bXZhZmJi5dd50PtA3NdTu_-IEN2Uh4lOpowm_36D0dZFXe-vGY9clgIyXgfIHW8)

Posteriormente configuramos la ubicación de las bases de datos de la que hace uso Active Directory.

![](https://lh4.googleusercontent.com/NIVkTpmYz0fKlux2-OR31bgxxaEMtvVEygWondAnJNJziqoosv7l4TA4BV471NIJ_dvkDGsTWeWFziT0zd-scnwGcY4WMHkYrBMA3ziZXVIeyws-TLQDbSqjOheeB1VAJ_OtzR3A)

  

Se muestra un resumen de lo que anteriormente se acaba de instalar para confirmar.

![](https://lh3.googleusercontent.com/ki_HqXTVvZpSoj_Es8WUjBoI-7iG0sM5IE-G2lIv1exjIHlQwbrw3EUetTqcZrb2PTGbyASoH5VQUYsUxZ5WZsHIAnIvCFIQm4fNLUveFtUHkfMF8caoRNBAN84Bq-pF-xnDIaok)

Y se realiza una revisión de los prerrequisitos para promover al equipo a control.

![](https://lh3.googleusercontent.com/b_Z31hRR8q-0gNtrrZ87V3jQw5VV4maZGZCjy9HuqPSpcTsnmeT7E86tVnAjnErB5RSzoENOZb4_NXaIXglp3Kx-K55a-aR8VRALbTs7Q0tzFlqAAOLZHPSV_mlBPFgyV6twhi8y)

Una vez pasada la verificación se puede instalar, en este caso es necesario reiniciar el equipo. Cuando el equipo termina de reiniciar se puede comprobar que el Active Directory ya está trabajando.

  

![](https://lh3.googleusercontent.com/tRY1Yi6zqiOD2O5Ux3K40l5gqyQRbpmwLGI9EMZJZbjRonnsZT1ksXg0_SLZ5K5b-OKjDW039EiLooEf2_-zTiWz0Q-YqaQYfqZk3QZHV7zYPw5Y7by7kFISWFP-kzcRqKx-sskF)

### DNS.

Al igual que en el servidor de Windows anterior, en este caso se debe fijar una dirección IPv4 estática, en este caso se fijó la dirección 10.10.10.6, y formar parte del dominio de Active Directory configurado anteriormente.

Una vez que se realiza lo anterior, procedemos a agregar un nuevo rol a través de Manage > Add Roles and Features.

![](https://lh6.googleusercontent.com/u4bn_VmFVucAgfD19JS0nTnUDG3mC88wmdMjndiLvsQh8m23sNcFPgpIKfkzqJTqEyPdNtureena-GGUO4gK0AQ3Ui0uZU3yfUQjsbKelebqj1DdYZ-SETg41Ys_aQlNCoc9FJwl)

  
  

En la nueva ventana indicamos la opción Role-based or feature-based installation.

![](https://lh6.googleusercontent.com/ueJjz9-Xxjgq6XPAvxV1RK6zBpfTdXSA2agnydpE23eeK5f47h6-cvda0doxSeNncLEecdRcAaKEMqCeGdYt7C1yZnFoSIyrlQICeaY9wjQTSIOiCu1k7L_zNcsn2gq-TFRGf1Kt)

Posteriormente seleccionamos nuestro servidor en el cual se realizará la instalación.

![](https://lh6.googleusercontent.com/KN6Kx-jjna8ZfbsyPscnao704Fa3jDbPrjKRX5WNBP5EEOWkrgIHr0o122VHc2xlfljmPa7J4tywjHJ6OEFzKWJNuZ_YX8uC5z3Y27ayi3NbCtoX49fdtz0zMbFr4QCF2DhlVuuz)

  
  

En la siguiente pantalla seleccionamos el rol DNS Server.

![](https://lh3.googleusercontent.com/Fa9UcwUShxj3faPiXXvS_Ccq3qWeDjfzM0bqJZO4exWBly2fbatIQyyO36ehj2N_C0ak-W3GzXpGXIRf_GCc4OOsPWDG4aI3ij35G9slobXANuYgapp8Ww085oimfTSSk7ubFjyh)

Se abrirá una pequeña ventana en la cual confirmaremos que deseamos agregar las características requeridas del rol.

![](https://lh6.googleusercontent.com/nAN3x-wx8Glzx7Y_Wvm-_mTKErztVXUX2q7OP1TYsRwlhfX8FlP7-4K2KYMq1SPxYbZk0ieY9F0ob9ZSRV_VpPn20hhwEyEjZRGciXPVS46kHfOgj6ja-IlFUqt_FWDyRgBC_Igv)

Al cerrar la ventana el rol de DNS Server se mostrará seleccionado por lo que deberemos hacer click en Next.

![](https://lh6.googleusercontent.com/OLLuCRdaM9LHoDVJvaCjEDa61FmZZO1CHHSsePeV-jRbUweNsk1ysZl_ipJE4wllcf00I9l60xtzdSVsZVhZj8Gq0kncoUmD620eElaMF2-zdFzPu-ASCzlS6f2xlkvNoBo8zIcS)

En la siguiente pantalla dejamos tal cual las opciones seleccionadas de forma predeterminada y simplemente hacemos click en Next.

![](https://lh4.googleusercontent.com/SaE6mFdv9uWNmsxp1jMFuV5m2BPje0zV3Y4EZdO3SVaJZ-Gd-VowQn6TyqY77Krv1dzoQfy2iATsDR8tiY5KnKqGqF4q01Cp6kflwjkjaVLkdfBCcFFX2y5-G8wuZADR6HXKkjIn)

En la siguiente pantalla se mostrará una explicación del servicio que proporciona el nuevo rol, así como una serie de notas a tomar en consideración.

![](https://lh5.googleusercontent.com/o5xHh6Y9_olizyd5mjnvEUnKYFKU8c-MMRElwYVi387Iw7SUOPo1eZkrMsU0MZ88ZkAJhj3F9AgHLzURRR_xoF4HTJXSj7ppl8Gm864PJxXn1jOrP_TOhIBnmaXksAPEGu1HtvoB)

Finalmente hacemos click en Install.

![](https://lh6.googleusercontent.com/soWS6pZzd5GIIdpqX0r9607TvSobKutOmeMqd8mBZEgVKSOS49ojxKRW7mvMwkXvKmRnxy4OFYiiXW3T82ZWVe8HNdNCeTv8ZAylMmnqie_3NUZBrW8pOfzupxCypxMdf297JLmz)

  

Esperamos a que el proceso de instalación termine para cerrar la venta.

![](https://lh6.googleusercontent.com/7YPLaBOIH3vPuVaKtJkB306QJe5N5Fmryid91QjCHHRtZmu6KaJamPasdFS6rmgrPsBHEFtD83hwGWtrsBNMFLCKSaginsYfRED23VJRSmdau6vjEjtXML2n0F4PZr0_QWA3QIR5)

Lo siguiente a realizar consiste en crear una nueva zona DNS, así como registros A y PTR asociados a equipos que deseemos administrar. Para ello nos dirigimos a la opción Tools > DNS ubicada en la ventana de Server Manager.

![](https://lh6.googleusercontent.com/A-3d4nw6ZDzbBhAyQoUVniG9bGqFApo8pCtDH4eS3T-4bEtukBRA4zU7QRBrgT0xVYaTy1ljJXwIFbzM68xe2bfd-6tHyxN1DzskzmutV36exnuJ1cL3L8PwexBw9yhXIK30WjVc)

  
  
  
  

En la nueva ventana, dentro del panel izquierdo hacemos click secundario sobre la instancia de nuestro servidor y seleccionamos la opción New Zone…

![](https://lh5.googleusercontent.com/eeCgbNKW2gXDAZSTgTkrJPt_5W_W2mMW9p5bK2JIwIKEmKbBXbpAPndQNZopenhaTyJCEgQDyzvbRp3AacdXi67ZOe2-bLjTuamIsiauDjxuJhRPHMZQJRAjBmwF9HQKKKDOhwxL)

Se abrirá una nueva ventana en la cual simplemente hacemos click en Next.

![](https://lh5.googleusercontent.com/F5k1zbOkRFXj2LxzpJpuH3kzzSNvJf07kQljxKn3qhXyDKyg3ozP6DddlQnH2IhnUHATp2aB941y4pKGtCOauVMxOy9wKS_EVvBSFpzmqvOnHifLlP8-95cIEFXesYP1bHC7aB6m)

  

Ahora seleccionamos la opción Primary zone para la creación de una nueva zona primaria.

![](https://lh6.googleusercontent.com/la9Xcv27SiNTiQ7JpwmuPdCzCtjJwLxNRjkUCi3rWM8ILKyDtzFFoB06q0lXf6Ba01jmwbhzMFChbIC-gABewZGx8O3A9y1Oc1EPcihmtVXWXd75C6WtLG0uWKZsyeaexFSe7jln)

En la siguiente ventana seleccionamos el tipo de zona Forward lookup zone para la traducción de nombres de dominio a direcciones IPv4.

![](https://lh5.googleusercontent.com/pUOc3t7x2S-LX7rDQWDUKwNECnPcSaXCid7RgXx4SOS488eRq8shnn4PFvQJ4JpEz8UuiWChoJklbfc1LeOmS1hvDX4iUOOZX1bxTlWG_Z_M8QdS7_Dh-zXEmJh2LvAUFsYtCkxH)

Lo siguiente es indicar el nombre de la zona a configurar, en este caso indicamos aafa.local el cual corresponde a nuestro nombre de dominio.

![](https://lh3.googleusercontent.com/wyb5MhMLLFfodbk3tanSpUjuf28EuDCu0V6JgPwkj1rVFg8kfCFK7v9VptT08ZImyvuvxyHshIwVCvtkee-Bime-nIFpvmjkSyAD2_J9RNoWDNUvp7kLb7Oo31lGRwm2KT9EFxlU)

Posteriormente indicamos un nombre de archivo a generar, en nuestro caso dejamos el que se genera de forma automática.

![](https://lh4.googleusercontent.com/k8NLB1xNp3LkPc_KIwaQ66b72M3tKsIDAhOQxVLuiws1CKAxij8pybU1JdPTWxk9sJYrPlJErp0ZAIvM6zMpyQxQXR7Hfiu6z4ufpEceXAKn_n4FoP5dDvpcrPdfFTBbJ9TU9jcd)

Luego indicamos que no permitiremos las actualizaciones dinámicas.

![](https://lh3.googleusercontent.com/WSEmV1S1Beo4x3Pr84kOYxBE3Dmam-Lgo-cY3NL_9P77bbNTisKtX_EDFv9ahFQQ3s16CqWBNmgXkmMo4AX3CqziTTdDjZ7wITpH5clHo44unm4wg5iKFH6ez0kIWExCoR0yVviX)

  

Terminamos con la creación de la zona.

  

![](https://lh6.googleusercontent.com/eklURWC-k2JqqkfyI1MukiXXOkvNBKrKlgNoo7_naRP6Z5Gi6Ygln4yfpGo8N9ppyaV2jBS0atAuDu9POdLh5LcHf6jfxDQvFWI01PmcN11OCiCIZLWonzPfSihQq4bfI8UUEPE6)

Ahora deberemos repetir el proceso de creación de zona pero para esta nueva zona seleccionamos el tipo Reverse lookup zone.

![](https://lh4.googleusercontent.com/NeTPPAQzr9TWcNW24_a6GMJd0E8tulWoCR_NF5upurM33IpDqC2ZHWT909D5t3IOhuPKQD5-WYX_0eoH09VKROo7b9beUlE_Gc-DMmEGEZD5B_Esai_xlDz-zwF0x-kZYxbszaK7)

Indicamos que se trata de una zona para IPv4.

![](https://lh4.googleusercontent.com/DUqU8sp_WgiwECXZqqLEDI0s7v_s_00SQYrlJuglBZQZZB5oFcl9Ev1uVETe7MAt4VE12eRF5PQI8XrDH-WfvkZgsbvlzwdW2VnEJZzCHJ1PYzyu9gi0BPVeAVchDMelZPMoSLAt)

Ahora indicamos el identificador de nuestra red.

![](https://lh5.googleusercontent.com/LocnXIPGsuzAKEJEcs7eNdtmNiPa5JT6Oiy0QBlv85eutVopLq9ZR4kUWuSI20OjRnk6Bd4wQWSzNRBcA65WN-XtnG4qLFjdGOzgxIBANFX6XqHbahmRH-3_VOak_Q5H3si2g7AD)

Y establecemos el nombre de archivo a utilizar, en este caso dejamos el valor por defecto.

![](https://lh5.googleusercontent.com/7RXg6vdp3nkCZz_usFbpawKMzgPfu56YznR-iDGCJuLP2wxYIqxYJgl2azq33iSPiSLWQo2O6kWLAuyChtNVqfEmKx0pj4Q_8FrEqkBiBV54-MomvS3cB0azEo-cPVnHDC-Uh17F)

  

Igualmente indicamos que no permitiremos actualizaciones dinámicas.

![](https://lh5.googleusercontent.com/IRc44povAbzMF7gMnxnPx5pcuFmD94ff08DZowfTPz613Oj7gqDZVWsQIaXCl00GhCrcpFh-G7rJvfqAe5ytkPIb_Ljpu136LA1Y0x27Nvo_qH8uq6x2zvEtzmdn1ZHWpVBzlNns)

Finalmente terminamos con la creación de zonas.

![](https://lh4.googleusercontent.com/AVeGP-SUaeOJv-8aBYObLeyemix9ewrpAySF1RD40SB-zGr8-bKcTuCno_cAw8zfwYL4LJVg-lslGB5sdMcMF6j2Y3rNLgHdC62o8K7amy33-XB4Io_Xqc6HKwGuLTN7E2E0jBRX)

Lo siguiente será crear registros A y PTR asociados a cada equipo que deseemos administrar. Para ello seleccionamos nuestra nueva zona aafa.local y hacemos clic secundario sobre ella. Dentro de las opciones desplegadas seleccionamos la opción New Host (A or AAAA)...

![](https://lh4.googleusercontent.com/zYuRPVekTj9rXePc4PME0NZcSVSHzxIYJjHklwGp1jTn2hU-vTZmQynr-GJR-cz8OVMq8aAf1NMo5QjDidgd3QJ7932OTgb-ps7RHhyHQBiGYZ7yxDzaRZWjPxWTrJ6QKCXj_12r)

En la nueva venta deberemos indicar el nombre y dirección IPv4 del equipo que deseamos identificar. Adicionalmente marcamos la opción Create associated point (PTR) record para que se genere un nuevo registro PTR dentro de nuestra Reverse lookup zone.

![](https://lh6.googleusercontent.com/tKh1Tw3IKFZu4Mul0qjxCG3_-cFpI2Uzhq_vCn2LGcSrW3sgWFkazGfS568x2voecT8i4O4CIYnsjLv337KRF5oMvfFYSImkuRzFkhq0tmFVBCnJtypO02lnx9wIcLgYrQWzVAjo)

Hacemos click Add Host. Se mostrará un mensaje indicando que el registro asociado al equipo ha sido creado de forma exitosa.

![](https://lh3.googleusercontent.com/-PHGF4waj3MaSCiCSGh4hP1yXeIb8mRX7a-l9YlqHrNsC0U5ORKnFRhIMB1w5bRAFGTNxBhKvtm7j-GG97SXKmFFUopMIsZO7PS57tw-meBg_aBAz8cy0f8clIYOgRUsL890WILo)

Ahora verificamos que nuestro registro se encuentra en nuestra Forward lookup zone.

![](https://lh6.googleusercontent.com/ukoZETw-5tbvOTKmqdkjOwj2y7vWeWxKpG2x4P5g1VJRb8yCoZQsoLjVrkNbzUfd1W1IMQB0TKtsenxpBqPj35MGvKp1hqvRwY8WcWdxL2l-UkQaM3OBMlK5S0R_f3LYoEqQRoAZ)

Y finalmente verificamos que también se encuentra el registro PTR en nuestra Reverse lookup zone.

![](https://lh3.googleusercontent.com/Sf8GgYzqJaglvO1q3Lgi49nztspAfPkqvot8iOUAbUMd1SQztgmC-EMFTVrwe7Q20IG4lY21Ag_eoKfwRiySXlfMmXrKOhD-Sysbi8UNUk7hrIEkdYFg2U8SuBBH1XPuIdsdLP6b)

#### Habilitación de logs

Para habilitar los logs del DNS debemos ir al Server Manager > Tools y seleccionar el DNS

![](https://lh3.googleusercontent.com/uEW0KxJNB2bD67uBHA9FPbmHSXapJCsmbn0Q8r4X3Q4oxgg23_LrU3bd1GfxMT7fm18dmwaYBV0QVyiDMcM37Vf4JrqgcMQ8fJ9mgjK6lmJ0DiMaKncauq85p88tbe3YC0l_tf4i)

Una vez abierto seleccionamos el DNS al que queremos habilitar los logs y vamos a propiedades

![](https://lh4.googleusercontent.com/xjn_hSaKhwILGAkv6EwuMVERj4aOVK-W8azp0xU1iR_8KC5P15MmShQno-eD05KWDd-yQHk-VmmsBlDzxy6GZuDDThz5Ehal-TliqDaUJoxY1z4Upu71UXlIaNYlNN-g73eKmVJu)

Ahora vamos a la pestaña de Debug Logging y seleccionamos los eventos que deseamos mandar a un log junto con una ruta del archivo

![](https://lh5.googleusercontent.com/e18LzstXm0xflpfcspNRkUGicgI06_ca1Z6S31Ih3xBizIZ5tCxauaqI86_QU4lPr5AbI7R_bitF7LWE0MTHtPW1f1qgTTpGKOFpjnSpoujNhuU03cNRKialszC7iTxJc8AxwQGF)

Después de reiniciar el servicio tendremos el archivo de logs.

![](https://lh3.googleusercontent.com/9vW0xvtERbT_a1Bb_Td9E09rprNV2Brs1pymzXP6UA4lq4tL_hs6I5XYRdQG2mDPh7Zo29euUXscpU1XLyWsz-qJYQdcFJ_hYLSooSuY71EhegZtAPQVG_V3k3LfHHPKR3II33xA)

### DHCP.

La instalación del servidor DHCP se realizó sobre el mismo servidor DNS de modo que no se requirió alguna configuración previa.

Procedemos a agregar un nuevo rol en el servidor

![](https://lh6.googleusercontent.com/u4bn_VmFVucAgfD19JS0nTnUDG3mC88wmdMjndiLvsQh8m23sNcFPgpIKfkzqJTqEyPdNtureena-GGUO4gK0AQ3Ui0uZU3yfUQjsbKelebqj1DdYZ-SETg41Ys_aQlNCoc9FJwl)

Al igual que en el servicio de DNS, sobre la nueva ventana avanzamos la pantalla inicial, indicamos una instalación basada en rol y seleccionamos nuestro servidor actual dentro de la pool.

Posteriormente seleccionamos el rol de DHCP dentro de los roles disponibles.

![](https://lh3.googleusercontent.com/rBl_KEufuSNI4qr4UpHm__Z-Yx7_dnlrmj1AnYTnnrzdgbUhwUw_Mw6W9R_WQKb2mLTAO3-O5Lxn2QmtkChW3MPlcTB35T6NA-Zx-FwIVzvVPyc7m9ilSIAoRkkEoNTnpIwX7Bb8)

  
  
  

En la nueva ventana confirmamos que deseamos instalar las características requeridas.

![](https://lh6.googleusercontent.com/JP8zcmK_H1-ENPAvOuolAgMQKb2ydSmOaw-xwLY8sQZco-Tw15SQjuIN9b81c_t4UmzWtkdwiqnbuzYJx__NHxjAJldhqb9x9K3PM6grzDQ578KPgRmKj-nBl-vwwUl7CHMqgg83)

Al cerrarse la ventana se mostrará el rol de DHCP seleccionado.

![](https://lh4.googleusercontent.com/Ytx3RAA2zxNLixuJKjGlFO-xkFF7V_U4ceznZh4qNBi_5uiwsqdWadsbkt92IbdCN8GnQLxFCrE9LBbeqdhPjN7XanWkWpwu_pXoBncJDeUOwuYRUlrdrNaypNNu7NeBysKEPLMj)

En la siguiente pantalla dejamos las opciones por defecto ya que no deseamos agregar características adicionales.

![](https://lh4.googleusercontent.com/TMapaKRZa2ysw461qB7x65Lmw-TXhMeHahumtI02Gd_ysrDrhCz-u_gVmhHn0YVFaXplDBC31M3tqAwh6F2xhdFE3RcnpnPLPWo0_tDzBiJMgspUGuwd-bhidvMWj_y4EW-HtBrU)

Leemos la descripción del servicio, así como las notas a tomar en consideración.

![](https://lh5.googleusercontent.com/O_czz6hucPHb2fujIRLJNg0aZbj_4D7jsHATSdcVGcDq5XS8xYpkwstLZSXuFM8_kN7KX0Sr-WSddQrUvIdl66p_EbKTEqaa7br_LeQxjYLp07Ed71XakzqbJKc7dlTmjiNHuJDN)

  

Confirmamos la instalación del servicio.

![](https://lh4.googleusercontent.com/QbrfxAVtjsjyTRGRy2aJQIhNdUJCdA-NyO3Lr-3ff4zWG2mWsTDotHPwnKHd9NUZ74oiCm1OvU_H71rhqKnDKhnRerw9jOI0VZyuWrfooh9dervV2PtdH3G3hC8Wa5RgqjpBsLeL)

Una vez que la instalación haya terminado podemos cerrar la ventana de instalación.

![](https://lh3.googleusercontent.com/nMCITnCz9rYKFF4bRYbzapH3bjj4aGZlgnXziMochYqOPJQJDQx2IQw-S9hVDg_kh4Juk0eXI4ZvoU-xuUeWi5Mb4uq5G62-oFSxDKtAFFCgJN8wPN8yG4TROeSxQtoZxztFu2KR)

Una vez realizada la instalación procedemos a realizar la configuración post-despliegue. Para ello hacemos click sobre el ícono de la bandera amarilla dentro de nuestro Server Manager y seleccionamos la opción Complete DHCP configuration.

![](https://lh6.googleusercontent.com/or_tEoGzuohjpc1gUnBU2H8zJaW2UyRcyOi6AmJyzESmmhikM_KTovF0J3UIF8wFDxFBrTEY-7ALo-umeVYinhoRUR4ZUDNH1pMjstx6AF8pk3S1WonWZB6IBCEh3lm2d_Qoxqs1)

En la nueva ventana se mostrará una descripción del proceso de configuración, simplemente hacemos click en Next.

![](https://lh6.googleusercontent.com/Y6tmMnchqxsySfw2S9PYbUezykVfhUfWZSdJThCcoOff7B3G9GGVmW17BwwFUsACLtruxPdLrpRUWfx_N9XGMitoTzriSnVTdLIMHWtzyT5AJfnQfOpPAbYUJ82CAQmrP_M2B-Ak)

En la siguiente pantalla se pedirán las credenciales para la autorización del servidor DHCP dentro de Active Directory. En nuestro caso indicamos al usuario AAFA\Administrator y hacemos click en Commit.

![](https://lh4.googleusercontent.com/PPPY6nF9JjOxC-VSDcPDym7CGGxleO6SByEZX4PKBx2tU8k8oJWu6O4d_TD-9QG1rMWIpeqZDEsq4yRN9hxbnEzkyYoIpPSvQwNb1BdyWPHkm_VBQnaaSLp7ZuJb8C4uqzpxs6He)

Esperamos a que la autorización se lleve a cabo y cerramos la ventana.

![](https://lh3.googleusercontent.com/JVw1He9_RfZI_Q3FBULyNFoObsDO3KJBGmqXzPyUs1xwCtKLBATs7EFxx5C0XVL90e-zfHnLgIcclZna8_lI1Fl4hej5WRFfQAWFvzYtofvkgCvBoXnd4Ok2DIov1sWSoyd50qzS)

Ahora procedemos a crear una nueva pool de direcciones IPv4 a asignar por nuestro servicio de DHCP. Para ello nos dirigimos a nuestro Server Manager y hacemos click en la opción Tools > DHCP.

![](https://lh6.googleusercontent.com/RSBQyUe1JX1qSfP0XdajKFUlDVYxiFmOnpNWLkB8d3QaEDstuh5TxccpyvtCEBEj1Yf5tOuS1o1zENxPQIcYIlfgFAjeACfy3ccbugW0WYvbxCf_hXOPTsYCyvYkkkvlzJa1hyGC)

En la nueva ventana desplegamos las opciones del panel izquierdo y hacemos click secundario sobre el ícono de IPv4. Dentro del menú desplegable seleccionamos la opción New Scope...

![](https://lh4.googleusercontent.com/HOkQ7oNlJjZaXYN_x7PjKuRvKXuUJrVhFmjmkVRVkWPKN1ZhFAjoQajCi1IeFeHs-pdeAVtZiICWLSrSdDYHGV9UN1Vcv4SiEepTOMoRDZ99caVzx_5Kk4Pa3P2TCj_D8CN6b3KB)

En la nueva ventana hacemos click en Next.

![](https://lh4.googleusercontent.com/aP9vpN_Z5SzKPF7JbRH3tQk6GSgrJWY3Wh5HyFDe2JfSneNABA-bpTOrggx-eS7pKc75cH6T6uRzZTuZy8bC0qt3bNeoYcOrGhJXT5ay6rz3gtJr9BqC-KOKgBIpWG45NG6MrhCx)

Ahora debemos ingresar el nombre y descripción de nuestro nuevo scope.

![](https://lh6.googleusercontent.com/eWdbPJAnjrIwivCDBkIJSZ8Ww47RrbZSsTlzwQYMzP9BH5OST0iCkuB2Uk4MXZYadTCKWDste9WgAG9ZEvM0YCFnwrcY0ke8bUxeCNiOgcC6TCftnSPjXY2FIHYx9Di-Ny6oQ2Ko)

Luego debemos ingresar el rango de direcciones IPv4 a asignar, así como la máscara de red a utilizar.

![](https://lh4.googleusercontent.com/6f24BpjwFf-_rhZrg7yZhxab0fWPG5dPdiRRA1KqY_GzFP1uvRx169urYPkrYD7fCM_jeOGGecS5_8igceiKQnR9SVllS_XHSVhcuENjCcmMdU48pdTWfWdvkNuP-qbgnSnveGO1)

Posteriormente podemos agregar un conjunto de direcciones IPv4 que deseamos excluir de forma que estas no sean asignadas. En nuestro caso excluimos las direcciones IPv4 del rango 10.10.10.5-10.10.10.31, las cuales están asociadas a los servicios de Windows y Linux establecidos en el proyecto.

![](https://lh3.googleusercontent.com/JERTAI5MRbpPeeglbYv9hgcRLY_H-iEnrHUqXt9zum7Y6WHwI3MAWxBmkClW99ZLUoYI9gG1BwQXm6SperLkBgTgY5pIomdNE6OphVXq-dWHmFn4sfh91_8BbUYRYcnalVRyUcnO)

En la siguiente pantalla establecemos el tiempo en el que un equipo puede hacer uso de una dirección IP.

![](https://lh3.googleusercontent.com/jV-ETSJQ5zQwRPmSAAy2OGv01WHCxL3AgamHMjPYfdgthr32CKTcyvPj-hIme7iX4MY_DM6kzdaX7kZdV023tNCJZZYRqa8D3qAPzmgYYV1TeWqqbqhe3wtbaFaPqAhWCZLYgCrW)

En la siguiente pantalla se pregunta si se desea realizar la configuración de la dirección del Gateway, DNS y WINS provista a los clientes por el servicio de DHCP; indicamos que sí deseamos configurarlo en este momento.

![](https://lh6.googleusercontent.com/-X6hTEovZciDKYjWq2AkvFUipwR2zP9dk4GvxNLUB4rcbgQvxYCHZOj1gTJTuSRF2l69s89M79MFdGZFBSiUuj5whQZpaaTQFl8113w2NrqFBJfsDFep9pj2PzwZXmtj0roRwI6M)

Se nos pedirá ingresar las direcciones del Gateway. En nuestro caso sólo es la dirección 10.10.10.1.

![](https://lh4.googleusercontent.com/W7PUFRtiDrDxsp5qHIfPZXchzNqoVq6v-RIvyVDFzl5tQa69Jp-z3JVh5lmso3eiSpDXBZPIP9V8Xbsy8AK7-HL6jaR9Ykf4DPSfghY1ave_hCZkFzMgCtuf55lTz1MIWvCEmzMV)

Posteriormente se podrán ingresar las direcciones y nombres de los servidores DNS disponibles para el rango de direcciones de nuestro scope.

![](https://lh6.googleusercontent.com/QbFTrdnLR1fKl3IxPSxOiNQBELbTUE43rfzbe48diNGjfyTl2EIPvtX9Nk-pNQTnFFC-Bm-95TBEXbwawP7Guseog8cHGZckOnUlbWesyNH3qZF_vPMNmCYoL6mYI8vncaiyLzCh)

Adicionalmente podemos establecer direcciones IP y nombres de servidores WINS para la traducción de NetBIOS a direcciones IP. En nuestro caso lo dejamos en blanco.

![](https://lh6.googleusercontent.com/37ESIoD4sBBtC65jrb5CKk-ldYU0J74Lb1EzrhszWUhs05CopRWX1z6KbCaxoLZ9jmTGJbjaE4hC0Z9KFHIDsEk4h3qS19DF5OsLT85rmIyAbzKmeIGFAJlh6XkSQ-J14GUQ_1vX)

Luego indicamos que deseamos activar el nuevo scope en este momento.

![](https://lh6.googleusercontent.com/zGbECgnpTH5gN4rFVO3ZqqPr3lxKUM2Ss2L605eG9eRAaVLPt3E-QhMLezdxvBpODrXv0McjXcEHt9GOlOJBO7zGvCwO9xIBREWXjGb8S3XngwS4atA4Vlkh3u_E4NPKEA1s_6oC)

Finalmente cerramos la ventana de configuración.

![](https://lh3.googleusercontent.com/ErIMM6DBg9wOw6o5845GAS8eV8pJZ-rZo41cA9xn1V-IubUoLA-80ojY5Uih6b8_Fe5GWg-LwQUXTSi4B5HIOWehTZ5aNS6vbZGYg4ddIZoQJujiJDTyOYCehk7UmRzRcv-5RzCU)

Como se puede observar, nuestro scope ya se encuentra listado en la sección de IPv4.

![](https://lh3.googleusercontent.com/4m_EQQ4OHALJ8nhp4IG2F3pVoqMmnHjMlReRiRrkVdlmX5IJRP8lS3wJxmZvrXdiqvA7R0RBsr28YcGwTq7qruFLHaA0E9N-t6enTlF65CUKcohuJ8g8k4fi97UZIk8G49t-yTgY)

Habilitar logs

Especificamos la ruta para la generación de logs. Además como powershell advierte, se debe reiniciar el servidor para que los cambios tomen efecto

  

![](https://lh6.googleusercontent.com/LsT3TSa-jzxPKiLYhlZmgYYn9pOairIslKEzPj-F_VzOhKAFbgzroIxAjkkH70AYO5eyQ7HZ49XNX43e3ptyF8u-sfJ52RSmFAidO_BUEZHPzjZALyd1lvHHEzf-nH50M00BQFPX)

  
  

### SQL Server.

La instalación de SQL Server 2019 se llevó a cabo en el mismo servidor utilizado para el servicio de DHCP y DNS. En este caso se instaló la versión Express, la cual puede ser descargada en el siguiente enlace: [SQL Server Downloads | Microsoft](https://www.microsoft.com/en-us/sql-server/sql-server-downloads)

![](https://lh5.googleusercontent.com/gqN5NGWS7SmTRMA-d83IE9Om7gncquQPWn-0ijMKMXhPXwr8CaqVDzh6MZFhcSSBVM9Sp-t4w0FcijvyraTv_zJjA7jKQP-GhPXJT3rws-FQrRzPwnqaUQ-JtmUcER2Jpnws4C1o)

Una vez descargado el archivo de instalación, procedemos a ejecutarlo con permisos de administrador. Se abrirá una nueva ventana en la cual deberemos seleccionar el tipo de instalación a realizar; en nuestro caso seleccionamos la opción Basic ya que no requerimos algo en específico.

![](https://lh6.googleusercontent.com/6tO2FNAhM5pkbwrMlUzWaP-luy3-W017LHp8lP-ys5Du1VGUbOrAw636kC0BN7o9FcYHUhlOONeBjsBNu8UWbVhUlkOaDEWBn4A1amMQESZV18PC9L791hXJMlhWONcGkEf70H-w)

En caso de que haya algún problema de idioma se mostrará el siguiente cuadro de diálogo. Se deberá indicar que deseamos continuar la instalación en el lenguaje de Inglés.

![](https://lh3.googleusercontent.com/mtmlpP8erC-pG7b6qNSKY4ji39ZnuJLFzCsdIM_oiodAUyu553AEKuHXeW2q4MeDJFCFw-f9vZNOjTQpBq3zkyvXRdIjNADf4QhL1yQvulJZMk-aFBZkCZg64Xfo1_wdTnZmSgnS)

Posteriormente aceptamos los términos de licencia.

![](https://lh3.googleusercontent.com/da6OAF0gPSmT2nfmU5NNNuwbyll0LVqBoRCkmQNxSg_G9tjtL8QbHSvqnZioK-vWw78ZfTlJsAloS8HREg27cfYTkXzSZMjP0j21s9_UttKvjFF99odz7gc-FuxcT2lnJzubRVdn)

En la siguiente pantalla indicamos la ruta de instalación la cual podemos dejar por defecto. Y procedemos a iniciar la instalación del servicio.

![](https://lh5.googleusercontent.com/zn-egQeIGx5pXJX6TdQyVAkfzcwjq1nnOtvDrODFCmnJaI9zsuX53y1tIptfMZ-S7Sn5MBsGtcii0ltLoHKK-DQMlFwwnhsfkxDTkXdr9NjqztEinyxB5On-qT1EfCMM0r8jj9m0)

Una vez que termine la instalación se mostrará la configuración de instalación final. Ahora procedemos a descargar e instalar SQL Server Management Studio (SSMS) 18.7.

![](https://lh3.googleusercontent.com/PfBuIlSKxM2kqA7XWdcgQC178NABVlHTYYqHzKBSf29fNqJRt8S--l8NWHbd6oegLARN_Sr_5gAGTzgbXnGGLImhlf4eJxLJcP0Suen77itEplBOMcPopJYC1WTmoSJyaoe9Raxa)

Se abrirá una ventana del navegador en la cual deberemos hacer click en el enlace de descarga del SSMS.

![](https://lh5.googleusercontent.com/q8LbyBXpMDzlDJkBwhhyW2ZwINu82noBjSca09PeBtCu50clMmIbBf_6daU57UuxrgMATD7wTr1jIMOYcf00CSEJHCHuhxM9qp_W8kOw9lBhXp9KA-YbVzkDQFtiw8rzLUXRQ5aR)

Una vez descargado procederemos a ejecutar el instalador con permisos de administrador. Esto abrirá una nueva ventana en la cual se deberá indicar la ruta de instalación. Posteriormente se inicia la instalación haciendo click en Install.

![](https://lh3.googleusercontent.com/cGoEbGa5kwlcpomL20REOAhvCFIwbaERiOnt8lomC0S9kkxTRgsAlC_61Z4_oEk1qhctfmCYzNvS8k8j_NjpbgUZZse-y_9ijTbvQQaPPtBrqxcNnEsmZt_PIXKO0lAl0NZW-qL-)

Esperamos a que la instalación termine y una vez finalizada, cerramos la ventana de instalación.

![](https://lh3.googleusercontent.com/m0Mo_gblhC-hIKIx2oKbvU3PVXKHVVjcTNe6rrJe9yEGEMUT6ZqxOeS0uiEOnN8CHJZFuPk-6Eosa8QsSV8lTn0pnAuLunKRaEeeAIr4gcRZxjRCHVZECeYcPfK8wvfpLHpKHclU)

Podemos probar la conexión a la instancia de SQL Server a través del comando sqlcmd -S WIN2\SQLEXPRESS -E.

![](https://lh3.googleusercontent.com/SNNLr3d4HhOQp4oVtquGliyDBJd7xSWigrsirB8opML3gCqRirxL9_9XN2ENWRqm7gr7kPDOzw4XyRSloQCwz4t3PleaZtvs9OSOx-cA5EuKUvLvm4wNJSHIZrrAp7AcWIKLJCjD)

Adicionalmente verificamos la conexión a través de SSMS, en el cual deberemos ingresar las credenciales de acceso.

![](https://lh3.googleusercontent.com/H-HeE9ahGL_DnLHjxNM6b5hRtIwdUf0kOIa4zE4SNe87LHVBudIQWrh28TZ1JMb-mzwEMoQgyJJ-fOFPioRVE38BtK3CwitL8FPwzY4RdskYjTFPoqwc24JGqWdU7W_LQq_6_H7-)

En el panel izquierdo podemos observar toda la estructura de la instancia de SQL Server que acabamos de crear, así como las bases de datos asociadas.

![](https://lh4.googleusercontent.com/_-V6jqj3jcpcnF4v_cwiJCEuEX7dwGpKIn7l6AbfkUZrmMw0SyKzLkBCMMc6Mk3BjHMQYXs6SDX1a5qmiqjZ6d3d4zbEilBvtJnGbw37CWYouOBo1VLb6FZu4JZAga94Uq98KseE)

## Linux.

### Correo electrónico.

Se instaló y configuró un servidor de correo electrónico sobre el sistema operativo Debian 10.7.0. Este servidor cuenta con los servicios de correo a través de SMTP, SMTPS, IMAP, IMAPS, POP3 y POP3S. Además, se configuraron e instalaron los servicios de Amavis y Spamassassin para el procesamiento y manejo de spam.

  

#### SMTP, SMTPS

La instalación del servicio comienza con la instalación del paquete postfix.

![](https://lh3.googleusercontent.com/laeSFe0jTZStaoa_X2lXnkmI2edZ6buz1RI2KybbaQlRBYkODFm9HqLOtLPE5y_iZUZkjmbyVyxEDmKbyKOAjl2vlX8ouoyc7Zo-WsZtXpRLnqTeIIbPwzfoTOp1TCntCKvLCp8S)

Se comenzará a realizar la descarga e instalación del servicio. Una vez que comienza el proceso de configuración se mostrará una ventana de configuración del servicio en la cual se solicita el tipo de servicio a utilizar. En nuestro caso seleccionamos la opción Internet Site, la cual permite recibir y enviar correo electrónico a través de SMTP.

![](https://lh6.googleusercontent.com/SoombItAmydNbHDzOadkbnjnBP5GymnxgiWc42cQ7gl7qO3SSULG2mjr3yEZdYP3WQUGum8ZL_OadpE3HDL7nzlu0O4MY7QoD2DTK5rjtu5pVI710mrvdOE2iJB6xOftb_v-gYhx)

En el siguiente cuadro de configuración se deberá ingresar el nombre del servicio de mail a utilizar. Nosotros ingresamos mail.aafa.local.

![](https://lh6.googleusercontent.com/0zpJFxsBMtkTTdblQRtwOph3d5jRu0s9iMLdcH6r-ymv8JkAu8KdHAIU5g9aDMBzMAFLVQxS53BxnBYaP4coLTs0Cgrg0XweQ8hovwZv94IM4l0q_k-oXDJ2KJciM2NNH5DG9rzz)

Una vez realizada la configuración inicial, se deberá realizar una configuración general del servicio de correo.

Antes de realizar la configuración general, primero generamos un respaldo del archivo de configuración /etc/postfix/main.cf. Luego de realizar lo anterior, ahora sí comenzamos con la edición del archivo.

![](https://lh6.googleusercontent.com/Mp7CBPZhaWtT0InLDHqCyYBGNTBUIsG1y1-CXyq_md1FzkM3fQGvhoQ7YijyM5C26qlIk10kqWxGA1kCDsWarG3N70lKrhOGTyh_Z05MM0zU724Y06IiIjbC8WSTDj6M6hv3Wdec)

El archivo de configuración ya contiene información generada durante el proceso de instalación, en este caso debemos modificar sólo lo siguiente:

-   mydomain: El nombre de dominio.
    
-   myorigin: El nombre de dominio a utilizar en los mails enviados por cuentas locales.
    
-   home_mailbox: Directorio en el cual se guardarán los correos. En este caso se guardan en “~/Maildir”.
    
-   mynetworks: Redes locales o permitidas.
    
-   inet_protocols: Protocolos de internet soportados.
    

![](https://lh4.googleusercontent.com/sc8TJdfgZ9S4zFIQ0jjKN9zsPcN2cuWBa8k8eemMeRRgcbu6PHezx6l5GhoqIM_TwpUzHJRhQkmproJuGtnjmJ_fA4uu9oJigyXDqF-Bnsgnkg5bZIi8DdSwi4Y_9Aa1pKEiKaii)

Posteriormente debemos indicar la ruta en la cual se encuentran el certificado y llave SSL.

![](https://lh4.googleusercontent.com/kk46xemMT9qBOCnq436mIWwmvtxFGQXWt1-O24QZSC2DpkFHTomB9PRH-H7hwM-kov8sKevYHhm4Ld8muW_ET8mTRqQ3ws-cwf1k-NVcS0qUSPM6VneuIKR6NaXCGyZM0VOMYKJR)

Ahora se agregan las siguientes líneas para indicar el uso opcional de SSL, las versiones soportadas (> TLSv1) y el nivel de bitácora a emplear.

![](https://lh4.googleusercontent.com/Ldbg6Wz9Ioon0c23vyHp97fFUy7hVYVCbZh0p8vXjvVWFn-yyZ8O13zWtYoTgzCIc0_zXBhk6_n5VTEvUEySB95XpYJJzx_fXCyAtmYat2muiyKuJQYai4C4d_ZNfFnDcyBb6qsN)

Posteriormente se habilita SMTPS en el archivo de configuración /etc/postfix/master.cf.

![](https://lh3.googleusercontent.com/xxwWrSM5MS3IB9omtLmrIcuFuR6RhqNZ8H5JUHUvdmW9eudxHhC-DVdXqaGmYhdnlPlB_Nr2kSzm-o1r4tL2l1PafdzEdoTiDkIVsf5zk2mH-G04QuO4EqTm7ja346QKEFocKEdw)

![](https://lh5.googleusercontent.com/BnZUirGuHiWx4lBDBHrCrqXqdvU1OxBrJDHYH_qQyydnyGhkCSl99Gjm7kK8RPW9zUVTGLE5zcnGUZs37ENjzYvofW3OtLjqDB3sjmGf5v83PNku2no0hho-lUQlWt-LzHReXE6T)

Reiniciamos el servicio de Postfix.

![](https://lh3.googleusercontent.com/eEEG1VhmP8mQ58YVT3AYOqHd0v-83G3YNj3nx48KTHKG-OaTkiri-t3SKKY8y0SjDgzIt-Wz6uoiZaNeHKG5EwJa4ZtCPvh6r1UeFzKMBRAokFD9fedZmbASQdbp_7Uni8vWTeHq)

Ahora probamos el funcionamiento de SMTP a través del servicio de telnet. Lo que se hace es generar un correo de prueba con origen y destino aafa@mail.aafa.local.

![](https://lh3.googleusercontent.com/Qi-d203OzhJXOnU4uy3F4h3R-UmVjNoV8mUBx0ibUymkjgFKxPnbGv4VSDjZc4EV8pXKrU1iqxpbBd5THWJh7gkr4172Y55-arEgrZwFZLvmtY-I7LqA137Tn9NL_HDXChEukGY-)

Verificamos que el mensaje se encuentra en el directorio de correo del usuario.

![](https://lh5.googleusercontent.com/NQ0ezaun46QcNLgqDBBJZMsotW3v4qhDFHMyENU-_J7E6cIYpJD7Meupw1d2LIX55ePuX0t38ODxR5Dt_uCFdVBe8ztMI3TxbZEnHyDPkpVK1uG49x2ys0TLsCuTBjpm2V_vMk4I)

Ahora probamos SMTPS utilizando el cliente de Openssl.

![](https://lh6.googleusercontent.com/sBuC-dFnWkwq2_2wO7qX42Ng9UJS_7_qoXoGPObBycN9Zj5E_EQd-ynqNBGEUlay0DrhiTRl7izhHmvLo54casBCh1A2awo3N0Gvl7eQR9dvVEVcojzqddO-ef3rpoIn-u23lool)

![](https://lh6.googleusercontent.com/OIU-afyQ5EbpY2B2Yh-A8VKsvHB7Op5knYLlDO4k5iBOXw1sV32DHDMYXHYQNl1EY_kJ0gCJc1PfLdbVeqJ1P1tXPqwxS8K5D1MDbZ4mq0M60i3BBZT2S0iMDkj0u3GLDlBVimhy)

Volvemos a verificar que el correo se encuentra en el directorio correspondiente.

![](https://lh5.googleusercontent.com/V1ugi-gDVai3NsMpO9tMSgat6hiyynIHO4SXS9SBzEnSHTkXAcd2yFbF-oLvBGEyoCCHFmrTRG9sp-sf6CD9dr4KO10LUXuJZjVeC0DRfVD_P2FItuxD6Kff3rRAUVbNtlLDtTOc)

#### POP3, POP3S, IMAP, IMAPS

Lo siguiente consiste en instalar y configurar los servicios para la consulta de correo. Comenzamos instalando los paquetes correspondientes.

![](https://lh3.googleusercontent.com/BG4LVj86z3Pzl0qrc6hk2oi5sENjb2IR-2YeLryw-uJWn2NYsorpN75ILR0wXg05V4v5cvmxsd_X9nOl4Em6plChWiKWkMx5M4tf54_eGEhbCdeo3SEcfycqE5NT4lWDHEG_bLYS)

Posteriormente volvemos a editar el archivo de configuración de Postfix.

![](https://lh6.googleusercontent.com/FvnJs2wp8rqZuIy2teO3D9QouVHvhzjeiJ2Uz5XrZz38mtS8zNyTc3RHRs55lPNlmQQHshDX8F-bpDsOLPmfF_sPDgMx42YszC4R7sAEyEKjh2G3lxWAbZfMhfDidELtYYOZeMbg)

Agregamos las siguientes líneas para establecer el método de autenticación y reglas de recepción y filtrado de correo.

![](https://lh4.googleusercontent.com/U8C3jFSzewbMkuoGaDwgHxUFgeME32j7XeCgdDSBeI0uQw8mQbGogemUfzdRPlYXLZhfWu1_L09E2aLIBAc0xUqCywe6V3rthgAsaBts7-YPGF24UBtE95Xjqzum-VDhK5FJgDwo)

Ahora editamos el archivo /etc/dovecot/dovecot.conf.

![](https://lh5.googleusercontent.com/C-_lkMkRkE-TQcyz8prQct9cLnqNs_akobkVagNS4UaiSBIzHi_iuImwNePKqQaqDn7XIwSKmuwAjHK2uTfe387i6sKvJIuV9ufb7-2aAoBqjRPNtxwZoKanNTU9ZuvJtnEyKATv)

Indicamos que sólo utilizaremos el servicio a través de IPv4.

![](https://lh5.googleusercontent.com/JY3fITlPtGic0fDApQ1l7HIfMB2nFBHtH30cWllS54toIWBI5AhoNrK4nVaTMDJNux0t2n2efMW4TRH0tXcrD0dgipUyEebzYCvFB6puaSv5YTICrayl8ETF4xBw_gc6sIy62jJU)

Editamos el archivo /etc/dovecot/10-auth.conf

![](https://lh4.googleusercontent.com/VpVj0-fHB-edHTAwoXUIaobfrNgPkZQ9VBnKpy3kNku18D9DdOdlaqv3Lzd6j1Go2ycabGUNt5HJOm3Qo2qGEBBJsIsZqA1EgFkc8Xzc1CahyN47lnIqRnEJoTQKRaTQ5mFeCH9Z)

Permitimos la autenticación en texto plano.

![](https://lh3.googleusercontent.com/V0BksFqmJzaTJOYncdOQe4zzr8RhNa045rmRBn2rDRR6NTleCw3EIClLfluN9E0Zu1606PBlb3Xrc6_kTKJCe48OWa6DUNbVeqHxdR4rdYUQkZpz3Ydmfi5U8I_VpLCZ52v4qp0O)

Agregamos soporte para la autenticación de texto plano y mediante Login.

![](https://lh4.googleusercontent.com/CWOnP6pF4UDnAei-a0Jc6XluHGPeaLPJpHw8jqUIK02gBQUZmXvoMTXjkjxki0pl8H2uOPzAv2U-pSwa6ZDdttZikdj4-QBQpZYI3lrMPDN6iFAdcrxw4XplfpZFzuGVtLSP-2Hn)

Lo siguiente es editar el archivo /etc/dovecot/conf.d/10-mail.conf para indicar el mismo directorio de correo utilizando por cada usuario.

![](https://lh4.googleusercontent.com/Bbc_HODQz-N9qahy-LLTUkihtc9xYl_WblZ-KMMFT-7GOqpkGzsx--IKfkj-Ax0p_ybTnKEDkmlDjEej2y_Tt93Md0jEOLo_OYUSdb7tpq-i4py_8Lv5BDl9xy5DrrQKw2WHQPZh)

![](https://lh6.googleusercontent.com/2B7IReGfcrhyy1JeOc6FfzUkcWc-FatWeUU0aH8UuU20L97dqoKRYx4hdbAoZIW_3SXp-PwdyhtIKncI6cC0gfGm8lwfMyy4XCbZM1O8Fw1rXAzcjdLyYZpXYxazWh-bYgEDtkbJ)

Ahora se agrega el siguiente contenido en el archivo /etc/dovecot/conf.d/10-master.conf para indicar la autenticación SMTP de Postfix.

![](https://lh6.googleusercontent.com/NV0KRgj0uJulOU3-IcmWZPNi5N8qkfXznQtAuUu9BU0lyZmL4cQUHz8aiZj7SH_Rp4pWXrEAvPJcTyXYGvY9VZIdcdDL-qQA6QlmcLoca4iJZ0WYuFNaCo9yoNywNmnUGeTfbYtB)

![](https://lh3.googleusercontent.com/8yGwfpLuAHO2kHthcaQnNN1d9WWRMQwsNFs0LA5nMm4Dtk2dBRui0Yu7IbeNCRz8mEWwCltYyT7-XSPFakgxQMeW_SmSi1Pcit1cP7QWggthk3-0B4uTSIvoxnIUR0gGbWsuAaRz)

Finalmente modificamos el archivo /etc/dovecot/conf.d/10-ssl.conf  para indicar la ruta de los certificados SSL.

![](https://lh5.googleusercontent.com/lq5jWYDsdIH8c8z053q4s1KVnUb7OCoAa3HWaKSRBrOw0IcU2hU_NpSzM4IsbPnaABWZ3pVheHJmdw9wvbPh_u85W0zaxidjVBxMcG-icshEU1YV5fbIx2Gh7-9vOHmXTQ1ZWArK)

![](https://lh6.googleusercontent.com/dqP9D7vTGWEeTa31Y06eoq60hrsNxVch8eEqtfczm0DJH2x7OsHa8vgAPuvy9X62tRZNHmG9mefWwFgXYa_4XyHSPlRg5fVTkCCLseITruhadyx38wogh5itN4ilaIbfSIFgT9DW)

Reiniciamos los servicios de Postfix y Dovecot.

![](https://lh6.googleusercontent.com/Kr3zDL4t9Q8xMtQ5bnt81uR0kezI0fH65Hc7404IPIz68MUYUnYbLlDGmN1b-kmlyXttX0SPwAdMudDnbaYQMPM9oqXJnuEW2ZIw8yRysQjYnoe4QE9aAySmF_JkwBo4ntVNGxHV)

Podemos probar el funcionamiento del servicio IMAP a través de la consulta de la bandeja de entrada mediante Telnet.

![](https://lh3.googleusercontent.com/o_Fz6I212f7FolSa1JjKQWo02OH47KJMKR24s0shsb1vMrhungN3CPuru2LHRLUDKPWOvAdT1OLP2ZlI7IOdhSJkXLFFLNV81Z8IZXwpNu7UmUfPzHm3Mesq2uzavGns1LuCgfyN)

De la misma forma, consultamos la bandeja de mensajes a través IMAPS y telnet.

![](https://lh3.googleusercontent.com/VULn7sLfg6czAQeSM2rM_ymt2Xszrsf-Az6FNrkAvKBJGYadZ_PakLkJdtV4_7QqjrMCxzS14PGh7R6-UwW4SMyPlkCzr8byOZvsnAbrDLQxq1qNbHmnX28n_UQhzBogLwTQu2u5)

![](https://lh3.googleusercontent.com/YiQxRX1K4oWLuWA4RgJ_xsr5kW2cZnnzT8adk-jH1QUbhEkGbrhh243OSRQInbUD5pgu-yI8sLp13o-GrMd51NwMmxHfx8JWEAY5qp8U0LIjraCt653XgtE8MxCPma9y0DdQfD0P)

En este caso consultamos el funcionamiento de POP3.

![](https://lh3.googleusercontent.com/VM1CAV32Men-90bivdydk5rgi_koBbgs39vOIOHOF6m-7nmjjlHxZ43_bSlkVhIGYEG2U7mHeNTWLPXmtkKy0kzDKVhQ9KjhDoZwUKr49AWO71p1TT7v5YPNfLoH6Uz4PgN7S7C_)

Y finalmente corroboramos el funcionamiento de POP3S.

![](https://lh4.googleusercontent.com/bZqcpirOSn0vsS-u8kWrYflRX5MbgXfluli2Ev7Dypizs1S7t6Q5Qh6cT3llzP1EOjZ6wOnTdqVsZeKt_YTQCVwmG_z1zpJ7dqL18oDyy-GgVNKXSOUVX7D5az0e8azem_aMaomY)

![](https://lh4.googleusercontent.com/1okPo45ZOKcs-XsvFJz55V4ADUNrf6xCv3xDcQeZnCW9gtlhujormyIAXFvjOm_D11LND-64d3ealQQmiyKIJtz3so2HWv-bEC3GVwFIakeDiGvWAq-cdg-slhuw8g6AMR1FipSL)

#### Amavis y Spamassassin

Instalamos el paquete de amavisd-new para Amavis, el cual es una interfaz entre el MTA y los filtros de mail. Adicionalmente instalamos los paquetes spamassassin y spamc para el filtrado de spam.

![](https://lh5.googleusercontent.com/18khNNzy4Z8aYU91CGxVayGNPA4PSoB1nIaXziNd17K8hUw09V9LtlebZryROtNWUahLOF67WjgjT3TgclftbQk4eQjfmrOORUIcrmXae_fGxU6IsL4OCvPkFgp_7B4Zh-IEFG5i)

De forma opcional podemos instalar los siguientes paquetes para lograr una mejor inspección de archivos adjuntos.

![](https://lh5.googleusercontent.com/nwOXNXgWUCVjOLdrKbDBUkrNZE5Xi9TUDSHqUEW6Wsu_7WwmKUmieRlL35bW0hdKP332E4lNmxiGwHXSc3Q3bGXRc9_OfvbTt-JWaf_XTrG4hNhX-RMpF5w8JsMhWwVHrAqZDbZz)

Posteriormente integramos el filtrado de Amavis a Postfix a través del archivo de configuración /etc/postfix/main.cf.

![](https://lh5.googleusercontent.com/2U2ghsIHEcLunorrgxZjZrWVisxXnjw-P-Gjtnq2ORu5K9PpfBQQV0rFAlKKOtWqixV3TsEVjziFcn7zzV7O3lYWfi374jHP3YumbQkvyxtU95rePUrWaFboeY3O54A2ecDRxMDR)

![](https://lh6.googleusercontent.com/Dgj04-ZOPaY88qx8bceHv-y7QGdbYirpiuUa_av2MC6INIkJ7ICvi4-ZsfcjLiq8YBoVEmFuIZLtouMep_rjPpUM2CxKTjt71EMdzaKo0clJGS8POQeAaQ89REZrYPMgzjLrIpzg)

Luego agregamos las siguientes líneas al final del archivo de configuración /etc/postfix/master.cf para habilitar el servicio de Amavis en Postfix.

![](https://lh4.googleusercontent.com/GUfHe_HV6TVZFWDlYdsafBXk3zRmuiO2_aKAoP893GjiEvmCM7TLQLMYkca5HJXUjCuLby5QH2hE0E-w8UJrrcJA9mEW9oePh1-ac-ZX1H20EFhzkdnmNMIISEoe0t8q1fsGFqyg)

![](https://lh3.googleusercontent.com/ezK_2QaimDcfIpSsLUAaxqPFFyqqURcV5ETw3Hsx__WMK1Dfh8AGTmLcBeOPluwgwvdpKlWL7MuFY9JjUpcH_17Ty41RgVoY0sn_17TiLX5u2VNrIrjKv6aWKTtoXjYs0W6sMLTx)

Lo siguiente es agregar las siguientes líneas en el archivo /etc/default/spamassassin  para habilitar el inicio automático del sistema y la actualización de reglas.

![](https://lh6.googleusercontent.com/QYeMQEmXryvnjfsnDzLwNk1Amv-rFbaCjPDuKzgXvtQ6WhDiLThfWWzIzuoCb50MNcOF3uLqSn5P5Ab-rjESyXy9OZ8FKB7IxY29iO7bYyLfGAK9Izn8e4LzrJuIjIGyHo1U4K3Z)

![](https://lh5.googleusercontent.com/W2vVJGQbe_6sqC19fLrjpeQ9FLwjXTyRZI1JCkMf5KukEmugL8X21Z3MeJE0AOLfjZUwefpeiNTxWwpQfJmNVhI9aapCSpLE4zgRPSoqDqkgdE8GY7Tucwo4rnw0ybBuLpt2wdxn)

Luego deberemos activar el filtro de spam en Amavis a través del archivo /etc/amavis/conf.d/15-content_filter_mode. Debemos remover los comentarios de las siguientes líneas.

![](https://lh3.googleusercontent.com/HfPXAdXLk2gplQ0Oa0vwQJpy1Z-0FOFaKd5fYPdwg95EwMvCbxXJVrWgrJQIPE60bp6-5oYH75xIokIvnVpAujWLwAMmYdTv3TEAmyqHe2lu74te7NE5-oOQeRL1BliOHirFyOUh)

![](https://lh4.googleusercontent.com/0H1o-lBGQXFBkm0YVcaZe8oGeK0s4bdHd3ibKDmW8wzn9dtrkanXQfcC2S1tTJ-W9tJzIKNTUt7awKL1q9yonAhGIrWuyjkVq-4JFDQR9wBURX8WhPjIO30hT8BpSIJz_fEfqNTU)

Ahora agregamos el siguiente contenido al archivo /etc/amavis/conf.d/50-user para indicar el tag utilizado en los correos identificados como spam, el puntaje mínimo para agregar los headers de Spamassassin, el puntaje mínimo para considerar un correo como spam, así como los dominios a los cuales agregar los headers; en este caso se agregan en todos.

![](https://lh3.googleusercontent.com/x_Pz6z1ijyC4cC4p2G_87WfljmBAATj46KX70tCnnhRCKP6ho_5fRh0XgS1CEhuQDCnfFYWFcyHGmeq98JZ1Wi1n7JBcCmG9tzdDrOPChu4M9lhBE_2fcXLNVrny5c_TNZk7YYNs)

Posteriormente reiniciamos los servicios.

![](https://lh3.googleusercontent.com/hjWK62MDS2OOVBpJNci9-oyU8EWsEi9l5HGc4mJY2QHmCWfE7W1J2qFNMxLDHZlWtrnt-4sPilpxGsek9BfeafhlBk4qM4o9mpH9lbuF5JAVFrzl04AiUyQbk0KRAPxZijG7VLSz)

Finalmente podemos probar el funcionamiento de Amavis y Spamassassin.

![](https://lh3.googleusercontent.com/ZDaHxgQCKHtGuwCJ8Wk2JY12JmYWqvWFs5j9HzSNSTc7hfgK8ZJLAsn-OwMPQnjlw4Yq5hFfwYCkh_GBNinTki487Qz8dhDPOYARS5D4J11oKCYWpOf6L2xugHIs-Wm6eYVl6FFK)

Verificamos que el correo se encuentra en el directorio del usuario y que ha sido procesado por Spamassassin.

![](https://lh5.googleusercontent.com/hefFuGKiu14D-hBcZWHLdA6lh4DFnARS2Mt__AjPUqpu3L0BVCMaco7MVIobGwvFSZ0WJ5QJXU1-B4Dh5Jo-VJPejc1LUx_P66TknlWW5rEISgpNpD1bhb4bYaRALTfRHb6_WAVG)

Como se puede observar, el correo contiene las cabeceras generadas por Spamassassin y en las cuales se indica el puntaje obtenido, así como una bandera que indica si el correo se considera como spam o no.

### LDAP

Debemos instalar los paquetes necesarios para tener el servidor LDAP. Estos se instalan con la siguiente línea:

apt -y install slapd ldap-utils ldapscripts

Durante la instalación, se le solicitará que se configure la contraseña de administrador LDAP

![](https://lh6.googleusercontent.com/bDNCr9DZt0gOo7tY3rTN6lMsZjeIZHfYtXYK0wYV24cxLpSFelW4jBa0EuJOz9cLnAIxsd2bYDK1UK32aUkYf9JNEIdFZdmXcSyWvsSCnrrdg--BDsz7Rg7bi0anTqAglzv8ZoiI)

Ahora debemos configurar el demonio slapd para añadir los datos pertinentes a la base de datos de LDAP. Así que usamos

dpkg-reconfigure slapd

Cuando se ejecuta el comando, se pregunta si debe omitir la configuración del servidor OpenLDAP. Seleccionamos “No” para que se cree la configuración.

![](https://lh3.googleusercontent.com/fwMYIxQr8iiWvMZzgl-ozfMOKL1QJg9iRHXmn03wRdE8lA1KiE5EpPbTKmGhzSNY0gAn-6yYpRxSW5oNfKOU6ksInL3J29u0abIAZDoffZCfmBf-2Clq_PqIxdt2e1oxBoR7SoGU)

A continuación, configuramos el nombre de dominio completo del servidor OpenLDAP que se utilizará para crear el DN base.

![](https://lh4.googleusercontent.com/FpdwEDhsebTvAiabaTJTgX46P-aWf4HEO9-Uo83Uh6LUOsh86VS52D8_Bsa5LXb2NZ0G6Fr9v88DnDC2eazRB4SxQ59r0CgJ1H6lUxMbKQyjlXmfK1a3Z1jGgfPMKfXaPUGUxF6v)

Establecemos el nombre de la organización

![](https://lh6.googleusercontent.com/RFdpqVbb_d-QJS8932R0IVjPYRf_h1YSKfbiRLQigDDfzgq21zwLHv83-Cr78T9CWqVWLdsll8kHsm5Zkex0BWH4A2fl5tfMpsCv6jm1XeNRVw3qQi8WM3OZm3fqkF3mR0eP58g6)

Configuramos y verificamos el password de administrador

![](https://lh4.googleusercontent.com/PNljBKf2ZnHPa53ekRTdPp7-A5gSMIQXRm58ykdvHGxCGkJruDUE9xD0AjMpR8jgLs2kDzv5-FTej-_mlRpZwvsrkO4Zb_Z0m135jj4N32WEpIcnVCQXSW3qWNtx9FKHQDzKDiLo)

Seleccionamos el tipo de base de la base de datos OpenLDAP. MDB es el tipo recomendado

![](https://lh4.googleusercontent.com/fDT7SF3B7pYtH3JFrMQjYj_tltTi_5quOWRE3syxg5xyEcrQ-TbkWEeOmbFWURN_NO4Wu2_G6o9XVDaqghwmFwMY-uam90aW4mnGszPJB32xaaXExSIk-W4CQ12v4072CgYoMoFk)

Removemos alguna base existente

![](https://lh6.googleusercontent.com/tFqujjIGmJf09VHttmr7GwUCyTdmap8aT-glXveRwwJHQf3lgPL-o7z2RkTOVlHgu9OZjCofZPXHofeVeQfcZICY8giOjrb68s12wtJAZWvh4msTaXq6zYgVWdg1zMXyAzz81NrJ)

Aceptamos la opción para evitar problemas en la configuración

![](https://lh5.googleusercontent.com/P7x54NDTKclpi-2HNsVKhdXBLSgbaKUO2HJCtWXTaNSpvavFGvbB-aUo155RxOY-cf5RTp3VEBLvTG7HDmStAeXFdZ4Y5PAYGI0DeAsMHV7q9gu0MkWiQOlm_eRU2ANJjiEwowH6)

Ahora que tenemos el servidor ldap configurado, podemos verificar los datos con slapcat

![](https://lh5.googleusercontent.com/Rp89JKNo3vBGS4TQwAXVJwNnTaZejKjO8UJVduhv3G9D5DVXT6IYsTpdsLAk5uG3GAdBMGLpxQ1DbtIghEs15qLmBPCNrZH_Y3PaSoPw0O8t1z2TiNhN3rP8-E5thnU48YxhKsC8)

En este punto ya se tiene un servidor LDAP funcional.

### LDAPS.

Para configurar el servidor OpenLDAP con certificado SSL / TLS, necesita un certificado CA, un certificado de servidor y un archivo de clave de certificado de servidor. Creamos directorios para almacenar dichos certificados.

mkdir -p /etc/ssl/openldap/{private,certs,newcerts}

Una vez creados los directorios anteriores, editamos el archivo de configuración /usr/lib/ssl/openssl.cnf y configuramos el directorio para almacenar certificados y claves SSL / TLS en la sección [CA default].

![](https://lh4.googleusercontent.com/7JAI8Vc3oGcN_KPiybxyWTAQoIxZKOVSyFvhGHL9DM2Fa52IXm3XZciI5ojXoW4qQRtEmsLWdZRZR6eFlytl0aTEu03YEWQWVLI6YT5ilE0U0Wmho4JNt2NWFghPbH8MMscilTXl)

Podemos notar en este archivo que se especifican rutas donde se guardará el index de la base de datos de los certificados así como otro archivo para el serial. Debemos crear esos archivos

echo ”1001” > /etc/ssl/openldap/serial

touch /etc/ssl/openldap/index.txt

Una vez tenemos los archivos y certificados necesarios para LDAPS, procederemos a crear un archivo .ldif donde indicaremos la ruta de estos. Este archivo lo llamaremos ldap-tls.ldif

  

![](https://lh5.googleusercontent.com/QD4DINu1AG4UYRMhKeLaeE3IHyDX1a_-4XD_bKfq8CeQu9Kcg-QIaYFeIeC4rfcFDBOdLpcRxdLMebflV9cRk4hiNjTtv1syF7ku6am6MpX6A_4JO7Ts75LomABGI69TdSSNmrNq)

Y añadimos esto a LDAP

ldapmodify -Y EXTERNAL -H ldapi:/// -f ldap-tls.ldif

Por último editamos el archivo de configuración /etc/ldap/ldap.conf para cambiar la ubicación del certificado CA y añadir una línea que permite este tipo de comunicación

![](https://lh3.googleusercontent.com/R75V6zNuUOcpSeJoPFmFw4pv6WLd0hIRM5bl34c-by-4xv0sbUz6GBMxunEwagjvJ8KMD5eKhAI80pTVpwtuKGoDJh9Bz-2BxOhTDX0JT04AoSSnOuwo2CckVb5DfbNlGUgnbitb)

Reiniciamos el servicio y el servidor LDAPS ya está listo

systemctl restart slapd

#### Habilitar logs

Para habilitar los logs del servidor ldap, debemos crear un archivo .ldif (al cual nosotros llamamos “logs.ldif”)con el siguiente contenido, el cual habilitará un nivel de logeo de estadísticas de conexiones / operaciones / resultados

![](https://lh4.googleusercontent.com/2owsuiX1JpI9K8W8zBP0kKcP23Ug27QIUIoiuEGUl2Q0WXAoBCsxcpCTKdNCpKo9JfAE0QXIfIX-GbdODLHaxkAZjiPewncnSBuN53is22AnH990CdysmJ9YldvgPSo0QnBOu1pw)

Posteriormente lo añadiremos a ldap con el siguiente comando y reiniciamos el servicio

ldapmodify -Y EXTERNAL -H ldapi:/// -f logs.ldif

Ahora los logs de ldap están siendo creados y mandados a /var/log/syslog

![](https://lh4.googleusercontent.com/RCdktaTanai8JrFmwngPnLy9h8FJUL1VmdnHuVg7w4exLVs0eBeZzJ8-uyQeN37bd7nhf9x_eSwu3M-D5YtJ2WEWOD0n_Jvz7XlxRn5AHP2WHChFRK2Kt4JR5GdjAsJc2H2U7F5W)

Para finalizar, deshabilitamos la autenticación anónima por medio de otro archivo .ldif que deberá tener el siguiente contenido

![](https://lh4.googleusercontent.com/tc6SpftQgkcPK6GNpLxz5GcKvGXYIMndWHPv4Ilj_Kjmb_QSNaizoyFgNxULzAPYDubtUBJLIogL5jtFHcajLqC6vZWPjV1JSsSQ9tBKeA3eYFpiOEJ_4fwdv4905UstDi-O3C-C)

Lo cargamos a ldap con el comando usado para cargar el archivo logs.ldif,solo que hay que adaptar el nombre del archivo que se carga.

  

### Apache HTTPD (HTTP, HTTPS).

Servidor Web (Apache NGINX)

Creación de usuarios para los servidores

![](https://lh4.googleusercontent.com/4gOcesvwv08m_myjAblXfvfSKB07uLqMblE6CYMWbr0_zn-DE2TvFkszxfJvi2L3trkweWmgOgYV3HN0fQoINIDhpyCmlnVgwwxu4EEf6UlZG1DOMReKyuCWN3B5RlP16g3UEpA0)

Le damos permisos a este usuario para la instalación de los servicios.

![](https://lh5.googleusercontent.com/BX7IIBbpRnt3dLFw34B-kMMz9YZsCQbfGf7StKrs9zHm8trT-4LLdFO2h-K8lsynCRA97RkykaS75AgaiyoupBsb9y5lX-0vu8le9gDbmJzMWDu2BNgm01YZWPfvDPdOwzQBAbpP)

Configuramos la IP estática

![](https://lh4.googleusercontent.com/EK7G8SZ5Z8FTbSrfAhYr0FDbKxOo3UVhXKIHldShH1zomcnU8PSM_Vtgcw_sj2bykqAVWDDDMGsZY4XRuCR_qcGZeM0j2I2puotWsMzdx5ZbLWbH1FQsclOHC-0KxteVJ3mXIKGw)

Reiniciamos la máquina y revisamos que la información de red sea la que se agregó al archivo.

![](https://lh4.googleusercontent.com/F-V0oEsObJnhTLm5gsTAIW8C-LtH5Ov-3Wg12PZR_fa3oILiJiMbRcogmI5csv7D1P-cxYOIJDiMe2_B0PGv7_SBcmhRfeA6P2k6m6ESggm3o5FoVAWtTyTfuFvsFkkvcDHhSU4o)

Se ejecuta el comando sudo apt-get update

![](https://lh3.googleusercontent.com/fhc-v0z6J0Km5-c_vrWrqrzfqJZqRte2ZbEcHU26lEi-FYFMwXh9YgpHlUu5DAf3yahQhKlCCbCZ79B2Sd7OB-vBzlfZSI82Do8Wzzk3ww80yq21rJLeW2CBLYpA87BqLDiccfJp)

Se ejecuta el comando para la instalación de los paquetes para ssh tanto servidor como cliente.

![](https://lh4.googleusercontent.com/aZFj67GtwGxxs5MDSCmd49nqiHWF6H7evA0KOcmKJirUWZhFJk_T2c4wRZjbX5QHBsHMWQdfciMw6CgksoxPnwy7-t8HClcf8HRzHDKGFQiUiIedajbe63dmveE51kDcANdu54Pj)

Verificamos que el puerto 22 está en escucha.

![](https://lh6.googleusercontent.com/R2JpeT-isTm-_jxug2uUtTZvuiRJJhywEYiVBTVBJLjbh3NkJ4PsSV5BPFVt9sUBpMKUvmQrIgsZozowkOSaXsHSvjmi8MVF9izUzBQLPnA30gyzusGwZTNQJO044Psp2rqBdHX7)

Ejecutamos el comando sudo apt-get install apache2 para la instalación del servicio.

![](https://lh3.googleusercontent.com/YYECsARQgjbEl4SLOTkGYKgtqjN-EBQvBoHiUARBnHcQpEh3VS_1iJNtZ2wGZt33j9g79UW7yivlIM7iu2Efd65Ni8X3tBUQbFfDtimHuYPrr6NlLCpqrC0-A6nrCBXY2JOhCgvA)

Revisamos el estado del servicio, para corroborar que este se está ejecutando de manera correcta.

![](https://lh6.googleusercontent.com/yrrvU63s3EEWjHt5Ra69cpsqagSPnBj3YZ1tnYARelHemIiN2vgMGavGUF4SPFTZwRJ3puRMh3xiZI6Ci5wm1RN0w-e02FkJMLzEjSSLxQQ5FKUfx4gKCjFEcUYyZU9BH4SxfrNZ)

Habilitamos el inicio automático de apache..

![](https://lh6.googleusercontent.com/qHamtGA2nYS0oxoQoKFQXCu0DTsKO6U_Od3Plw5cyV5FLdChidX7OE0dOT-t3FGjw6xuSHXQg9cJhVmyS10d0UBf1j06J5B-5l1YJ3PUD-vnZLD5kAVJo5eyy1-X8DO7tlYJgx1m)

Abrimos el navegador en un cliente y revisamos que responda el servicio.

![](https://lh5.googleusercontent.com/nxTD2FP2uf9_bFg_K0wRwPHwlGXbYiUWHE-E9rg6U4r9bidHzkZztyeTU13m46yZqpeC2RX6VOkN4SS3mvcI5t5iCCtDNsOVG8fUrlO32uKcG83O9ZTMntoExaaP7hQXBXi8pigj)

Descargamos los certificados Wildcard. Posteriormente se pasan a la máquina, en este caso se hace uso de scp.

![](https://lh4.googleusercontent.com/FrVrWty8M5Ga58hXr_zBkCmuMQ29QqYeN8VktIs4qM4QlxV9PPBk7X15GrxfwjccSgAr2KIYwtLmUTYcg4CeHM9Kk77M8oan05kvP1BPq5UxMYpY--U1G6lkUwlulWQ5YAOtj5zG)

Comprobamos que el archivo está en el servidor web.

![](https://lh6.googleusercontent.com/aq0GMxIhdhuvo3b60uBFrw_eAfNBbVzYVVkI5U_MH8rhiRiC7P7limjRMKhjxCCcpa6Q7pmuvCPwMQGakzw2fZz5SHR58Plih-fvapfWYzPAyCnmGzOdWDGOBbPLXPlkPZfzcj6w)

Descomprimimos el archivo y revisamos que se ha creado la nueva carpeta

![](https://lh3.googleusercontent.com/cEDlhsXWqskdeC39O-DmoH8F7rFGAkLLKMXUYxIXZZipP-keMh9MsBPecsuVfKHwvW08uxdVf5omUOzn5Y5w5FbSsTST3KTZnhI-68BbAU-jlX7Rf75lV6ClDZ856j0LCMJJP8DF)

Copiamos los archivos a sus carpetas respectivas.

![](https://lh5.googleusercontent.com/CeS7lDhLunQYSMzawfLseCp7L3HTtzlEJ3Eq_pupZVbYl491cDb-iSCoDsC2lebtM0GIjQqnMlDbfR6PBiOdVPSWx95F4KzS52Wck2JX4dvyQ9EufFXBGrPhGoxtf2_GBCgwi2NW)

Editamos el archivo de configuración del sitio, el cual se encuentra en la ruta /etc/apache2/sites-available/default-ssl.conf

![](https://lh5.googleusercontent.com/QsnH0Dr7aDkzaC7uY87tAiW4cMiqTgdQWRbgK56PK3xVnRRM8v5ur0ubnZDeoZljg7_XSFJ315u4JR1iQKo_ceaeKJzbi9c8Q1HmP5Qg3OF0iEFdJ4ZYuUUyt_1kdFtjbPIYLx36)

Creamos la carpeta correspondiente y agregamos un archivo index.html, a éste le hacemos un cambio para notar la diferencia entre ambas páginas

![](https://lh6.googleusercontent.com/LK13cJ4arBpUgshVSmkUAvITC0kbDc8036FAOdyEFZgGHuASbBtV3bJQGT5TlmEipDM2fFGktrhIjC0L8BDjev5BUExvWaME_25pU2IcOaURxOHPw3f0_4rNKwmk8yWJWdBz8rS-)

![](https://lh4.googleusercontent.com/JimQxWZGLaPPF8DSDvSlEC1_T23eST6XGsd3ASK1_Jx8DGANZWxkEsFNqMygAMfsbSCYCWmsFZx9QEVocNswMdlBbnm7ugukz2BCqw0F2Kg9ND8GKjsY4OXITts-ud5kcjk-atxo)

Habilitamos el módulo correspondiente.

![](https://lh6.googleusercontent.com/hUzBziXya-tClzi7ADaoEoW6XpDDE2B2I44laTaVRwMguh0lwSUn7pqG5aQxD_UK720VlI3We4B5XLKViHmml8BBAIc6EVdsENYsySkSKvxRP1bxMk9XCMTkGW52SPeDTnfXftU5)

Habilitamos el sitio web

![](https://lh6.googleusercontent.com/aoUK_FmntnISzdZeDcP3axWaDoabKw5yNEn76oBg3ElB7URBBOdavz85vX4OLm_ZKg6BdwrvXhWF8Q8XHzrUhJ-WQhRGB1DLNSE3jgTzFCbYn96kZIrY8-eb0IjtcvKR0wXXOYzS)

Reiniciamos y revisamos el estatus del servicio

![](https://lh5.googleusercontent.com/1R2lbyZR1G7RyKgLsSZV4iYZbiquhLnQeVz0T2wL-1oSQpnzBqSDX9Mp1-1F5FW7sP5nT06PXsvv8srqGHXvzQHsA8IW8xBN8W-wH8Kz2LdbE2qoElzsTcEwu2ujdjvEbFN2nhaA)

Ahora en el navegador visitamos la página, con el fin de revisar si esta responde con https.

![](https://lh4.googleusercontent.com/regWV7kdnah5QUGQSByi8R0MoiIS5fbJWeFbPRbo00Xbqp0RhdJ_9YnzPGF3kslxHWlzTgIbpSwC4Of5paDK1kOYYV3AJSiqxCSCH0U61vzQFbEvyVtf_ZL2ei2kp6ukwfnN7qAi)

Damos click en Configuracion avanzada y, posteriormente, a Continuar a 10.10.10.9

![](https://lh5.googleusercontent.com/KbWyMt48ZsOIEeHuMkVVSnqenDej_UPi0xRDeTRUG4_k4XqJixWYhZjqUoJ7ZwAFHgx0jFsD5UpJg0NXojTiNU84MMjHRcG24ptxsfwNYpTaQZa7sJKSTppHLa0pwciBFKGUv1EY)

![](https://lh3.googleusercontent.com/bH7oqqcxPam8MVLPBlGjGEvbBn_LeiwV6VBoevrkHdNCTegpb_fcW8FzsLARsKy7Al0NHqWKem0ERzTq90OzraurEOPuDuY20Pt36lfhpUZzagsvfmAn2E2W1WNi1TQxfC523dI9)

Configuración de nombres de dominio, para este caso, editamos los archivos de configuración, donde la Directiva ServerName es editada por el dominio al que responderá la página.

![](https://lh4.googleusercontent.com/JaUz5-T1wdNfwjl6hjoImQnIxRbfRCWbBeNyzUqgcGD41M64ivfCCHM5u6IUlxHwcaw2oyb1XUTOIb95f__HxrFegIxF4DG5NZl1TEWIsEhNyiESzwHFzpQyq-_qj4L1VRJkL6H3)

![](https://lh4.googleusercontent.com/qSUSSe6PRqCTpqhV7BE3D213Te0n_VVZXhsLQoF1pvHpQHDYKtOVEE4OfKXUBzrf0lcXSquZDz-9XZdv6zG9ytkkW040VZ8zmPVH4EBDFoaFLhVzYZaj9Da3nh-VNjvupeLqSa3p)

Deshabilitamos y habilitamos ambas páginas, además reiniciamos el servicio de apache.

![](https://lh6.googleusercontent.com/9AiSNkWHlV72qwJUyHlKw4oV5Vt-Gdgon0mOkTuvMzLqI1Ywlu-0SSH1jD8Q5r3NRiKaY2QjBTTqyLhwMYZk091nMFEvK8VJvAdg3foSD9v_1CKcmrLXsOfqePB-5IUDFW_6oaHn)

Ahora se pueden visitar ambos dominios

![](https://lh4.googleusercontent.com/_j4GXv_jUYD1JigLWSak4eFdVQKg_Wpc5Hjdix1DAB4RFBpUYH5I_lTR6CHd-m8-a36tAtFswHaR8ULDUxZ_beWPoW-p3foiw21r3aGJaxJ4Kh6Mjq728vfQArxw3CQYk7ydMbZ1)

![](https://lh3.googleusercontent.com/GPta6VXTeBTgQg_YMKQYIVn8iyyok5a_hSJbFj_T0tYQ8QI4dTRd-ljoWm2D3rrxFOUU5HgvIjcKCVTvkow5KBo_TlgeAj3RCU9ayZ1AXPcSfb4rEN60gVle5dL4TWWOiepFKHeF)

Para que nginx funcione cambiamos los puertos de apache, para esto editamos el archivo de los virtual host, de manera que http responde por el puerto 8080

![](https://lh6.googleusercontent.com/DAK5TDNc2fwLUjKY7-0Wd7QbE-b-5OEZWjHWfkgE4O-_0YwUaiIJSOd9ia2OzxzWcaN6x5wYUNIFpHVZJUCMvQJXqMxnrxywfzHQt15BHU-ODRXr6reQ8BzHkX2Hmllb6b5oKG9R)

Mientras que https responde por 4433

![](https://lh5.googleusercontent.com/fVQYeP7pdQUlwZKV0vWECfpsB7p72pWh6Xg7S3sZ-f-XzZnjio630RKH0KXTq2eOCaFD0b0OGn6k1SjjjfP9NO_h2bN8Qk70Xu-sT0I4floSAcZ-xkmMiBZwjy5V2cGNONKcTKtm)

También editamos el archivo /etc/apache2/port.conf, donde se especifica que está en escucha por el puerto 8080 y si el modulo ssl esta activo, por el 4433.

![](https://lh3.googleusercontent.com/YGFXymT1zrniniWBGGfD1uzFBplApnjaxdQ09N5Az6WKiSOgEeHC-i0yWMV_DEldtlPc3RetnnvAUfFgfC9o-J09-Dw5sfcpr6KQOYFhgMW5x6fdxo73jA3VofyRVCzIlnZ5r7Bg)

Finalmente se hace la petición a la página, especificando el puerto.

![](https://lh5.googleusercontent.com/sbAhnWBE9BXgaWpsM2uKVhv973ir1MBQyleiiDjq1hf1I862NPzLM6qVnB07fvrdNPGBxvK9VKg-m97rEueyArJllWJltfiPNte6gAN8HXVpef343CDnQwg1gAEcDlpG90ITZVJ6)

![](https://lh4.googleusercontent.com/gC8gawAro2hS_MM8LiwvuxXtLh1YD3AsGZyqio123TYzCWL_n-osQNbak7hoU3McVkynqWqpYUh5aIO9pGPsdPj_Fm91KXWw6N8dgdVHdO-_kb0UoLtB8JwSG9YCPpHpMZo9CKHt)

### NginX (HTTP, HTTPS).

Instalación de NGINX

Ejecutamos el comando sudo apt-get install nginx

![](https://lh6.googleusercontent.com/NyjnrOonj5dvCK6Lus-My6yhmjbCQvVoOdZSucCQ63HfsteIYK0stu0xLKN_6xsoZIRu13Ew_RfNhuT_vQ_BcE3md3mRjYbEkXay8ZLCYHuYFZYH5y0KNjy-tG8KAMDjJNYCtsof)

Se procede a la configuración de los bloques del servidor, similares a los virtual hosts de apache. Para esto, inicialmente se crea una carpeta en /var/www dedicada a nginx.

![](https://lh5.googleusercontent.com/vP0lI1Ur8icMYmqsHfoXc4b-g3ykbkR8l77VulfOPICS9bnS3VsqBm8M8IioRLnAln7vPUUcfNehH2fWP0DDPfVN7-XKcrlPy0O_z2eNt-KPwnveuNh8ezI9Uf1LubNNT6VHYx3h)

Copiamos el archivo index.html que se tiene para la página en http.

![](https://lh5.googleusercontent.com/LFOPOI2huphIO0jfw6K4m28kAJwjwo0_-8wLQYVInW39OPF7Hd9qzu0yauctOCQ8thleLaq10LxcUoXmV1OMz-lxRlmX9Uv8tZfZh6IPIvXSJHARrlEJuvOZ7Vu85i8OgrQqsUAu)

Modificamos este archivo para diferenciarlo de la página http.

![](https://lh4.googleusercontent.com/-M_ATQFFo75XjIOnGyGfNa0ztu-r-FrNilNGtHL1Q0E5H-YWhFu5rUN8km7eSTxPbPEuzHj1Jn1tDIRXaD9lxcyztwR7lxgnVWUfV8sFQJzh4gr0FGeahMe19Dm34vZDodNta64o)

Creamos el archivo html para http

![](https://lh5.googleusercontent.com/vWfBzuvCZ3WvfpIcKbMTIreWI6itbYedRwXIsMRxkwWPjpt8W_M13fbq6cIpa6H8Qtuu8xZVdVdRr5t35VJAOY2kGTGzk-McJg5yv_TEhqYaJnp814g2k1KAokedUp5g2PLFgdR8)

Creamos el archivo para la configuración del sitio web.

![](https://lh3.googleusercontent.com/m7xqPCgu0D7IPGJOWZgX_-14QRJD3bZe8FxoJrRnzTZK0VaiTcwMiRt79KzwO_rKhY1TGun-Ekn3GltY8_oZWPSJdAghPtEAKLYd9S7Us3q4103VRpbQu0KpHt2YCzLaTu6g3HfR)

Habilitamos el sitio web creando un link simbólico al archivo de configuración del sitio.

![](https://lh4.googleusercontent.com/efta4fof0bqHuImQVG6DohYOSK6B5yKBnIxCFF02uAfE-8w3kfPPC0Y_pD17dbb7fKEkaFcurIHxwlFAvIqBZIXkJDMH2tn8hfR1D-LMwepXGZBV_QI-7tBpIKUJHzdcFQCD-tcc)

Para evitar problemas posteriores se descomenta la línea server_names_hash_bucket_size en el archivo de configuración de nginx.conf

![](https://lh6.googleusercontent.com/ptql5pHnjOHYP5GadntOQgs-ycGMaf7trzrH6hZU4cE2zrW7SgBKowvaP-bIk17qaDErZ4UGzP6AICHTXIW4gPy3-sncIpWuqr0WgC8K8vf4731gQK0PY1eb0ZFG9M7WyTrCeSbf)

Comprobamos que no existen errores en los archivos de configuración

![](https://lh3.googleusercontent.com/D6qhZHFD8ZjLjetr6VfyhkfUB0zox1FD8pt5Qdt2XyVF9qiLpvcxtaLZWQazcp_WacTRPj9Eol0cfA8Y9xc7tPYXubjNTZWgaefTVNDjam2Aec5tbUXR49wj8VmFA-a9-48VeYkE)

Creamos un archivo que apunte a los certificados obtenidos para la página https de apache2 pues estos son wildcard.

![](https://lh4.googleusercontent.com/_PEXh3V_jRcIcokn0i2YwxjdCcNeC5SsfKexnqdrN7uGszFapCwNfPNfXa4uGGC3rXmGpHHoB0TEZoAmAdGVh7TH3jJndgyg7foGRcS8Q4eSW8fFPVpA93vo5-S3e1WOoR3T7ZNQ)

Creamos un archivo que define la configuración de SSL.

![](https://lh6.googleusercontent.com/Ro9RXz5_cfW8O6G4itxEUWYQdBiuof_uyA5AuoKqvAPwro0gVrMWUbsQT2c6peounfeu__W-r0a36KFfT4DaX8uuASrDUSe6uOyfUl9jraOVHjQuI1-_RSSkuUTCs7Qx5Vd-3Qvw)

Creamos un archivo de configuración del sitio web, para esto se copia el archivo de configuración que se tiene por default y se modifica.

![](https://lh4.googleusercontent.com/4s8s6FuQVkgEqgh60XZZjMV52ZFh_ClNQSessSqHopM0tSDEdhfzb_3Y876XySHt9afE0MCoe6KQQj4QXhDRuYQnrDv_i4tmk8zW3Vd19f0BLX6Eh5OM9VYujcmSt_fOY1e0Jp3g)

Creamos el link simbólico de la página para los sitios habilitados.

![](https://lh4.googleusercontent.com/pzyzqh5Cw6FMsz8ZKm-pvh0Ytm-oo4WqEhnDb4IMa2bjCBuBOOYnnY8aXBWOk4sdZ6prASXfMzcaVN6hn_HP5m8PCDnoW_2UgXBdphR23FXpirx3Sx30C4eGMr4ROYSv77goi2CY)

Revisamos que toda la configuración de nginx sea correcta

![](https://lh3.googleusercontent.com/ytnrObl5bijD5ECmDYagvxQuqJmw6k3EDkyS51NDpkE0FtauMPy_mptPeEZcuZgs1f3XXT02R-eYelKuxBJTYD7ZEUxAwnX86Ldz2zJimy2qs0uFJDaNNKVSn9i6AXt_i_BxpHoK)

Reiniciamos el servicio nginx y revisamos el estatus de este.

![](https://lh6.googleusercontent.com/gRAO6cvsa71w0cUklWJKfs6YinpAguhD1KRX3fBbIgo1z9InN7uyH5s77M4T6rWe3gpFVhFeDB6DrX4zpCFyUs1Wtklejtf6wxb3wDNJfU_ynwAnUDjQhdJXxGCdoNQQYtETArCT)

Ahora abrimos el navegador para visitar la página, donde se da click en configuración avanzada.

![](https://lh3.googleusercontent.com/nRog0A93_VYzUCgT_ZjwQrtVdO_CGd4VjAEtk2QoCnWDWHQOtsg5zQZu0uDzKx1apQppjolELhboO8gAN0h-qddDav87ChQAVSrhzWL5353BOFWdYpNbsuMP-tZnIW1JCeEc1LEZ)

Donde se da click en continuar a 10.10.10.9

![](https://lh3.googleusercontent.com/CojCmPMpo8ZkcbwrMXr8jWLQLe-Iwuq5IwgQMZs4d5GEUBJo_Oh3YpUaaYW8YokUdEFPavZi1aUzSQ-dgdmgYBHfAcpNlCHDNJHrUtxtGURYGRNgbSemS4klyNSIKlEf1DfCsA7Z)

![](https://lh3.googleusercontent.com/7RAEkHXeVkPzJvk21yK57rQzCnxLL24BqjT0qgBxukXZo3z1BxyR6Zt_u-qMvuNEV3ePVT2XALme1c7z01KDyJeRy5_5vLhnFfkIAWGoIVQ4dvgdcq8Vv14mNW-Nj_aFHqm2qIS3)

### SSH

Debemos ingresar el comando

sudo apt install openssh-server -y

![](https://lh5.googleusercontent.com/OYTz6h2vnZ0-UVoJ0CkKV2cuzSB562WTnLhqzlKxMJ-QdNNJKUJfzeX6xK_6GtF3ZG1e8xnN1Xamx62G7yhg_17bxX9y7uQ3_LI3kimoe2EIQqTLOgsFxMTbz-wwCsAxfuBdGrxe)

Notemos que el servicio ahora está instalado y funcionando

systemctl status sshd

![](https://lh3.googleusercontent.com/F5wiXn1wAoXOjHdLs5SLdLTKk8b0vWBy-SZcC_xNwcfK06DryT3Sc_PfXK0ORs6xTIkWJ14iUmoSgM776VUV0PnefPCwkt8FoeJDnNR6owiUrZYvNjT1qtJVKVQC9xCEU59LrCfA)

En este punto ya tenemos el servicio funcional,pero para generar los logs necesarios que necesita el proyecto, debemos hacer un pequeño ajuste al archivo de configuración /etc/ssh/sshd_config.

En la sección de Logging, descomentamos la linea SyslogFacility AUTH y comentamos SyslogFacility AUTHPRIV. También debemos cambiar el LogLevel a VERBOSE

![](https://lh6.googleusercontent.com/PuCsDKsg-SzQwWngeME5Tz8Gh3WFCXno3asr6qMdzu2zBNiq9oNxHm6v4_hHD_VEeYtrvoEQru5K9tXg_7wzlEHtztPrvLEgwkH0b339S3NXZhvaMkVPHbLIYly0uMDdvytwTsNt)

Ahora los logs estarán llegando a /var/log/messages

  

### Firewall (Netfilter, fail2ban).

Creamos el usuario para la administración del firewall

![](https://lh3.googleusercontent.com/Wwces-cMaXNcQCBnhOkKgsJIvd_d0VxSyQKCd4bZqbkrEdi-V7yEBh4LMQELXRovWbjX_04QqO5mL8D3ZYroM_jq16KDFGz3UTgERA-M629GTGuBOdt6ocgytl7n9Y5cE_GziH90)

  
  
  
  
  
  

Le damos permisos al usuario firewalladmin

![](https://lh6.googleusercontent.com/KDk86U5Jdf3o08IxWNheh1_PRgp7_5AbZxC_nLM3P1Lrk2VwVmvJRhFvJlOyvZZOd-Gj4oqsC4WpDfdSf_BEC4uSUC4ml-ypRTnfo_vuXtqb2MXz2uvjCT6xYYoea8FOrGyvRMEJ)

Cambiamos al usuario creado.

![](https://lh5.googleusercontent.com/AP-xu-pI0YhE6jMY1Lf4sim73zPXksX83-zNZIZ3V4tgQAMEwHkq2_GpGYTmG7EBJueN1xwgSMJAFBIcWtAORHohmc-oMSDRyl4r8wn8JbMKRDLYo3WjU5ncG60OiR-xfBu1JlkZ)

Instalación de SSH, ejecutamos el comando para la instalación de SSH server y cliente.

![](https://lh4.googleusercontent.com/v83TGE7przKXFPZ96uV5HtdXgPywI9W4BUj8lr926zH_7z5reThZEz-tEraUgP29EMe1411oIPogE3Rr6x3HnHUMtJs0HJKYmaEHB9n50jPaTUNX8tEeZeGtHUaLxU7eczxWwq_X)

Configuramos la IP estática.

![](https://lh3.googleusercontent.com/YzoASXxNETXFcCuf1o5e4So8QV7NHH5umLgjEcCdExjv8YN8fbTjUh7oZdZRJu7q7DCzrSV1bmY0aX5pZtuZMtc03f9yZwKcRguV-cP4GdM7pmcRTSzzhIGvNhIMw1_PQWCqO3hH)

Instalamos fail2ban

![](https://lh3.googleusercontent.com/h8WaTl5x9cj8NTglSQCH0m0hrv2dKHgC7sgtfazeMUSz5cPb1E-u2N06NmbNCcj4mhHDhBWyKSvIjMLHbJI6KdWDit5KpEM-nv4iHFqL5sMDu9ar2bduvyGQMwaKPKzax_jqPjcx)

  

Iniciamos el servicio y revisamos el estatus de este.

![](https://lh6.googleusercontent.com/AIO6cOpHYW1BUlf1Oaquyssp5-hjB77eUUn4B2-sbEfkHfzn9ucnKtj1jb2RVZlagXMNmNTpfH7MH6g1FbrGU6LK0uKEFB4t6QLrlouV27mHrDI4towpxJvE5kJMzrp7sAe_hKia)

Habilitamos el servicio para iniciarse sin intervención humana después de un reinicio del equipo.

![](https://lh3.googleusercontent.com/TxhrsQIhUHJQnFGidJzkIRHKJ49Xp-htKHeExTrR8jkGRMT0nhCQqGKTVLfugxNx3yEBAIcXJSxNLLr6wXU_07jYa_neSS43blEhCTyTqxXuwSUSEBaxqjqO0JFTs2B0hJlrtEca)

Para la configuración de fail2ban el archivo jail.conf en la ruta de /etc/fail2ban, el cual contiene la configuración predeterminada. Para evitar problemas posteriores copiamos el contenido del archivo jail.conf a jail.local

![](https://lh4.googleusercontent.com/e92TB9TMkxuvCrGP5gjsUCmasjypqLM9T99pAR6IUefJUMCjnFl3cLpN4RzfehU9pdZS5QFPhPG53vTwhnf9BVm6MT677W0JqNH2KQDzmuQYH6S0N4BesiMRxB7Cxcd59A6Hm6WH)

En este archivo podemos definir los servicios que serán protegidos por fail2ban, en este caso se define ssh.

![](https://lh3.googleusercontent.com/kWzj81Je31-m_hWecEot-Vr8krYNoRqI02J1DR7-aJA9Gaw9lWr2ZOjpPli6F3YCW1DDzHPhef-sHZydKS8oJcKsSJf8aWzEMlpVIIu319q-KvebL6cqdr2K0l6_LQ2xWSP9L--K)

Reiniciamos el servicio para que tome los cambios y revisamos el estatus de este.

![](https://lh5.googleusercontent.com/Ajo9HeZdOxdbxONQgNjOf6O_D3rygwvHaunF6Cj6E0UPQmepsdvcuMX3fxF0xWdkwAdAQMAM7nfoig8csligLbC-gpZ3X7ISmSPTF9XDB4RBlDvq5oBir3EIlhZn5-roOTTytx72)

Para comprobar que está funcionando, intentamos 4 veces ingresar con credenciales incorrectas al servidor, el cual bloquea la conexión al intento número 4.

![](https://lh4.googleusercontent.com/y4cb4rYlFB3OorFfU3mfVnGFzVYWMPXDNJn_-MxL6tSPSfmjSlyRitwnhjm7bTEOjsg_Ml2hqpK_vwX9S_myQJ6KK6fOzS78QHtHwFXZO3lUxrxJV-W232bL8oKtvG-Jqm8UE8un)

Firewall en modo bridge.

NOTA: Esta máquina cuenta con dos tarjetas de red, en este caso una en NAT y otra en una red Custom,

Instalamos bridge-utils

![](https://lh3.googleusercontent.com/aHfoGy5QXCFKZgy9Z4PIYqwGVT3zML0MNd17YTRWvfXF3SScAZi4UizTP2Y0nwz3vIpHLOwWSouj4nqRIVVyL7-KhkImOeiVMxNqnNVS0XgeoIBAYTuud1hPJhWegPD0-JBqkXF3)

Creamos la interfaz del túnel y vemos las configuraciones para asegurarnos que se ha creado la interfaz.

![](https://lh4.googleusercontent.com/qubUu8UP9zn0flljrK99MtUnUuKCg0KyV-6abyYkwWg9KSOL4EtgY_AkkHykPKAs5miLb1qGXvM412t8ViBtwNy54lNgOHsBiD6fFnzTLjSgRs-Dr6ng_n_Yr0JuYVzWjvTsP3PZ)

Editamos el archivo de configuración, para que el puente reciba una IP estática, en este caso 10.10.10.10

![](https://lh6.googleusercontent.com/nVYONZl3_kAPa_7GHphn_KgS0cbYNdGtYlFE4hcVG6JBS6aCJwf8dkjyjGjY11Xz3q09-2tz1QNMNDnrjPM2T1bHElduU8PekX0CcDRlF4NlImncwyahfl2HUZe7ZT3xirFVtxU5)

Reiniciamos el servicio de red para probar los nuevos valores

![](https://lh6.googleusercontent.com/Iy_WmsLy31WHjCoRik7DO0KiOQgCZcjfJQ3ZQc7aBxBUpi9QQI30_xfHpunBkM_uoZ81aBFE6B3YccqzYTcHEGESCkXMMTtg1RtEF04MSeQv6IQYPPKK1mY998kkE4sN3KZhObUR)

Para probar que está funcionando el puente conectamos un cliente, donde conectamos la interfaz de red del cliente en la Custom donde está una de las interfaces de red del puente. Lanzamos un ping a google y podemos observar que este funciona.

![](https://lh4.googleusercontent.com/PWXCLi0qKe1gvnmIORsZsmuxZZ7zKCZUaoNt08nSgz-mxzF4a80gUBcnGj4IKcXwAAsklxboaCGfyyRuUvBSUo9-ep7A1EWDSjAkceSy_ie2ayoF0jVvRvMBuhqOGRNUNvzgw2Af)

Ahora apagamos el servicio de red del puente y volvemos a lanzar el ping, observamos que no está saliendo.

![](https://lh3.googleusercontent.com/lYVjWIQbaZDxBrBcMQDsiXpWBN1K4PZXkOx7WVb1C61KyJ92G8jAXrfPE_80VWIedDxOcigRUiItHmR_9N0nbII27xrS_JsKBuCjihp-kH-KAhE5YU2XMzw-_xL_gKladwDVj0Nx)

Una vez se prende el servicio de red del puente, se alcanza google.

![](https://lh6.googleusercontent.com/6rPYwCAs8lkFMcYlthiI9trh20ato1HSRE9DbJv2sXgUZKDsQf72Yr_01uJtEWxM1MG8y7XDMnoqGlpT06TfHax8KMZ9G26AGEGpOcfvH-5kwm55PZQqckH732OgfLLiBnynTV1v)

Netfilter

Para que todo el tráfico del puente pase por las reglas de iptables antes de pasar a su destino, agregamos las siguientes líneas al archivo /etc/sysctl.conf y se reinicia el equipo

![](https://lh3.googleusercontent.com/Vg4TwjGiKGUm655uETtIc5RsiK8Y7s1Wbu3L6GLWnGseQBUA12e8KT6qtvFAP0yKEfXE3Y1npX8-nlKk76TCbJ7O9Vki3aa7swefYe8puX30GVXRhTtDdBfo-jqXmhhcPZWAIFit)

Habilitamos br_netfilter

![](https://lh5.googleusercontent.com/d4VPzUHO6IMLBXguLCck22_sD1LexJ1kUBTa1IqpgXo4soynEna2L9RCD-t3dtr2t2mOT6KHZ3w-eJRRhEOGReuEvhznaddytpJOzB-aXbMAvd2XjSwtSSY2VvY58tlOQxij3uB4)

Agregamos las reglas restrictivas para no permitir ninguna conexión, para partir de esta a crear reglas que permitan el tráfico http y https para el servidor web

![](https://lh5.googleusercontent.com/0CEboCcZRtL-RKU42PvI-_RN9tsLu2ZV9EP5-JnD9bNZ3MQfB3_jBldBRfL557y0Bb4WdYQcbDdDODuLS8dVUMzDfH3E2P7pHoCAbOR4BRKx66-rR8_HNjG1copeLfILB6_SrGn4)

Probamos que esto funcione lanzando una petición a la página web, donde podemos observar que ya no permite el paso del tráfico por el puente.

![](https://lh3.googleusercontent.com/d4Q6iHWBxBx09S3RRGqhfyEwc6l4jghbVNZatGcnDjGZLLQxFSM6FiXWjLy3W-ZT0Q3ILOAmOyZGhPQHIY9MCfIPZSyMMvA0rAan7nfvdA0-dEcRCBiGsfKXtasmhJmVcsTPQFnm)

Agregamos las reglas que permiten el tráfico http y https para apache y nginx, además de permitir el tráfico ssh

![](https://lh3.googleusercontent.com/kNgCLKYPx-3pCF0KdjMiOUCg0Z837AmmFeljVy1l-_eoV01cf8471f_HBzsWGCXdAfhdO5EBgXCFRGhYW0ZasfM0-tEqILLpkBotw0KlstiX8xojTrknJi7S13tozSU3GhQDTqUe)

Para comprobar que el tráfico está siendo revisado, hacemos una petición a las páginas, donde la tarjeta de red de este cliente se encuentra conectado a la red de la tarjeta de red externa del puente.

![](https://lh3.googleusercontent.com/QfKrxclAj5aLl4KqCuaJHWDWLzX59yk1lfCDxx4UJVAJ_AK29G-n_pPpbOccivddo36iME-VmZ4jHkvSk8FKog6eRTeu7bWJ5QRxrosgxvkGRncZrKHVJ8hT3oERU-lcKgQ_g3M7)

  

![](https://lh4.googleusercontent.com/oO1CO20nzheU4fKVUe094fCoJ4SGQytNRzUWMwzgkG4sfBQ16ce75zheaVhE8N0uSO9ih1NxZokvkWmXDmoos2xwd7HErkY7GIf2PVcMdGw9upCewe_U7ARJvLCIaVGYONMRnpxj)

Para guardar las reglas instalamos iptables-persistent

![](https://lh5.googleusercontent.com/ytdk98nxlWDk2wr-NbFn6pIwr8ZLUM3WvJ_mYXuugui4nAokrbg2NoCS5Fgt_idPgHNwg0uK4ymbqaK5Ol05bLF8I4NQwKiLQfr29UMDNo9k0VrM9zsKYnjzCzXBxOfkn0dEdjAt)

Revisamos las reglas y las guardamos.

![](https://lh3.googleusercontent.com/Qqc92pEDKz14VsJC3zO7yk3ujq4LchVJRQMSJW6wW_TCMfZIMv2hHJdlrkD0end5kYYZDm2pWFse0sTC-tOvVd7_CAoIg-Zw3x5b7w2kVj2hm1GtYq9mMMGJA1tmWEmpPrYDX04H)

### WAF (modSecurity para Apache HTTPD y NginX).

Creación del usuario para el servidor

![](https://lh6.googleusercontent.com/em7MMx-8mHg-8j8NVljYDaXjL2FhlUVP4C-gIlHoD1_zVL_8iWn2TLqP-1J0pIJUMRCkdIybZOEvodygTH7ST1BAaymW7bpvVTJPcJS5nlCzDALjQqKx5Xvd_mZ2sNY4E81L9ymb)

  

Damos al usuario permisos para la instalación de los servicios

![](https://lh5.googleusercontent.com/Q5yG1DexnA4FoF7wwMZcdloj5JOGNfnXDg30bD9S8EXzsocokS1MVKC48gFWneDkAWDOZmQ0aH7B9UIko9DLDsT-YfVjGVu7poCHTf85OvKIMn9Vq4nRom-i2ic4HAO1Ii3tVFkA)

Configuramos la ip estática, para esto se edita el archivo /etc/network/interfaces.

![](https://lh6.googleusercontent.com/We0P1DMUorG48NcQ-NENOs6LktflaD7oIW1bWIBsmFnHFLFdQXYQ5SG9emy1-ilz-GOdEXUFMCc7QHcbHEoUAg6VFS2dzUNWg7tcL0ktF3Ucv3Ug6t7l2vsT6tbg624er39e1bnF)

Instalación de ssh

![](https://lh4.googleusercontent.com/_SlOoT_hmMj3N4rF9aukBv9vPPSwICnQPERe_XXUhUWo1a7IPPSV9PxJIWmZp8AYHMpD2GMYhjKVtwgNVP0s_Ye_jfK_NmvAYURmcqwx-JgjhskfadjrPn03ySb0TeQvbvXXiazK)

Revisamos que se esté escuchando por el puerto 22

![](https://lh6.googleusercontent.com/q_jcKiRNbe5XUcL2rwMbwt_AoIF7vBbshuAwSjzXO-NaBfOvOv_qEN_-eGTOVhW7N3ZVfsHlnK-rD0yQt1QjeVeKM9cvDQWi3Jsz-xhGDZ9J2XTw-KhzA2vhxQ-Q1ghyNDxSK3-i)

Instalación de apache

![](https://lh6.googleusercontent.com/AmsvZHdeTmwQVlOVWOTq69buUfLHUxZXjv6S3W6CY-M5gdvyGLGGmsOG7LKx90R-eW3J-MXmgmJexPvS8i0nbi_ZwThOHJArkP9lhE4Mhtd9HBEz100ZNlccAkLsQCkXqjTGnvDh)

Iniciamos el servicio y lo habilitamos para que este inicie sin intervención humana después de un reinicio.

![](https://lh6.googleusercontent.com/IA-88jyVO7YmSFKJ-Ct8u2g5OpP2cImA7nRwhoJ-rfzDNeKK6T6gfM9DkMDo9NOgqQJkrGuB0CP4jYHRrnGMztQ1kQW11zy3n4ToJ9AqaUEH2m31LiNqOcSaZG4aR1cny3foLJMY)

  
  

Instalación de ModSecurity

![](https://lh4.googleusercontent.com/GT77tTX9U5cgou96AedZpusnXA-SVvTp0QVX5knYyKTH7wkSCmMop3Z27Uk4nXFEIXf4GCiHav-4zbIQInyMxRBIa6pnz-C_qJVqiiiP3jGKyVe21AZUT8wffD-k3joqnPvrjePS)

Habilitamos el módulo unique_id y reiniciamos apache.

![](https://lh5.googleusercontent.com/rVCUlxvIr-XjN0XWF8svE2GYmPypkYIHM-Zen5GJOg6bxiS0nDM3y1w1wmin0FHXg_AcwIhzY1SLy3fno05iCqQC2bzS3ZhZxhitjEZUvtAz8eTFj8IOtt5cBoh3BAOGEkYkzrv2)

ModSecurity trabaja utilizando reglas para detección y filtrado de ataques, por lo que por defecto incluye un conjunto de reglas genéricas mantenidas por OWASP, pero de igual manera existen reglas comerciales. Por esto ahora configuramos el set de reglas de OWASP.

Inicialmente ingresamos a la carpeta de modsecurity y movemos la configuración recomendada al archivo de configuración.

![](https://lh4.googleusercontent.com/Ar3N_gI-gEOu-WH4v-xmNLqbfGUsKUbE25d3LhCm00bhTbHXefu-ZfDDAUEJAAJ46DBqwYeNMBlPL1l491_w_Y6AQdU5DuSuI5E4IXViUcyIScusCyBDqd137Q8j_rT2_sGmCV9p)

Descargamos el set de reglas con git, por eso se instala git seguido de la clonación del git con el set de reglas.

![](https://lh5.googleusercontent.com/zrSwaewCVoKSjE7iQXLaSDdRM8ukBFDb7pz9XO-hY9KhpG74zpLKORWZMpStB65X0YitLe6c3VfQXzOBXQvOTovsaZdu8FCJAYsw0I4FlxvyHWwqXpaELZbDPJhAOMlXqrFJBbJc)

  

![](https://lh6.googleusercontent.com/tkxAkA-6cqOwgTSIVlAvY1Ccl6CZWufDBVzF8muqLmVV0benCUmvH97HGidJS7UiQMU-weFL0iKqbT2UpBaEzfJ_eokCG3DpiSiDbAzQ_nqQimGRBG5yc9rI5owVO1yR-E-MVLl2)

Ingresamos a la carpeta y movemos los archivos crs-setup.conf.example y aquellos contenidos en rules.

![](https://lh4.googleusercontent.com/BaAGfXQneQbIYwfgVfNo0PCur7et0Q-ODVrlcSdKGKcjuRKLvcqVvQIKSuBe-mt5iAaIne5GogzbK4vaSLYaX9CAgY3uIulJclkfiFnrAKP9qiCls7BePMkjnl7YXZaRj2al0bO1)

Para aplicar el set de reglas editamos el archivo /etc/apache2/mods-available/security2.conf

![](https://lh3.googleusercontent.com/y9LSd3vwEU7Jrd-3CFkvtOC1PL6Pe8BuHD5jVxJFZpfbbeR1HLOYXuhJXIC8ZXVMgr0UXuBVZ2MPO0jWn8jVTz4EhsEDcD4f67MxmAQVZDli1132ISZM-WGl7ligqtlmZ78Y0VWh)

Probamos que modSecurity está trabajando, para esto editamos el archivo de configuración de la página web.

![](https://lh5.googleusercontent.com/iY4fHsz5yiI5RUo357qPMQoE9p6NeXtTslspQtMYS9V2dppmircd2Ju_IoWY-YrJ-mrnQ1VuZrLazMriGlqDris7uJ690q-sLq8676ISu84yobwjuUpVLsDz1RSskru_tbvPnaSi)

Habilitamos el sitio web.

![](https://lh3.googleusercontent.com/GQrnKw6IJfrctpebUczyjfQ19SAMlyZyeN9Uvs-FaIU3w6nWvTB5qYJb86oNzH5ehVNhTPu7tZiZbEoLiK5R68669_diB6FfPaXUbOExlOW6VzN61z3Ak9ZHpU2bwlEdXjTm_e7F)

  
  

Reiniciamos el servicio

![](https://lh5.googleusercontent.com/NvZ5TQ_ZsHfyN3ZhXNde0ay_aK9LlhCLDInQJjElcOa0ydvzX8AdFFIfr50lAC-An72iSSNJ52DDgPYXv3qf2TAeIuoYNJu-879BtYu8HD93SI1DdMCmGGcu4UEDLBgTOCBRTS3V)

En otra máquina que alcance el WAF confirmamos que se tiene instalado curl.

![](https://lh3.googleusercontent.com/4nSPtX-DkGJAxSOcoif_X669Q6OZ9alGVHAzg3Grd1eiCykwrwPBlLPuE2ywdlgv2fNZ_bWxDuXPPLFvgLAlkb5KMbnUzWCktDqdNYb5xXIugmDR0WdtNcYxsCFSVedWgM28Pheg)

Lanzamos una petición

![](https://lh3.googleusercontent.com/HH5QLoSKdKcg1ySwUWJCvgsHAcZNMFRZwRHALlBWeDZnmTx-tnNesw2J2irB506vT3gUMXF0jhHlwIFQbXoMnPq8C2iqSL5x-8eITyIRP8uyzH7v9tBKA9mwzBClQp-By2nBLRAt)

Revisamos los logs de apache, donde se puede observar que modSecurity ha detectado un ataque.

![](https://lh4.googleusercontent.com/KPL27yfyMchjNaQCEDRB35MeQZK8wCmdUxX0nPcENLs0ItaNtD4dk1E71EdKKmjv0kodFPlo2l8GLh2xXuX24VPTc5t74kijLhelxuvQoIRb0RBuMIshWu1SndnZaoPY2wJ6z0WL)

Proxy Inverso

Instalamos la librería.

![](https://lh3.googleusercontent.com/kDv64RXYqDdUpsV3JhwerP3rp7D8jYOtANSAOeHxvu5UsfsbfBsS7DOPSpphDUcJVLGUSwWz4iZOWd1FjbPZRJJJFS_0rHx6ZgnnUelWWyAOohIrrugfw-iJo6YZ3yADH8FUIrZx)

Configuramos apache para conexiones al proxy, listamos los módulos disponibles.

![](https://lh3.googleusercontent.com/G9Ny_b8c1wFiLeK6PdgFXpSc5BCVGg_Mqi_HoeiRiU3-IT1PSDi4JxOz54Ue5tPcSQChJry_7oUHyp50XS-12Vb9pn7P06rCdVED0FLb4lczm4qjfhcPxCeIYZSaePvBPV6XklCx)

Posteriormente escribimos los módulos que queremos habilitar.

![](https://lh3.googleusercontent.com/6QhOe-iAD3OV0LEeU8Lu9Ld0sQ0c-1Gq6hNg1CwA0bjynIHCF8stOJlIIxm04l6ai9sfGWQ7IYkkgAqgPEJAyV-xQ9TzOTkkwVjw8UjmAgQVLu4gNXCRPWA_4R-iMUkjqsESHfmK)

Por cada página, ya sea por IP o dominio (dependiendo de la configuración) creamos un virtual host en nuestro servidor proxy, que redirige al servidor donde se encuentra la aplicación web.

Apache HTTP

![](https://lh5.googleusercontent.com/otnDm7CgUgNof5PLji_lwO9T7cYD01E7fpydJE9oCQ3Zw4z5Icbs6tqRl41fCwI6PKD5ArSVYLXb8wFvXgzOSUbTtz0REuxIxz264m75PGIftT7BkYKc_KJjHxiNvn5DQJuUWAgM)

Apache HTTPS

![](https://lh6.googleusercontent.com/gwJXeaCMDUhXSY8NLpEuCZiTaM5r3Y5E5jA7JUMU0xuE4XbpFs4tL2e-GS6mzhIJf35veSfYOZPspvCHwZ6dEIeJ81Y62AO8Oa8BtrmDJEEsfuGl90tSGfP3FXlH1pfxv_u9rUop)

Nginx HTTP

![](https://lh5.googleusercontent.com/lebQuAk1qjjV6OjcHbPl3D4h3Rx8RLcu3H72Zj_QeqCqQOPjJPnanUAdfPYfkiaSGLKwWU1Y--lOVRGUr9Ltvc6yk4XLawO1-hRXDXqgVThT3BCdBJvmUi4S9-gSkG0doFwHqbW7)

Nginx HTTPS

![](https://lh5.googleusercontent.com/iphdVdTZtuf30hJZxZWk3HwlOK4540WUrtPq2rhgIFpD_0FzaFaFBidh7VlCFi-GICYxCQMNCReN2PZa21BT5-A23kdKbsJMstgmLxqLR7Y1nx2xvJliE1ipvBMQrPp08TEk_99h)

Habilitamos el módulo ssl

![](https://lh5.googleusercontent.com/v1ql_XcrskTyQWUsK2aLk8Se7PysxD0CPw_5FVD1uaZIyED5O6I_klGGl5mnYqEB8vezIRtkrylo6-0eYxhIXTenx-Wea6Ku-DWNKyh64aQRYtfsSHlcF8edLgEO8J6g6LJoIWms)

Habilitamos las páginas

![](https://lh6.googleusercontent.com/4rLIx5LaDGZ5HpVROK-JMIbMXjtj-I2pLhQwfVyM6COgw4X4BJBhb4NOe08jXD6n_X-O06OKMH9JMeI9LUFXrLQSQ3kPzGtc__gn3rleq0jYn2wEc-lJJfv7RUCPuJJjM3Ty4xkv)

Una vez hemos pasado los certificados a la máquina, descomprimimos el archivo

![](https://lh5.googleusercontent.com/rsecJpxenRfbHaUqjip4-0zzW34lzo4UPla1oemLE_4bqPmDT-HEmLG-2vcD14B3LBxDSDm4ZOi3C6mdYfrDwatY_VHfjOwVxC-UpDE_GRr2psw1EHeRsNaUUxF5TZOG_qS1Kk7K)

Copiamos el archivo a las rutas /etc/ssl/*

![](https://lh6.googleusercontent.com/hsTuU61LZ51_X1m6NqyxIkzjLJOH4VkpUlVZbZrGOUyAh1Ol2tHh6vSHS0S6u5dkVOOQbhfpV1NkcULxIZseR2UcgOhiBtWWhhqMldRkIy_pyC_WNtqv3XuLIHX2W6pTl1yYxrBz)

  
  
  

Agregamos todos los puertos por los que estará escuchando apache en el archivo de /etc/apache2/ports.conf

![](https://lh4.googleusercontent.com/pf6JkbXmwGtAkKs9NJvkGiV5840HeXhu0Lb43lVdz4XoHiMSrRu-PD4vJKP8RX-tJ-cQVfNswqxbYibrk22hGvEUfRb_Ik5MurJr_XC0-RsGYFAvqtjXl5tq6Nxgjs5_9e5AFHts)

Con el navegador visitamos las páginas

![](https://lh3.googleusercontent.com/i24luZbX1J3eV0hT72ApeQEqlos2ES-fSuQu6tH_fJmDmTi_f02Ou727mw9F7DvUe-dxthSznTDzgEEO3sOxy55eLrexW0d5T1E8Ex9U3ypfCOk_QQ_N-AdlXB8YE7QMqK0dXAPd)

  

![](https://lh4.googleusercontent.com/5hToedHSI0T1T49FrYNYiPTELTG0k-MjwPCOZsduaJrGwUs9Igr98G3tMB8jPdp8A47fGaVceSH44y8dsdkMPpgbyd_l6SbPKohKzJHivEj25rwo75T-3vQ3Ci9ToSQ6q9_YgNrx)

![](https://lh3.googleusercontent.com/__tH7aVlE0haFKMOYBMLhrm1tMJB_oCZ_Sv7PxPXbwejdCuK7zHgh3iJSD0wq3qRWr5rDuHFtYoHfpHUOyjg6YdksQkMBbnzdVeDlgZcD-d6M447-Rk8XU-gJxlNwV6nEdFhCseH)

![](https://lh5.googleusercontent.com/-sHKdRvsgOO6Z_i9EK8h-Vk_mHzmde0rqOLLhrfEV-VZnypEEkKzk61IZc2CgBhpsGARObwXQgvAmW02SbjAG3boOs1Rq1opqsV-ZiApBR7MwBcYxFYMV-c1NY4eEvURJZQkKKmA)

Para comprobar que efectivamente el WAF está funcionando como proxy inverso, paramos el servicio de apache y mandamos una petición a cualquiera de las páginas, por la cual no contestarán.

![](https://lh3.googleusercontent.com/DvJMFehMG9V8Sd4_YhFC9oZ4UTI1u2xeKU_oYKARsNwSsEO0UU0FWOlhlIIrBrcG_mC4VXnZZZ4ezcGkc6s8QBR5r9o6G2jGDJwc3xOGGLV6s98tueQYGIR369GMslrJFDMYHhu6)

Al encender el servicio, la página responde de nuevo.

![](https://lh6.googleusercontent.com/JQaT_KfPayZ1pe_KJvEraEcPYZL90KQoLY8u47NX7JOW6XA_yf-dmadYY3m4qtqH80okBzsoh9WwQK5I3rKbGK5sWvJLaxyyw_qOl3TmOa7x8Rx5Zq8_fYeVgZIe1WbRPXYpw2Q_)

Para probar que las páginas son protegidas por modSecurity generamos una petición maliciosa con curl y revisamos los logs de la página atacada.

![](https://lh3.googleusercontent.com/I8wdfBF370Q6_LJ6vG8JX-wHNS1Vp6VGbcz4fo_PoydXnLnPWNfQEjpZTBYUbtFm_9TqD4p_86cxWm9DSizmIcTAikxjPS7kRonQquJViQgK5W7OeD5gmL5W3SQSf9YF1bv-0syB)

### PostgreSQL.

Comenzamos por instalar el paquete. Para instalar PostgresSQL 12 y todas sus dependencias usamos

dnf install postgresql-server

Con esto el software queda instalado y ahora solo debemos hacer algunas configuraciones.

El paquete Postgres que instalamos en el paso anterior cuenta con una secuencia de comandos llamada postgresql-setup que ayuda con la administración de clúster de base de datos de nivel bajo. Para crear un clúster de la base de datos ejecutamos

postgresql-setup --initdb

  

También habilitamos el servicio para iniciar junto con la máquina y lo iniciamos

systemctl enable postgresql

systemctl start postgresql

Ahora que PostgreSQL está activo y en ejecución procederemos a crear una base de datos de prueba y un usuario que se podrá conectar de manera remota.

Entramos a la base de datos como el usuario psql y creamos nuestra base de datos de prueba con

create database database_name;

![](https://lh6.googleusercontent.com/y0QTg3ip-3lEk5jA9vXEwu8tQx_UCrGbvaD8QfyF8SD2kD2LP8EtKJqbBIAHI4arf9IrNBjGxoHYHVeULubD7UE_Gk4y4_JNqlxUvahpxbwRiwnTVfBI4O1KQ59wOHf4hZbI6Q61)

Ahora debemos crear un usuario y darle privilegios sobre esta base con

create user user_name with encrypted password ‘password’;

grant all privileges on database database_name to user_name;

![](https://lh5.googleusercontent.com/GLVkf9Uaf7MhV4PI0nSsISVlQg9lzeyfBX_BSFJrIeYbkvV-igO4A6KsoPIG9zWvoBPeAvaI4heeuuDWBG8diqq0e4u0qIMoXSl6ORxqXkFPKKWNFfVV3jyC2kfRoUTZTuLZo3xy)

Salimos de la base y ahora vamos al archivo de configuración /var/lib/pgsql/data/postgresql.conf para permitir que el servicio esté a la escucha de conexiones. Cambiamos “listen_addresses” a * recibir conexiones de cualquier ip e indicamos el puerto sobre el que escuchará

  

![](https://lh5.googleusercontent.com/nLw4YBKMk3u0cpTxz5ieLs1vD_HrmDH04GJtFYXd6G7e9fx7arFcMCCI5UiZgRSll1rUj28_mgSVcE9BgJEjU4T5brsA5mCew_XB9qcEIZt1npm1VbSiurwbqtHfpfwHowUcoY12)

Ahora se edita el archivo /var/lib/pgsql/data/pg_hba.conf para indicar el tipo de autenticación que se usará, si es local o remoto, dirección ip o segmento y la base de datos a la que permitiremos la conexión. Deberá verse como la última línea de este archivo

![](https://lh6.googleusercontent.com/MKdmWEGFfbDCC-A_skV80tJvqmTqYCK2ZAE2KUNdIlHQb5mBJCDxKbsz3yfI7myogj1Osanx40qY-EMs49FhuskT0jQx-tbw1dw7Q2nHqlGJ5l7urOrRqghsVy7CrjfYw9Ga-yD-)

Por último, debemos permitir el tráfico del puerto de postgres en el firewall de la misma máquina

![](https://lh6.googleusercontent.com/dRyF9-lLi_rW-Df6evSDk4eYWrxBF2DXFM-jO-fc5N8tWih8FdiJO1hipHHrDL8lXiiMtM-Ydq6GW_LE6WBGgoyqlBMzbGoJ5xuZQfPqcff6aG7PVGq9MCLd5liLnPnSSr5PTYcy)

Probando la conexión desde otra máquina con el comando

psql -h ip_del_servidor -d base_de_datos -U usuario

![](https://lh6.googleusercontent.com/uoKumxfGLkSUWfAR52lzNm3ox6Yv16AKpYtjfet4ALnxuw2V9Z7DM08Ci1uvK_IxEyq9MJc7AP2tfeLzyf0_w8IYJzYY8eU8Tei8fsPQHhmdQ7cn-CBkTvm3HXcAys58ffsiFBWz)

Notaremos que el servicio es funcional y acepta conexiones.

### MySQL/MariaDB.

Comenzamos por instalar el paquete. Para instalar Mariadb y todas sus dependencias usamos

dnf install mariadb-server

También habilitamos el servicio para iniciar junto con la máquina y lo iniciamos

systemctl enable mariadb

systemctl start mariadb

MariaDB incluye una secuencia de comandos de seguridad para cambiar algunas de las opciones predeterminadas menos seguras para aspectos como inicios de sesión de root remotos y usuarios de muestra. Utilizaremos el siguiente comando para cambiar estas opciones

mysql_secure_installation

Se solicita la contraseña root, que no se ha configurado. Pulsamos enter como de indica y luego establecemos la contraseña. Luego se nos preguntará si deseamos remover el usuario anónimo, le pondrémos que si.

![](https://lh3.googleusercontent.com/rHCOihlteK7Wt-0-HOqpy7jVWwpuJ5YdjK9YDB6LA2Q5reIBtLuLIpnsTGFGGFWvdl3fy7k3yq4bRwNnlwWXolF8hmfH8Uge2hC61FYvb2WvmdwNfSx8lhGwLkf78Zwo3p1ZQnvt)

La preguntas que siguen durante este proceso son si deseamos remover el acceso root de manera remota, remover la base de datos de prueba, y recargar la tabla de privilegios para que los cambios surtan efecto.

![](https://lh4.googleusercontent.com/1JHWrOTI4AOdAnF0Yj5b4vx9MqftV9MYdqvo0supDVyZLbw1yt0dcBcw1oXw-DK8aPD1ilX8AyQ4h9ZqxThdfYGR_j-c7Od61f7k8gfMDpth5mC1de1QXRTIYngLSZ84zqQnK-wh)

Ahora que tenemos el servicio funcional, crearemos un usuario y una base de datos para hacer pruebas de conexión remotas.

Ingresamos como administrador a la base de datos y usamos los comandos siguientes para crear una base de datos y un usuario

create database database_name;

create user username@host identified by ‘password’;

Ahora le daremos privilegios al usuario recién creado sobre la base de datos que también se acaba de crear

grant privilege on database_name.table_name to user_name@host;

![](https://lh3.googleusercontent.com/tN-5yhqmUg22GRlDAwiSOnA8HqDzCkflTuDb2I9jgfrsld0TGpiwfJI0htd4Zi-8NN0g-5gWUVd0fkqvJ5Wi3MkSuCgcB73BLX4Ys75PtI6MnwofqmkWTe3z0nUlppBqmTzkSofx)

Por último, debemos permitir el tráfico del puerto de postgres en el firewall de la misma máquina

![](https://lh4.googleusercontent.com/DuhkWITYY4RKMHB7bsiST2gSKO-3mPqEYdr57PXB7bqTC_bRuA7_2aSYMjGJizwEHsTys8QFKGG__hVHCuN8wIVyrVkQeVwVcs93CqYtGbKq-QinzNdvUJcd-ZSDvcGsOAAHpo5H)

Probando la conexión desde otra máquina con el comando

mysql -h ip_del_servidor -D base_de_datos -u usuario -p

![](https://lh4.googleusercontent.com/z-f-qwxqVS1xmr92zUjNZYRM9G4ysnjLS9IJqK0YpvgY4uEe3inXiE3rx4tqeYr_W73hZ2XudVyk6ok2h3E_CaUlMsV-wvK_eKHLQKEjmdNPiGfWDGHB2H3tou7SHAM-9c7INCC6)

Notaremos que el servicio es funcional y acepta conexiones.

### ProFTPD.

Comenzamos por instalar el paquete necesario para tener el servidor ftp funcional con

[dnf](https://www.server-world.info/en/command/html/dnf.html) install proftpd

Ahora modificamos las reglas de firewall de la misma máquina para que permita el servicio

firewall-cmd --add-service=ftp --permanent

firewall-cmd --reload

![](https://lh3.googleusercontent.com/Gxw_tcJ-BcG1hEPFQp5eqjmHqqSfPyeMe4urTMZIfU6f2li0TIxrkoAYoy_Fw4Y6SBpdNx27I-2oteYSRO1EF_Dnwg76hlYGUhnpSv1nBx9l7wSbyxiGL3f1n782SHKB344AAS6i)

Notemos que el servicio está listo

![](https://lh4.googleusercontent.com/elBN2E8cBUBqnzf2q2ue8XdvnI7npRjnclg2jVSBXIE0hKWFF0NBoEwiZcLcuAQO3Sau7yFylwThL5olXxRvmI9sus7YJzeMG7BS2XvWF1YZ02PhYpL278mHyelTqKrqERsTXtlW)

Ahora probaremos el acceso al servicio desde otra máquina. Debemos descargar un cliente ftp y después, mediante el siguiente comando, ingresar.

ftp host

![](https://lh3.googleusercontent.com/5BWwjMTh1XCFE0UT0_hqLlbxytqhKb83yk5BbzoJfiEegorpt9D_GK35flnOZm9A8TW-ik8utV0jY-UB9tp9-cxOoWERDdDZUWcs0FpdvB3VkIutTQ0zWvWoe0o5_7uUriu2-pqh)

## Dispositivos de red.

Para los dispositivos de red se optó por utilizar GNS3 debido a que este servidor nos permite emular distintos tipos de dispositivos de red así como utilizar máquinas virtuales de VMWare.

En la siguiente imagen podemos observar la topología resultante.

![](https://lh6.googleusercontent.com/IbghapYG2iIgIdNrSOJ4rZDcPcFqQcTEMRgiLD7Yov5Hn9MUZVgxTajLLvB49JEo25Cb0bqGx4E_5sQyXASJm9JyaCABFrM48ugsMGhHbwoVjhzAHeFO8OjFZTOu3y4K7u_l9iCO)

Se realizó una importación de las plantillas de los dispositivos de switch, router y fortigate que son ofrecidos en su página.

![](https://lh4.googleusercontent.com/fwddoljbbya81tfKufHrrj46MZxk58MC_9H522__TmVhwlGKjwdaYRE0kA44_Lb1bqDMsVKoR4rf4p5DVvVodkcfsMzgHJI3D2Xl3lVibLZS_d5pkrF-isUEf9Y34W6uG099VEC-)

Una vez instalados las plantillas es posible crear estas instancias y configurarlas. En nuestro caso se configuro el router y Fortigate

En el caso del router se asignó una ip para realizar conexiones con el fortigate. Se utilizaron los siguientes comandos:

![](https://lh3.googleusercontent.com/THPf2l4NnRGxML27lTuT9rbba9W8dryUvxCnm2jQX68Qg99bLpAoUDR__Ja14ptJmJZ3XVEXMRSMXzEG9uEAtSGqhV9acacdRkXEpk4PuOHrwMGh296iOda28uA0aGznfbpc0o9d)

Posteriormente pasamos al fortigate para configurar un puerto por el cual será administrado.

![](https://lh6.googleusercontent.com/w8Gb78bCGz9qUYuv3tZnPlvPBKJYtObgZJSaCMMSpl0gelqiT5foOdc28mPpTaEG46i7sU3mYpSRrMiSOFfsn2lLZkhilq_raUkmM4D-ikXOtXLMqVT9Tv6rdy4sM_UeRzr--tfN)

Con esta configuración es posible realizar cambios mediante una conexión por https y utilizar la GUI de Fortigate para simplificar su configuración.

![](https://lh3.googleusercontent.com/HJQdOHTmWLgZID4WIbTk9UzlLpGLLIfD7xBAS5vb7QPeTbnwLYRQeEicjgeSz-64JUM0dxAJ1O5gIElcY86tzd7MJgyEYkBZZXEUMh3AqPiQYCX3fkkhzdmJXvtyDCjP2dJ-CcSY)

Lo siguiente que se realizó fue la configuración del resto de de los puertos para permitir la conexión de los servidores con el router.

![](https://lh5.googleusercontent.com/rLa48-FQShm_CZfbVXgzrEOLerzHTpvJvhC-O1HxhcKxiWwmQ-TgGJIU3_vSsg3LIhiTQV7CQLz28qtFrS7AgIbOjZT_cKfGdlqsPd0V20bRaQkeYGLxXvAhpjbss2uBaAkfNrZD)

Posteriormente se cambió el modo del NGFW para que esté basado en políticas.

![](https://lh4.googleusercontent.com/mQhTkqqtR_LH2gcYgXSlreLwVu5LiHZV7Psz9zHLR9UKpAHgJ2x9kiKpVCYUnOCf_l6Rht7RKjzhNeFV4hp7n3jL37dMc8sJfsqPxkJW8EXt09NIa_8pcwTJbQ1g9Oket5uip5pV)

Después creamos una política en la cual permite el acceso total de los servidores hacia el router.

![](https://lh3.googleusercontent.com/8xyxguyCCrXCrLZfFOJNGdOmOHcMFTm-_nU-_UbLiQeDXA9mZYjoS-jMvjMCbc62T-r0VlPlrqqqh9lK0uqBL-AbPGf5TL6QQjtAZfZn4uqNAqfURaoHvuGcHiWyT4zC7ItEFI7s)

Se implementa una regla de SNAT para que se haga la traducción y pueda contactar con el router.

![](https://lh4.googleusercontent.com/GppHDjjhc8jAPbB7YPZ2nitgtZSm1VNugxqA7HNHfC9pspgvVByD41pkAa1AeoxXpVzwevBBg_j9znmTHUcWmu8h8tS6ejcXdLga9zN2OtqPG_nDRHRUdzlGH58eatqt8DYOyUfo)

  

# Instalación de BELK Stack

En esta sección se describe el proceso de instalación y configuración de cada uno de los componentes de la pila BELK.

## Beats

### CentOS

En CentOS debemos descargar el siguiente paquete.

![](https://lh6.googleusercontent.com/1itH1dbQ8JxHPfSe4C0hRkQ9HFVIU8_k1FpzFURvb0JUBxrHC4O-Xvo98xsu_qkLVLxvuRBiH1V3RxAkGgjATdhTPhh-FhIvJmzYNt016AMbIFuEdFpO7CboFV7cS6A3PBlt8jhp)

Posteriormente podemos instalarlo con el siguiente comando.

![](https://lh5.googleusercontent.com/VegZ6NtmTkgSONSO7ECmO8sjlZ0Ob_l42VvyDAiKgJdQjMGbGCixW2ji9LsuvzR-gCNJQ1ecxu78Ps0M5ZSf_L3bmbxE1lRtmb6axrBr5RukMc4eclI_-dTDVdOkyfAPZHWsGBBt)

Ahora debemos de cambiar la configuración ubicada en /etc/filebeat/filebeat.yml. Cambiamos a True el valor de enable para que mande los logs del sistema.

![](https://lh4.googleusercontent.com/e0sG6QquxSr4B8rxrkpCrddz7H0eL1w-Qu0hsSb0tXhAxLl2TsYDPh86Lwcn-TJ8qEQL0qauY2cyWhPTMvFF3bsHOG9agENeMS18hsC3dQGMcCoFpqmUWWT_PjymMgeonPGI1Jne)

Después comentamos la salida para que no se dirija a Elasticsearch comentando las líneas de “output.elasticsearch” y la línea de hosts.

![](https://lh4.googleusercontent.com/aG-N6BqUOpSFI1inX4UzROZPFnEYhzR6JgUMAc3eNnoQ5w1vLgCstbO1ectZdzXj1MjziyIzNXgnz19S0-DSWBWZVJB6cLaxH9U5g8kUC4qSHIFDZeMtaIVp9sVFhCYpxmrSra90)

Y descomentamos la línea de output.logstash y en el de hosts colocamos la ip de nuestro servidor de logstash.

![](https://lh4.googleusercontent.com/ALHjc1e4l7hN7Bzl91TFY-bkVBgp2twKUUWScyEKFuPEaClrYOXnbMBEiwhOHIeJiw0PMas015VZBcN2rsjyqmasqiQOhISsJCB7H-Dj6Bdwhi2Ck9uYBQsZoVqbN08JdUdJIr57)

Después de eso podemos iniciar el servicio con el comando.

systemctl start filebeat

Y para habilitarlo ejecutamos el siguiente comando.

systemctl enable filebeat

### Debian

En Debian debemos de descargar el siguiente paquete.

![](https://lh5.googleusercontent.com/mSlt_3GsPxQ3W9qaYPeEa28a7obZZ2yH3V0QvfZb_onKhkJ6YJHOjrIcE4kUYt5MUm25x5Kv_KIAVwAdaL71FWhIWvYQ5XNuYkwQ7iKsZ4vWIytgYQxOF4uuXJqwArvC3-z9WvbN)

Una vez descargado debemos de instalarlo con el siguiente comando.

![](https://lh4.googleusercontent.com/kHBMjQ-9jf-wybyAfOVsJNMC-vzOCtb7cV7C-BitvHYx8ptI-Xnd52b2Sc9W5iBJsyF6oYi1bEKnMpG1OWV3QZtnTGjitG3wleOYIPZUaUptoEpYtm_EbMDgrp8J8_GmlXDxIQLb)

La configuración de Debian es exactamente la misma que la de CentOS por lo cual no lo colocamos debido a que sería redundante.

### Windows.

Es necesario descargar el siguiente zip desde la página oficial de elastic.

![](https://lh3.googleusercontent.com/AEVi82ON7Xj6rNLVDNjjdTmQXO51VjTRoafiZZCEcO55iLbgVNDOtm7Xct1EgE8DHqor2WJGxchVSCQ-5kZOHNBjcS0hbfYHi6lb8FOA5NDEXXnffflTWIFghOYJR0z0PNa7ENrZ)

Se descomprime en la ruta C:\Program Files

![](https://lh5.googleusercontent.com/2qaWn0HqWfpp419EW2SgV3oQc4tTOhOx9URPCmdzT02dXH8ysdj-VCHZjoF5ZVRK7Z_r2qnC5lVJcTT-uamr-2iBOjfW9J2KENbvr3MhR58ogh8HarXvHZRfWBxEZnlmBiCueBy9)

Después cambiamos el nombre de la carpeta.

![](https://lh6.googleusercontent.com/JwtIfAvOu73xuH8b0dZlyOCNhcXLPgPVp_G5_Xqqki_gtVbeGlx8nqvZl9kyKfg8ledNstk-l1fAcrHwI4EhOZpxkXabkMIhGddn6_4coo8Qmg9Nh_iduDCC47NRhg_bRy68Nniz)

Después lo instalamos mediante powershell.

![](https://lh6.googleusercontent.com/zYoflNDO_1g1oWnTv1ZmT_FrRX4iSmGWPcUQyTZTGXWS37wW-oy0uQZfnUfnoDpDPQnAejhXZg64RaZflC0KGrdN_WBESBQ4FXBqN4KlicpRhb8uAxmjMgBXsQenEJAqh9ttG961)

Después realizamos la configuración en el archivo winlogbeat.yml de manera similar que en windows.

![](https://lh6.googleusercontent.com/yiI6UrLyGl6lp6gS4AyJHB45NKnC6OKsdJwkMXmC0AwtniQs2z6oEbqhFiOKDThORCrZkJnjDZL3lGUHwWjsaVdsmSgzq_4Gdbhd7kckRu9OybscljhdhHjnLq6RRY6zkl8CGopW)

Después en services activamos el servicio.

![](https://lh6.googleusercontent.com/51pgqLXx81qSCKdOoP7a9QkRIHxRbQs6S98W7T7IMhoYZw6E1PQz_1TkdQU-PDxSlDUFF6pyiK_sN9YvJmxP9-nS0qrnkDLLFCm2X4Klt60_4qd80PE2gBVp87tA2yqaZn3f0Y_r)

### Dispositivos de red.

Como en los dispositivos no es posible instalar un beat es necesario mandar los logs a un equipo que sea capaz de procesarlos mediante syslog. En el caso de el router y el switch es necesario. Escribir los siguientes comandos.

![](https://lh5.googleusercontent.com/FlUDmsQZ3E0YJB9fZq3Xsst0JohepaHITB2GL6nMdKh75XS2gWBidJy1lfku7xAEifDHyjfAC_jUNdMDj2eOSaO1r7LcuNDQ-PuQjuLwYa0rshD7kKsF0Zc1Zm9J7aEOKCpNsTWh)

Podemos comprobar el funcionamiento con el comando sh logg.

![](https://lh6.googleusercontent.com/VIHFLfohmnMKR7LVUqYnS1JGMkRc0noV-a08ua3BxlF4-P62sWjEJ4IeZkyKxuEcu_mKiLjTek9WoDKf_doTRiVtnGkxi2TmmjwIOaeWTJdyOO-8q5HnjHypf7FM8ix62p1YhsJW)

En el caso de fortigate también activamos syslog mediante los siguientes comandos.

![](https://lh3.googleusercontent.com/q-xATCVW99UfMcjsu9fFv7JyT-Ps2NW9AnYlDhELKsqcMftfPs6zj4nQ6q3AZUme_YJu0UwCsZmWfjdFN4Hy7bzmtf2k17LL-xyZ_xb_fbj_QjuU1b5VKhk6ogEK3Q-R51Tf_Gqr)

![](https://lh3.googleusercontent.com/d17PTpkbTH1UnLnlPidHb2uT1_AckCjSskhDDj9rprVDV8C2skmB3i3OoksZWs-G1JmeZlxeHpB3XdiE3U6fbuwXGFhOr72bMIlZ_yuvnM2VVLIK_2iZAfIwCpRWfzx2THeGJGQ_)

Una vez terminada la configuración en el servidor que recibirá los logs es necesario instalar filebeat y activar el módulo de cisco. Para activar el módulo de cisco es necesario teclear el siguiente comando.

sudo filebeat modules enable fortinet

Una vez activado el módulo debemos de configurarlo mediante el archivo /etc/filebeat/modules.d/cisco.yml

En el caso de fortigate se hace uso de un filtro de logstash para recibir los logs y procesarlos.

## Elasticsearch

Lo primero que debemos hacer es instalar el paquete gnupg, el cual es una herramienta de cifrado y administración de firmas, este paquete nos será de utilidad para poder agregar la llave GPG de Elasticsearch.

![](https://lh6.googleusercontent.com/t3bSj8yN_efYCu6t-d2dAgWJ9AIUrmYdVOVAy1rFcnL59pRivkR3Wtva6kyF8Ax_LG9rHeV1aXA1b1vRWg6FbpiqvpoIrC3F6DPdNCgqKGXKON30SUZqv5CWLcq9PBO-BqUit3Z3)

Una vez instalado, descargamos y agregamos la llave de elasticsearch,

![](https://lh6.googleusercontent.com/PhQpMCX8Vep7ETEFaijxyLeygCf6ZQu8KCgrAS2BPExmHgvvnsJXYvQ0N2F737hjFT6ug1OnqD3X4OmAq9Dg9TBvKsaEI9yv3F3EaMRebiShV-9Z7ohT6SKcrs2SuyyEkrESnWIy)

Posteriormente instalamos apt-transport-https para habilitar el soporte de HTTPS de nuestro administrador de paquetes apt.

![](https://lh5.googleusercontent.com/kylDOAOrd_-kzrhixnqSaO26064U1aWs3VAq5Xis6Fct9fjaiJU7l9OWKEzI64HbjT-VEghWZZItcz4L-fslhdiQVloREfhmQeeK2hUZaT1n0rsI_G0df0EE_rzpP1mai9MeB5A7)

Ahora se agregan los repositorios de elastic en el archivo /etc/apt/sources.list.d/elastic-7.x.list.

![](https://lh6.googleusercontent.com/pEt-DTYoTURq_RegPsjncGvTQ2ebiA7hA7GwuhDhqBfvG4_62hdO9sDd4taf4waNDH81uYvfRoJXIlmL9RpHrUo6gw4zqZ4NkNZYkTfqZ3uORbMPlEkCctlAhORwnq_TYnct5waU)

Luego actualizamos la base de datos del administrador de paquetes y procedemos a instalar elasticsearch.

![](https://lh4.googleusercontent.com/PaGVhzeqVgiMjLm0vVeFf6O46JQShKJZ8OkRhyPdUEu4N0xBKEYyMB0RjLq4Dv-i7HkHX2wQDjtKZo7ovy4elCb0z7RGJ66JlSSuut0qUvhpngFe6oFl5ZDa0ICWEPC3tOoQGanI)

Una vez instalado ejecutamos systemctl daemon-reload para recargar los archivos de configuración de systemd y generar nuevos unidades de servicio, y luego habilitamos el inicio automático de elasticsearch.

![](https://lh3.googleusercontent.com/mySDJ2fW9ukTgqOFkiDfK_UvSFDvPzAUckLkhKCCBj5Y5G_5c2UHvEDDZdA8p_2ijvCPpWVJsaO5NNAIj6eTWMAmU-fiL__dtfJeA46E1ssoZd8t0EcuP1Hn3-dWjPDyoP2RWdb7)

Ahora abrimos el archivo de configuración /etc/elasticsearch/elasticsearch.yml con algún editor de texto.

![](https://lh5.googleusercontent.com/3ckIyvhvHrEs6Wy2P1VFOFmvCnFhMLPPLfpqVJqedEMd8bXe9GcSlhZp1MU6Q0KStaP7nYRKvDR_f8tKxECApoKUkW9e2kdySTa1yTxmQiVVOJxaR_idEfomi_LR_twnym_S_7iW)

Asignamos un nombre de cluster nuevo o alguno ya existente al cual deseamos unirnos. En este caso es un nuevo cluster. Además, asignamos un nombre al nodo de elasticsearch.

![](https://lh5.googleusercontent.com/ezhauOmLUCM1QjE1mrNE_MY_nUhf8S-U-O-Y0p2P0OSngrSe6dyFr7AgKhJ-![](https://lh4.googleusercontent.com/GjEXamdP1aD-3vWYB8fGDu3OS6WSO9C4_eep1Nsy0F0gVpibUIuq3TSRd7qtITsc65UC11dFypgKxu-7kHL71VZTsaM6RjhZ3Wt4PcPMYTIyNZ6GIOd5UaY8thaq7BESDfFfFh20)![](https://lh6.googleusercontent.com/eMcEDrucOxHi_DR_7-ivVSqYcrYQnRRx6kGeZXzS_XjrTVEpfVshSrzJoLO2f1Jib112V0mpIEPfXgDQ4stARD1PE50Cv-Hb5kpkv6N-dbZvIa7CuVgoPPkdeWRVdwbkSKF5hXj7)

  
  

Proyecto Final.

  

Documentación

  
  

Equipo: AAFA

  

Integrantes:

  

Fernández Martínez Abisinia Ivey

Luna Castañeda Abraham Iván

López Matías Alexis Brayan

Resendiz Cruz Luis Fernando

# Tabla de contenidos.

[Tabla de contenidos.  2](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.j3tt24eznz8n)

[Definición del proyecto.  4](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.iys9ktn05qbp)

[Objetivos planteados.  4](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.6pybp3uoggbh)

[Instalación de ambientes.  5](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.kbtaan6gtw1n)

[Windows.  5](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.vruws7mew314)

[Hyper-V.  5](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.8rk1mmik9hsn)

[IIS.  14](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.bwgkl17t95ei)

[Active Directory.  17](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.p56ia2aohzye)

[DNS.  24](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.p56ia2aohzye)

[DHCP.  39](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.p56ia2aohzye)

[SQL Server.  52](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.p56ia2aohzye)

[Linux.  60](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.qwqa65ptxkrz)

[Correo electrónico.  60](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[SMTP, SMTPS  60](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ogfq9fw3k9i7)

[POP3, POP3S, IMAP, IMAPS  64](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.7uryooasl9mu)

[Amavis y Spamassassin  68](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.whnwfrcas5u4)

[LDAP  71](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[LDAPS.  74](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[Apache HTTPD (HTTP, HTTPS).  76](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[NginX (HTTP, HTTPS).  88](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[SSH  93](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[Firewall (Netfilter, fail2ban).  93](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[WAF (modSecurity para Apache HTTPD y NginX).  103](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[PostgreSQL.  117](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[MySQL/MariaDB.  119](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.i7y6ilwon7xu)

[ProFTPD.  122](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ck2s8wrn2sx3)

[Dispositivos de red.  123](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.eo64xgxzgh2l)

[Instalación de BELK Stack  127](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.fa6mw77fx93b)

[Beats  127](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.4aghjnhws0ku)

[CentOS  127](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.gijt66u3vess)

[Debian  129](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.o52aj0rf2546)

[Windows.  129](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.i4vs05p413ed)

[Elasticsearch  132](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.lbzaxndbv759)

[Logstash  135](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ipai6exwxx0e)

[Kibana  137](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.z7nzdrmzvxr6)

[Configuración de TLS-HTTPS  141](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.ucj65pwdog9z)

[Generación de visualizaciones en Kibana  148](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.6dmaeuskp811)

[Dashboards  148](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.9pnsa3mn4xhl)

[Email Dashboard  151](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.mczq3uvkmnn9)

[Web Dashboard  154](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.33c7dc3yvxu4)

[WAF Dashboard  172](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.tt2iid1n5dd)

[Iptables Dashboard  184](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.xyp1ktbp12dt)

[FTP-DB Dashboard  197](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.kiu1w7g07ov1)

[Windows Dashboard  199](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.8hhsj7t3ona7)

[Alertas  201](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.t44idrkm1kvb)

[Alertas de Email  207](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.hfxwrwdnnez0)

[Alertas de Waf  209](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.5xmm3uv98zw9)

[Alertas de web  219](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.4r1fbhv8rbeb)

[Alertas de iptables y fail2ban  228](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.5c0zbivsabf2)

[Alertas para Bases de datos  230](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.2g0wutbdwnzh)

[Alertas FTP  232](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.zhml77937rfq)

[Conectores  232](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.eeskrc9t3x02)

[Reportes  237](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.kw33xn20bs2k)

[Conclusión.  241](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.i660skopq26z)

[Bibliografía.  241](https://docs.google.com/document/d/1LyNpjdLfWhcRg9-uCKHwo-Djmvpc3xltOfNqVUNW8II/edit#heading=h.4l0cirg4qgbn)

# Definición del proyecto.

El proyecto consiste en desarrollo de una infraestructura que implemente la pila BELK (Beats, Elasticsearch, Logstash, Kibaba) para que de esta forma tenga la capacidad de generar reportes, informes, tablas, gráficos e identificar patrones anómalos a través de la correlación de eventos.

Los elementos de la pila BELK son los siguientes:

-   Beats: Son agentes de datos de código abierto que se instalan en los servidores para enviar datos operativos a Elasticsearch. Beats puede enviar datos directamente a Elasticsearch o a través de Logstash.
    
-   Elasticsearch: Es un motor de análisis, búsqueda y almacenamiento distribuido en tiempo real.
    
-   Logstash: Es un motor de recopilación de datos de código abierto con capacidades de canalización en tiempo real. Logstash puede unificar dinámicamente datos de fuentes dispares y normalizar los datos en destinos de su elección.
    
-   Kibana: Es una plataforma de análisis y visualización de código abierto que permite la integración con Elasticsearch. Los principales usos de Kibana son las búsquedas, visualizaciones e interacciones con los datos almacenados en los índices de Elasticsearch, así como la posibilidad de generar una gran variedad de gráficos, tablas y mapas.
    

También se cuenta con una infraestructura de servicios en ambientes Windows y Linux que servirán como insumo para el análisis y procesamiento de bitácoras por medio de los servicios provistos por la pila BELK.

  

# Objetivos planteados.

El principal objetivo es el desarrollo de una infraestructura que implemente la pila BELK, para ello es necesario implementar una estructura con equipos que puedan ser monitoreados y que generan logs para ser recopilados por la pila BELK.

Otro objetivo que se tiene es la creación de un script que permita establecer la línea base de seguridad de los distintos equipos que serán monitoreados.

  
  
  
  
  

# Instalación de ambientes.

En esta sección de la documentación se encuentra registrado la instalación de los servicios separados de acuerdo al ambiente al cual pertenecen.

  
  
  

## Windows.

Para esta infraestructura se tomó la decisión de crear dos servidores con sistemas Windows Server 2019 para una mejor distribución del trabajo. Una de estas máquinas cuenta con los servicios de Hyper-V, IIS y Active Directory, el otro servidor Windows tiene los servicios de DNS, DHCP y SQLServer, ambos servidores son virtualizados en VMWare.

  

### Hyper-V.

Para realizar la instalación de Hyper-V en un servidor Windows Server 2019 hacemos uso del programa Server Manager en el cual seleccionamos la opción de “Add roles and features”.

  

![](https://lh3.googleusercontent.com/NkYYjcw6JMmNV5qGrCtgYdmr04S3_cp8Ch3dvV0bnsO0jNEp0aUA3bMoLQYvgKsarMrGEnlW1zEKu7vATLKjOGeunAn00WFlQLlx0MzDpSN1gK_9Sdlhql9eX7lApfD9PBHxOt55)

  
  
  

Se ejecuta un wizard el cual nos apoyara en la instalación, en la primera pantalla nos muestra una breve explicación de lo que puede hacer este asistente de instalación.

![](https://lh3.googleusercontent.com/tCqUl7pmPM6xsGT_TkIPSdvN_vnIx654FNJXM945M2oVAFdWADzWJ9ftIUfGapqwGr5Peyts1XHGKQV8MuvjN4hoIwoqTGK86G1DxrTlqNtA-Lm5zVoymX22toBQez-xYDFViHO1)

Seleccionamos el tipo de instalación que para nuestro caso “Role-based or feature-based installation” y damos siguiente.

![](https://lh3.googleusercontent.com/fHL1zIz_oHmC5LRR60DM_vXLY-i6j0xcemH6EzgDPpaHikcD2ojDuMFsiVPzket0pg_uIXogBhO7M4Z63QDb9RyX0Zu4V0brvHIx9fQfidnomuKrYAU6VpYbx35OR8ztlcVVokri)

Posteriormente debemos seleccionar en qué servidor deseamos instalar. Estas últimas tres pantallas se repiten siempre que se realiza una instalación de algún rol o característica de Windows por ello se omitirá su explicación en las siguientes instalaciones.

![](https://lh6.googleusercontent.com/ztodvHeS8PV-MQP3Ukhql752nKtZNmw-N8_DboQZtwshWAU8hwhRhfoCyinYkGE0XrBzB_j9gvOIZYgYQvIWqvIy1mO5DYBpLwSHI53ujaGfPKSb83cvLXE52v1zD1uf1MXyS9kP)

Seleccionamos el rol que queremos instalar que en este caso concreto es Hyper-V.

![](https://lh5.googleusercontent.com/pzlS5s0bWzDW65m8uWiBFsDrCo_xGznKgM9ZoGHJjs0LpPOtxivwRNxUIwv54n_xfvO6zxbYaTpHkZv8RsvrPjuJW10SVkMYYfr1mNLq5-WK1Qg_ycTkVh5M1DFa1S8OrRyBGoXf)

Una vez seleccionado nos muestra que características son las que se instalarán o para que el servicio funcione.

![](https://lh5.googleusercontent.com/xSeb631oCQbt6650uWCgFqy_O2Xuem0h04N7QBlqq_7xQqFXwSD5dUNoSO2g4ucN4OM-IlZizfUw7TZMr2wBktnkHmbvaeNMPNJjPx12bFmf_MFvi8QwpKZlHf5imofc9wWUUzLP)

  

Después nos muestra una pantalla para agregar características en el cual no se realiza nada. Posterior a esa pantalla nos mostrará una breve descripción de Hyper-V

![](https://lh4.googleusercontent.com/-GwWupDzFzYWeyQaLnMcoKpsEavtD2tViiD3bs_MbMyvGX-3wMW7nNmpZMJmQp1NcWEevzWhET3FumnOipdjzD-ythY2XfQ1THfikRXLRbVZDPRZR83d4qmqA_M9g-Qmt844D2SL)

  
  

Después creamos un switch virtual para que el futuro uso de las máquinas virtuales.

![](https://lh4.googleusercontent.com/akoFbBYiPGvE-uJHAeXP1zH_cCYEpFJ85519vEgoPpWayLzlGlX7egKG-k73_PULHBAK0zJaOQSSTO1AXldENmF2kYgHYLEKFHgJ9GRE4OoJAnf-viig3pZQ8Oiyg7hRuyJ6cXB6)

Después se debe configurar la migración de máquinas virtuales, para nuestro caso no es necesario así que no habilitamos tal opción.

![](https://lh6.googleusercontent.com/a46bYJBxmjuC-x2iC97w1O-fujY7sjZDy0mpgkTQzA64adujTzj9z7UwoRhjqWP7lXF1mSG3xEE8GeZHoRSg6y4-j3Gx1xgUE8kiCDbanyzb6qmdG7FtOSBtLDFWwTGl33S-u9J3)

  

Posteriormente se configura las rutas en las cuales se guardarán las máquinas virtuales y los discos virtuales.

![](https://lh4.googleusercontent.com/MNQ8zI0l3A4JbKiSbcvr-u8vANIy7qAoZHiNdtgApNEvzjJducmhAWx9YJUedDuGy2RiQAi6pAkQ4PdiyVEsL9BLkT_Acw93u1jK8GjzQVTWCM77_0CHUPcbedWAx_kJbDGpryva)

Por último nos mostrará una pantalla donde se puede observar un resumen de lo que se instalará.

![](https://lh6.googleusercontent.com/MrJrxgAEY67JXlzOLdQIC84MebopmCGx0c43yPK9k4DOsfinIYYNNMVC4Li2Svxj55B5g7uhI--jRgkuzU3RwCn4c9lsuB4Kft38B71dlx5jPzaAebAifUnLp3SIifbl6TFvV3cM)

  

Una vez instalado es necesario reiniciar el equipo.

![](https://lh3.googleusercontent.com/qwajgtMvlhetERLASQlXrZV0CkMq-DnK6QtrdFUOJVS0qw4JaZXCdn6YX0e9xFzNTn2HK4j5Vsc9X3zHxf2STxBevaHzU-9IPuriQcX3xe68AHueDFiI9uzFtyuTZPNAAw2MOwXO)

  

Posterior al reinicio en el mismo Server Manager podemos apreciar que el servicio de Hyper-V se encuentra instalado y habilitado.

![](https://lh5.googleusercontent.com/EwXRfQciO8e8n_PFuwQMZ3JmxicXAVtMs_1uJIezPKlBCSCT_WUzW295889Z_WkKZmTF-7A-6CFTGFFUbQN_BJPammKfj1AlSe5ar-8PC62vWYvnOIckrBjSx5I2WawOExEQJiQD)

  
  
  

Posterior a su instalación podemos abrir el administrador de Hyper-V en el cual se ha creado una máquina virtual para comprobar el funcionamiento.

![](https://lh6.googleusercontent.com/tD1fJdgXSRW7QkMIT89g9ce9y9Wd6yjRm4b2AXQp6NNrw4WL46IhstfU3YyCyEppILt8E4Y9h3aJ8ZI3AMkEqIvMHJbVKrZfb6cYanwiTXwv9MMt3q3MqlTc7_XcY5fQFGvHNV83)

En esta imagen podemos ver como en efecto es posible virtualizar equipos comprobando así el funcionamiento de Hyper-V.

  

![](https://lh4.googleusercontent.com/Ej8HlxyNkOdAEoC-IREe-dqT3sX6dQXdP2If7EzGPvGwJdbfsFIMrokTqN_KIXdq0c1HhnVl0m2jNSVRkC5-Ls0VvRnOkkzwTzePP2p4G2LIRYerFY5af9db68ddux0Pc9SEc-Zz)

  
  
  
  

### IIS.

Para instalar IIS hacemos uso nuevamente del wizard para la instalación de roles y características. En la sección de roles seleccionamos la opción del rol de IIS.

  

![](https://lh4.googleusercontent.com/McrkDeRHOrGMHg_Wk8CgTCIuwLEoRYW4ue-ILIpHFmgdfVmgOsQTpZ0dib8QGPj5tL6WdbrfVBv5Oxx7wpBEurJ32Q70yjujNFPavWVPlNfY10MdecBdmUQLyGGHWNCE7qjnsYhD)

Nos muestra las características que son necesarias y permitimos su instalación.

![](https://lh5.googleusercontent.com/3wNruxnOw2qd0uFHDvVpnHlqhSpKlz-FeMvOyxX1tGuYSoF31WHV3g1ZHp4PelfPeobSpc2nQHRsbR3kVqYglH1z1uXrzILBninjPO9Z2YNw4e5XpEIpkW2xJVqeayIsoEUzHNMp)

Nos muestra una breve descripción del servicio de IIS.

![](https://lh4.googleusercontent.com/KJEPkRlgvGXefs2jQCxNM-4sSDIQ6QsMPaA2Fb1Hgs7s48jnwaHL6FkdMhUOm2WJrhaNKZmYpyqPmAtS6UDIltz76EdjjcFc7KGOYvG_b5sW11ftyBEm7k4xlUCahGoPQv7lOoOL)

Después podemos seleccionar los roles para el servicio de IIS que sean necesarios para su funcionamiento.

![](https://lh6.googleusercontent.com/qugYqyIOtpaj0Fgc0z-edNDoGWO4Xpz_r3F7yW4dIGo0lHfAxRPbfwkFVkOCEgGOZo_3HBRxavCsJEJ5bq-q3MT5I5u18oEwIKKcfvyWW0bZ115GuaGe_PBppHWOLs7wxKzNxES6)

  

Después de seleccionar los roles nos muestra la pantalla para confirmar e instalar.

![](https://lh4.googleusercontent.com/8hPWwwU3r7JLT3hDO9ZgvqaI_9Qq6xpc3IMnF06khX9lCYuY1rNWUwjCZpGBl78ugeR4-uf8A7wLsz2NLQFfWbSUmeoDbM1v_Pt9tevqZ2prFQyBru9ZUWHaKmThoeGL2_yvg6TC)

Este servicio no requiere de reinicio así que podemos comprobar su funcionamiento accediendo a la página principal de IIS mediante un navegador web y accediendo al localhost.

![](https://lh3.googleusercontent.com/YDHvQp1QaMMDK-qeyMGnIWhMrnC46Sy34-BaGTPMqWYLoOR-nqTSC9QxAsLhLUzbz6eMUWX7luUhmlvCLTgFOc05kbpCsaF9yOx5y25BWUSyRvl3gOjwitG-m3l7Lc8fAuWLHAZe)

  

### Active Directory.

Antes de realizar la instalación de Active Directory es necesario configurar una IP estática al servidor que esté en el rango de los demás servidores, además de asignarle un nombre para su identificación.

![](https://lh4.googleusercontent.com/rTJUeB5wZbGJq_WnIZb7VWLBoebfX5uBpeWnnCTrV8GJADzp9n0BMwooBD4ibls1rk4C1x3QTa40KpCPqYse7Yj4M7AG2JdlJpLbHun_LYaTQyg-z6WapMHtCV4bbkQo3oQv5d87)

Una vez configurado estos detalles volvemos a usar el Server Manager para realizar la instalación de Active Directory Domain Services.

![](https://lh4.googleusercontent.com/toIVYgQb4HfjCK3S2Uhm1qT5heUbiDgJ6ZJmCn0s2AREFh50Fw0KwsdHy5F8ekXwnavbDkOFqAKn4Hdfbdwj9TBgh0TitHJGW-FohBy6zZtT0UL-pMnzxjWl8qUmKvmPzOEXj2CO)

  

Una vez seleccionado el rol nos muestra que las siguientes características serán instaladas conjuntamente con este servicio.

![](https://lh6.googleusercontent.com/ejyRvXYgWvZZGr4izoNKWJG8oqeOrlQanlvPwEftxrCtgzx-pHL9e5J5JaLZDEFakqQsl68RtdUS5ayasF1tlTLFXh5BUsssJhXRm_sDx3lEZPYRRYooslDFnsPoepibL3DLt4BA)

Posteriormente se puede observar una breve descripción del rol de Active Directory, continuamos con la instalación.

![](https://lh3.googleusercontent.com/O7q4CaEOM8JfNOLI0CsP-wQPkvjEAyVBRsWLjyKktdTzEA5CmtgjZDcd7-EF8iTvVRR2WOcLN0qru5rbCFs3MVnc9z_cy9Eopbjh-8wb6VtlkhyR8gR3AHwQ12R1Sln0rlK5Eab6)

  
  
  

En la siguiente pantalla se muestra la confirmación de lo que se instalará.

![](https://lh6.googleusercontent.com/JOJ5T7VHCD4lZ-f2ZEqFrfrf8nD54Hej5mTd7yldfbFbg_QTJqtZH8o7pQd1zuBdJ9406TW68Wn5BtqD1tn3-78-ldcZleLo_n4pbxXnqF-9RqBJ96CPjaFJCuZN3QY7ALPFBNRw)

  

Una vez terminado necesitamos de promover el servidor a controlador.

![](https://lh4.googleusercontent.com/DliWtT_59W3QP31gbG0PqFr8emaR0OcE-M4NWIkiT_8OGOAoQQo6GtuyODhFQ2y5NfoA8R8PBktbNOSCtmLQ_emCPck7gI2dvnDgBthWlZTl7CBcLbWkrUpvakGq-oH6g4S5oZVS)

  
  
  
  

Seleccionamos que será un nuevo árbol el que se creara y especificamos el dominio que es aafa.local

![](https://lh5.googleusercontent.com/EtbGmxkMsnTiT0ZXzDtKHTt4AyV23d7kOQWybr77JYTZGoDv5SqzXHimxZq3v3g3jjyzbpLPvHekYvlGu5MtXoFzgpXNBNJ6irGwlQd6B_oFk0spJUu5YnQka9X9rv0j3KS2s7Oh)

Configuramos el nivel de funciones que alcanzará el servidor así como una contraseña.

![](https://lh6.googleusercontent.com/uZtpUXn40jcl2Qp0_RpDWt13DNgCj5Wv0xwRNmsGrmrSW5GGRtW-zfldLWv3L374HqnJyfR18bZnxpP_T67eYqrRYc5FFm74W85IemPK6mYOL_miN61dgCWrg6-qLUMMSRJV3O4o)

  

También definimos el nombre del NetBIOS como AAFA.

![](https://lh3.googleusercontent.com/9Y0V-Rz5AtiIn9Cdj2viaftnSfD7LjB_6ALGh2MlX4deLSD5oT6MIcnEeyiQJi_U0QuBHZMI0bXZhZmJi5dd50PtA3NdTu_-IEN2Uh4lOpowm_36D0dZFXe-vGY9clgIyXgfIHW8)

Posteriormente configuramos la ubicación de las bases de datos de la que hace uso Active Directory.

![](https://lh4.googleusercontent.com/NIVkTpmYz0fKlux2-OR31bgxxaEMtvVEygWondAnJNJziqoosv7l4TA4BV471NIJ_dvkDGsTWeWFziT0zd-scnwGcY4WMHkYrBMA3ziZXVIeyws-TLQDbSqjOheeB1VAJ_OtzR3A)

  

Se muestra un resumen de lo que anteriormente se acaba de instalar para confirmar.

![](https://lh3.googleusercontent.com/ki_HqXTVvZpSoj_Es8WUjBoI-7iG0sM5IE-G2lIv1exjIHlQwbrw3EUetTqcZrb2PTGbyASoH5VQUYsUxZ5WZsHIAnIvCFIQm4fNLUveFtUHkfMF8caoRNBAN84Bq-pF-xnDIaok)

Y se realiza una revisión de los prerrequisitos para promover al equipo a control.

![](https://lh3.googleusercontent.com/b_Z31hRR8q-0gNtrrZ87V3jQw5VV4maZGZCjy9HuqPSpcTsnmeT7E86tVnAjnErB5RSzoENOZb4_NXaIXglp3Kx-K55a-aR8VRALbTs7Q0tzFlqAAOLZHPSV_mlBPFgyV6twhi8y)

Una vez pasada la verificación se puede instalar, en este caso es necesario reiniciar el equipo. Cuando el equipo termina de reiniciar se puede comprobar que el Active Directory ya está trabajando.

  

![](https://lh3.googleusercontent.com/tRY1Yi6zqiOD2O5Ux3K40l5gqyQRbpmwLGI9EMZJZbjRonnsZT1ksXg0_SLZ5K5b-OKjDW039EiLooEf2_-zTiWz0Q-YqaQYfqZk3QZHV7zYPw5Y7by7kFISWFP-kzcRqKx-sskF)

### DNS.

Al igual que en el servidor de Windows anterior, en este caso se debe fijar una dirección IPv4 estática, en este caso se fijó la dirección 10.10.10.6, y formar parte del dominio de Active Directory configurado anteriormente.

Una vez que se realiza lo anterior, procedemos a agregar un nuevo rol a través de Manage > Add Roles and Features.

![](https://lh6.googleusercontent.com/u4bn_VmFVucAgfD19JS0nTnUDG3mC88wmdMjndiLvsQh8m23sNcFPgpIKfkzqJTqEyPdNtureena-GGUO4gK0AQ3Ui0uZU3yfUQjsbKelebqj1DdYZ-SETg41Ys_aQlNCoc9FJwl)

  
  

En la nueva ventana indicamos la opción Role-based or feature-based installation.

![](https://lh6.googleusercontent.com/ueJjz9-Xxjgq6XPAvxV1RK6zBpfTdXSA2agnydpE23eeK5f47h6-cvda0doxSeNncLEecdRcAaKEMqCeGdYt7C1yZnFoSIyrlQICeaY9wjQTSIOiCu1k7L_zNcsn2gq-TFRGf1Kt)

Posteriormente seleccionamos nuestro servidor en el cual se realizará la instalación.

![](https://lh6.googleusercontent.com/KN6Kx-jjna8ZfbsyPscnao704Fa3jDbPrjKRX5WNBP5EEOWkrgIHr0o122VHc2xlfljmPa7J4tywjHJ6OEFzKWJNuZ_YX8uC5z3Y27ayi3NbCtoX49fdtz0zMbFr4QCF2DhlVuuz)

  
  

En la siguiente pantalla seleccionamos el rol DNS Server.

![](https://lh3.googleusercontent.com/Fa9UcwUShxj3faPiXXvS_Ccq3qWeDjfzM0bqJZO4exWBly2fbatIQyyO36ehj2N_C0ak-W3GzXpGXIRf_GCc4OOsPWDG4aI3ij35G9slobXANuYgapp8Ww085oimfTSSk7ubFjyh)

Se abrirá una pequeña ventana en la cual confirmaremos que deseamos agregar las características requeridas del rol.

![](https://lh6.googleusercontent.com/nAN3x-wx8Glzx7Y_Wvm-_mTKErztVXUX2q7OP1TYsRwlhfX8FlP7-4K2KYMq1SPxYbZk0ieY9F0ob9ZSRV_VpPn20hhwEyEjZRGciXPVS46kHfOgj6ja-IlFUqt_FWDyRgBC_Igv)

Al cerrar la ventana el rol de DNS Server se mostrará seleccionado por lo que deberemos hacer click en Next.

![](https://lh6.googleusercontent.com/OLLuCRdaM9LHoDVJvaCjEDa61FmZZO1CHHSsePeV-jRbUweNsk1ysZl_ipJE4wllcf00I9l60xtzdSVsZVhZj8Gq0kncoUmD620eElaMF2-zdFzPu-ASCzlS6f2xlkvNoBo8zIcS)

En la siguiente pantalla dejamos tal cual las opciones seleccionadas de forma predeterminada y simplemente hacemos click en Next.

![](https://lh4.googleusercontent.com/SaE6mFdv9uWNmsxp1jMFuV5m2BPje0zV3Y4EZdO3SVaJZ-Gd-VowQn6TyqY77Krv1dzoQfy2iATsDR8tiY5KnKqGqF4q01Cp6kflwjkjaVLkdfBCcFFX2y5-G8wuZADR6HXKkjIn)

En la siguiente pantalla se mostrará una explicación del servicio que proporciona el nuevo rol, así como una serie de notas a tomar en consideración.

![](https://lh5.googleusercontent.com/o5xHh6Y9_olizyd5mjnvEUnKYFKU8c-MMRElwYVi387Iw7SUOPo1eZkrMsU0MZ88ZkAJhj3F9AgHLzURRR_xoF4HTJXSj7ppl8Gm864PJxXn1jOrP_TOhIBnmaXksAPEGu1HtvoB)

Finalmente hacemos click en Install.

![](https://lh6.googleusercontent.com/soWS6pZzd5GIIdpqX0r9607TvSobKutOmeMqd8mBZEgVKSOS49ojxKRW7mvMwkXvKmRnxy4OFYiiXW3T82ZWVe8HNdNCeTv8ZAylMmnqie_3NUZBrW8pOfzupxCypxMdf297JLmz)

  

Esperamos a que el proceso de instalación termine para cerrar la venta.

![](https://lh6.googleusercontent.com/7YPLaBOIH3vPuVaKtJkB306QJe5N5Fmryid91QjCHHRtZmu6KaJamPasdFS6rmgrPsBHEFtD83hwGWtrsBNMFLCKSaginsYfRED23VJRSmdau6vjEjtXML2n0F4PZr0_QWA3QIR5)

Lo siguiente a realizar consiste en crear una nueva zona DNS, así como registros A y PTR asociados a equipos que deseemos administrar. Para ello nos dirigimos a la opción Tools > DNS ubicada en la ventana de Server Manager.

![](https://lh6.googleusercontent.com/A-3d4nw6ZDzbBhAyQoUVniG9bGqFApo8pCtDH4eS3T-4bEtukBRA4zU7QRBrgT0xVYaTy1ljJXwIFbzM68xe2bfd-6tHyxN1DzskzmutV36exnuJ1cL3L8PwexBw9yhXIK30WjVc)

  
  
  
  

En la nueva ventana, dentro del panel izquierdo hacemos click secundario sobre la instancia de nuestro servidor y seleccionamos la opción New Zone…

![](https://lh5.googleusercontent.com/eeCgbNKW2gXDAZSTgTkrJPt_5W_W2mMW9p5bK2JIwIKEmKbBXbpAPndQNZopenhaTyJCEgQDyzvbRp3AacdXi67ZOe2-bLjTuamIsiauDjxuJhRPHMZQJRAjBmwF9HQKKKDOhwxL)

Se abrirá una nueva ventana en la cual simplemente hacemos click en Next.

![](https://lh5.googleusercontent.com/F5k1zbOkRFXj2LxzpJpuH3kzzSNvJf07kQljxKn3qhXyDKyg3ozP6DddlQnH2IhnUHATp2aB941y4pKGtCOauVMxOy9wKS_EVvBSFpzmqvOnHifLlP8-95cIEFXesYP1bHC7aB6m)

  

Ahora seleccionamos la opción Primary zone para la creación de una nueva zona primaria.

![](https://lh6.googleusercontent.com/la9Xcv27SiNTiQ7JpwmuPdCzCtjJwLxNRjkUCi3rWM8ILKyDtzFFoB06q0lXf6Ba01jmwbhzMFChbIC-gABewZGx8O3A9y1Oc1EPcihmtVXWXd75C6WtLG0uWKZsyeaexFSe7jln)

En la siguiente ventana seleccionamos el tipo de zona Forward lookup zone para la traducción de nombres de dominio a direcciones IPv4.

![](https://lh5.googleusercontent.com/pUOc3t7x2S-LX7rDQWDUKwNECnPcSaXCid7RgXx4SOS488eRq8shnn4PFvQJ4JpEz8UuiWChoJklbfc1LeOmS1hvDX4iUOOZX1bxTlWG_Z_M8QdS7_Dh-zXEmJh2LvAUFsYtCkxH)

Lo siguiente es indicar el nombre de la zona a configurar, en este caso indicamos aafa.local el cual corresponde a nuestro nombre de dominio.

![](https://lh3.googleusercontent.com/wyb5MhMLLFfodbk3tanSpUjuf28EuDCu0V6JgPwkj1rVFg8kfCFK7v9VptT08ZImyvuvxyHshIwVCvtkee-Bime-nIFpvmjkSyAD2_J9RNoWDNUvp7kLb7Oo31lGRwm2KT9EFxlU)

Posteriormente indicamos un nombre de archivo a generar, en nuestro caso dejamos el que se genera de forma automática.

![](https://lh4.googleusercontent.com/k8NLB1xNp3LkPc_KIwaQ66b72M3tKsIDAhOQxVLuiws1CKAxij8pybU1JdPTWxk9sJYrPlJErp0ZAIvM6zMpyQxQXR7Hfiu6z4ufpEceXAKn_n4FoP5dDvpcrPdfFTBbJ9TU9jcd)

Luego indicamos que no permitiremos las actualizaciones dinámicas.

![](https://lh3.googleusercontent.com/WSEmV1S1Beo4x3Pr84kOYxBE3Dmam-Lgo-cY3NL_9P77bbNTisKtX_EDFv9ahFQQ3s16CqWBNmgXkmMo4AX3CqziTTdDjZ7wITpH5clHo44unm4wg5iKFH6ez0kIWExCoR0yVviX)

  

Terminamos con la creación de la zona.

  

![](https://lh6.googleusercontent.com/eklURWC-k2JqqkfyI1MukiXXOkvNBKrKlgNoo7_naRP6Z5Gi6Ygln4yfpGo8N9ppyaV2jBS0atAuDu9POdLh5LcHf6jfxDQvFWI01PmcN11OCiCIZLWonzPfSihQq4bfI8UUEPE6)

Ahora deberemos repetir el proceso de creación de zona pero para esta nueva zona seleccionamos el tipo Reverse lookup zone.

![](https://lh4.googleusercontent.com/NeTPPAQzr9TWcNW24_a6GMJd0E8tulWoCR_NF5upurM33IpDqC2ZHWT909D5t3IOhuPKQD5-WYX_0eoH09VKROo7b9beUlE_Gc-DMmEGEZD5B_Esai_xlDz-zwF0x-kZYxbszaK7)

Indicamos que se trata de una zona para IPv4.

![](https://lh4.googleusercontent.com/DUqU8sp_WgiwECXZqqLEDI0s7v_s_00SQYrlJuglBZQZZB5oFcl9Ev1uVETe7MAt4VE12eRF5PQI8XrDH-WfvkZgsbvlzwdW2VnEJZzCHJ1PYzyu9gi0BPVeAVchDMelZPMoSLAt)

Ahora indicamos el identificador de nuestra red.

![](https://lh5.googleusercontent.com/LocnXIPGsuzAKEJEcs7eNdtmNiPa5JT6Oiy0QBlv85eutVopLq9ZR4kUWuSI20OjRnk6Bd4wQWSzNRBcA65WN-XtnG4qLFjdGOzgxIBANFX6XqHbahmRH-3_VOak_Q5H3si2g7AD)

Y establecemos el nombre de archivo a utilizar, en este caso dejamos el valor por defecto.

![](https://lh5.googleusercontent.com/7RXg6vdp3nkCZz_usFbpawKMzgPfu56YznR-iDGCJuLP2wxYIqxYJgl2azq33iSPiSLWQo2O6kWLAuyChtNVqfEmKx0pj4Q_8FrEqkBiBV54-MomvS3cB0azEo-cPVnHDC-Uh17F)

  

Igualmente indicamos que no permitiremos actualizaciones dinámicas.

![](https://lh5.googleusercontent.com/IRc44povAbzMF7gMnxnPx5pcuFmD94ff08DZowfTPz613Oj7gqDZVWsQIaXCl00GhCrcpFh-G7rJvfqAe5ytkPIb_Ljpu136LA1Y0x27Nvo_qH8uq6x2zvEtzmdn1ZHWpVBzlNns)

Finalmente terminamos con la creación de zonas.

![](https://lh4.googleusercontent.com/AVeGP-SUaeOJv-8aBYObLeyemix9ewrpAySF1RD40SB-zGr8-bKcTuCno_cAw8zfwYL4LJVg-lslGB5sdMcMF6j2Y3rNLgHdC62o8K7amy33-XB4Io_Xqc6HKwGuLTN7E2E0jBRX)

Lo siguiente será crear registros A y PTR asociados a cada equipo que deseemos administrar. Para ello seleccionamos nuestra nueva zona aafa.local y hacemos clic secundario sobre ella. Dentro de las opciones desplegadas seleccionamos la opción New Host (A or AAAA)...

![](https://lh4.googleusercontent.com/zYuRPVekTj9rXePc4PME0NZcSVSHzxIYJjHklwGp1jTn2hU-vTZmQynr-GJR-cz8OVMq8aAf1NMo5QjDidgd3QJ7932OTgb-ps7RHhyHQBiGYZ7yxDzaRZWjPxWTrJ6QKCXj_12r)

En la nueva venta deberemos indicar el nombre y dirección IPv4 del equipo que deseamos identificar. Adicionalmente marcamos la opción Create associated point (PTR) record para que se genere un nuevo registro PTR dentro de nuestra Reverse lookup zone.

![](https://lh6.googleusercontent.com/tKh1Tw3IKFZu4Mul0qjxCG3_-cFpI2Uzhq_vCn2LGcSrW3sgWFkazGfS568x2voecT8i4O4CIYnsjLv337KRF5oMvfFYSImkuRzFkhq0tmFVBCnJtypO02lnx9wIcLgYrQWzVAjo)

Hacemos click Add Host. Se mostrará un mensaje indicando que el registro asociado al equipo ha sido creado de forma exitosa.

![](https://lh3.googleusercontent.com/-PHGF4waj3MaSCiCSGh4hP1yXeIb8mRX7a-l9YlqHrNsC0U5ORKnFRhIMB1w5bRAFGTNxBhKvtm7j-GG97SXKmFFUopMIsZO7PS57tw-meBg_aBAz8cy0f8clIYOgRUsL890WILo)

Ahora verificamos que nuestro registro se encuentra en nuestra Forward lookup zone.

![](https://lh6.googleusercontent.com/ukoZETw-5tbvOTKmqdkjOwj2y7vWeWxKpG2x4P5g1VJRb8yCoZQsoLjVrkNbzUfd1W1IMQB0TKtsenxpBqPj35MGvKp1hqvRwY8WcWdxL2l-UkQaM3OBMlK5S0R_f3LYoEqQRoAZ)

Y finalmente verificamos que también se encuentra el registro PTR en nuestra Reverse lookup zone.

![](https://lh3.googleusercontent.com/Sf8GgYzqJaglvO1q3Lgi49nztspAfPkqvot8iOUAbUMd1SQztgmC-EMFTVrwe7Q20IG4lY21Ag_eoKfwRiySXlfMmXrKOhD-Sysbi8UNUk7hrIEkdYFg2U8SuBBH1XPuIdsdLP6b)

#### Habilitación de logs

Para habilitar los logs del DNS debemos ir al Server Manager > Tools y seleccionar el DNS

![](https://lh3.googleusercontent.com/uEW0KxJNB2bD67uBHA9FPbmHSXapJCsmbn0Q8r4X3Q4oxgg23_LrU3bd1GfxMT7fm18dmwaYBV0QVyiDMcM37Vf4JrqgcMQ8fJ9mgjK6lmJ0DiMaKncauq85p88tbe3YC0l_tf4i)

Una vez abierto seleccionamos el DNS al que queremos habilitar los logs y vamos a propiedades

![](https://lh4.googleusercontent.com/xjn_hSaKhwILGAkv6EwuMVERj4aOVK-W8azp0xU1iR_8KC5P15MmShQno-eD05KWDd-yQHk-VmmsBlDzxy6GZuDDThz5Ehal-TliqDaUJoxY1z4Upu71UXlIaNYlNN-g73eKmVJu)

Ahora vamos a la pestaña de Debug Logging y seleccionamos los eventos que deseamos mandar a un log junto con una ruta del archivo

![](https://lh5.googleusercontent.com/e18LzstXm0xflpfcspNRkUGicgI06_ca1Z6S31Ih3xBizIZ5tCxauaqI86_QU4lPr5AbI7R_bitF7LWE0MTHtPW1f1qgTTpGKOFpjnSpoujNhuU03cNRKialszC7iTxJc8AxwQGF)

Después de reiniciar el servicio tendremos el archivo de logs.

![](https://lh3.googleusercontent.com/9vW0xvtERbT_a1Bb_Td9E09rprNV2Brs1pymzXP6UA4lq4tL_hs6I5XYRdQG2mDPh7Zo29euUXscpU1XLyWsz-qJYQdcFJ_hYLSooSuY71EhegZtAPQVG_V3k3LfHHPKR3II33xA)

### DHCP.

La instalación del servidor DHCP se realizó sobre el mismo servidor DNS de modo que no se requirió alguna configuración previa.

Procedemos a agregar un nuevo rol en el servidor

![](https://lh6.googleusercontent.com/u4bn_VmFVucAgfD19JS0nTnUDG3mC88wmdMjndiLvsQh8m23sNcFPgpIKfkzqJTqEyPdNtureena-GGUO4gK0AQ3Ui0uZU3yfUQjsbKelebqj1DdYZ-SETg41Ys_aQlNCoc9FJwl)

Al igual que en el servicio de DNS, sobre la nueva ventana avanzamos la pantalla inicial, indicamos una instalación basada en rol y seleccionamos nuestro servidor actual dentro de la pool.

Posteriormente seleccionamos el rol de DHCP dentro de los roles disponibles.

![](https://lh3.googleusercontent.com/rBl_KEufuSNI4qr4UpHm__Z-Yx7_dnlrmj1AnYTnnrzdgbUhwUw_Mw6W9R_WQKb2mLTAO3-O5Lxn2QmtkChW3MPlcTB35T6NA-Zx-FwIVzvVPyc7m9ilSIAoRkkEoNTnpIwX7Bb8)

  
  
  

En la nueva ventana confirmamos que deseamos instalar las características requeridas.

![](https://lh6.googleusercontent.com/JP8zcmK_H1-ENPAvOuolAgMQKb2ydSmOaw-xwLY8sQZco-Tw15SQjuIN9b81c_t4UmzWtkdwiqnbuzYJx__NHxjAJldhqb9x9K3PM6grzDQ578KPgRmKj-nBl-vwwUl7CHMqgg83)

Al cerrarse la ventana se mostrará el rol de DHCP seleccionado.

![](https://lh4.googleusercontent.com/Ytx3RAA2zxNLixuJKjGlFO-xkFF7V_U4ceznZh4qNBi_5uiwsqdWadsbkt92IbdCN8GnQLxFCrE9LBbeqdhPjN7XanWkWpwu_pXoBncJDeUOwuYRUlrdrNaypNNu7NeBysKEPLMj)

En la siguiente pantalla dejamos las opciones por defecto ya que no deseamos agregar características adicionales.

![](https://lh4.googleusercontent.com/TMapaKRZa2ysw461qB7x65Lmw-TXhMeHahumtI02Gd_ysrDrhCz-u_gVmhHn0YVFaXplDBC31M3tqAwh6F2xhdFE3RcnpnPLPWo0_tDzBiJMgspUGuwd-bhidvMWj_y4EW-HtBrU)

Leemos la descripción del servicio, así como las notas a tomar en consideración.

![](https://lh5.googleusercontent.com/O_czz6hucPHb2fujIRLJNg0aZbj_4D7jsHATSdcVGcDq5XS8xYpkwstLZSXuFM8_kN7KX0Sr-WSddQrUvIdl66p_EbKTEqaa7br_LeQxjYLp07Ed71XakzqbJKc7dlTmjiNHuJDN)

  

Confirmamos la instalación del servicio.

![](https://lh4.googleusercontent.com/QbrfxAVtjsjyTRGRy2aJQIhNdUJCdA-NyO3Lr-3ff4zWG2mWsTDotHPwnKHd9NUZ74oiCm1OvU_H71rhqKnDKhnRerw9jOI0VZyuWrfooh9dervV2PtdH3G3hC8Wa5RgqjpBsLeL)

Una vez que la instalación haya terminado podemos cerrar la ventana de instalación.

![](https://lh3.googleusercontent.com/nMCITnCz9rYKFF4bRYbzapH3bjj4aGZlgnXziMochYqOPJQJDQx2IQw-S9hVDg_kh4Juk0eXI4ZvoU-xuUeWi5Mb4uq5G62-oFSxDKtAFFCgJN8wPN8yG4TROeSxQtoZxztFu2KR)

Una vez realizada la instalación procedemos a realizar la configuración post-despliegue. Para ello hacemos click sobre el ícono de la bandera amarilla dentro de nuestro Server Manager y seleccionamos la opción Complete DHCP configuration.

![](https://lh6.googleusercontent.com/or_tEoGzuohjpc1gUnBU2H8zJaW2UyRcyOi6AmJyzESmmhikM_KTovF0J3UIF8wFDxFBrTEY-7ALo-umeVYinhoRUR4ZUDNH1pMjstx6AF8pk3S1WonWZB6IBCEh3lm2d_Qoxqs1)

En la nueva ventana se mostrará una descripción del proceso de configuración, simplemente hacemos click en Next.

![](https://lh6.googleusercontent.com/Y6tmMnchqxsySfw2S9PYbUezykVfhUfWZSdJThCcoOff7B3G9GGVmW17BwwFUsACLtruxPdLrpRUWfx_N9XGMitoTzriSnVTdLIMHWtzyT5AJfnQfOpPAbYUJ82CAQmrP_M2B-Ak)

En la siguiente pantalla se pedirán las credenciales para la autorización del servidor DHCP dentro de Active Directory. En nuestro caso indicamos al usuario AAFA\Administrator y hacemos click en Commit.

![](https://lh4.googleusercontent.com/PPPY6nF9JjOxC-VSDcPDym7CGGxleO6SByEZX4PKBx2tU8k8oJWu6O4d_TD-9QG1rMWIpeqZDEsq4yRN9hxbnEzkyYoIpPSvQwNb1BdyWPHkm_VBQnaaSLp7ZuJb8C4uqzpxs6He)

Esperamos a que la autorización se lleve a cabo y cerramos la ventana.

![](https://lh3.googleusercontent.com/JVw1He9_RfZI_Q3FBULyNFoObsDO3KJBGmqXzPyUs1xwCtKLBATs7EFxx5C0XVL90e-zfHnLgIcclZna8_lI1Fl4hej5WRFfQAWFvzYtofvkgCvBoXnd4Ok2DIov1sWSoyd50qzS)

Ahora procedemos a crear una nueva pool de direcciones IPv4 a asignar por nuestro servicio de DHCP. Para ello nos dirigimos a nuestro Server Manager y hacemos click en la opción Tools > DHCP.

![](https://lh6.googleusercontent.com/RSBQyUe1JX1qSfP0XdajKFUlDVYxiFmOnpNWLkB8d3QaEDstuh5TxccpyvtCEBEj1Yf5tOuS1o1zENxPQIcYIlfgFAjeACfy3ccbugW0WYvbxCf_hXOPTsYCyvYkkkvlzJa1hyGC)

En la nueva ventana desplegamos las opciones del panel izquierdo y hacemos click secundario sobre el ícono de IPv4. Dentro del menú desplegable seleccionamos la opción New Scope...

![](https://lh4.googleusercontent.com/HOkQ7oNlJjZaXYN_x7PjKuRvKXuUJrVhFmjmkVRVkWPKN1ZhFAjoQajCi1IeFeHs-pdeAVtZiICWLSrSdDYHGV9UN1Vcv4SiEepTOMoRDZ99caVzx_5Kk4Pa3P2TCj_D8CN6b3KB)

En la nueva ventana hacemos click en Next.

![](https://lh4.googleusercontent.com/aP9vpN_Z5SzKPF7JbRH3tQk6GSgrJWY3Wh5HyFDe2JfSneNABA-bpTOrggx-eS7pKc75cH6T6uRzZTuZy8bC0qt3bNeoYcOrGhJXT5ay6rz3gtJr9BqC-KOKgBIpWG45NG6MrhCx)

Ahora debemos ingresar el nombre y descripción de nuestro nuevo scope.

![](https://lh6.googleusercontent.com/eWdbPJAnjrIwivCDBkIJSZ8Ww47RrbZSsTlzwQYMzP9BH5OST0iCkuB2Uk4MXZYadTCKWDste9WgAG9ZEvM0YCFnwrcY0ke8bUxeCNiOgcC6TCftnSPjXY2FIHYx9Di-Ny6oQ2Ko)

Luego debemos ingresar el rango de direcciones IPv4 a asignar, así como la máscara de red a utilizar.

![](https://lh4.googleusercontent.com/6f24BpjwFf-_rhZrg7yZhxab0fWPG5dPdiRRA1KqY_GzFP1uvRx169urYPkrYD7fCM_jeOGGecS5_8igceiKQnR9SVllS_XHSVhcuENjCcmMdU48pdTWfWdvkNuP-qbgnSnveGO1)

Posteriormente podemos agregar un conjunto de direcciones IPv4 que deseamos excluir de forma que estas no sean asignadas. En nuestro caso excluimos las direcciones IPv4 del rango 10.10.10.5-10.10.10.31, las cuales están asociadas a los servicios de Windows y Linux establecidos en el proyecto.

![](https://lh3.googleusercontent.com/JERTAI5MRbpPeeglbYv9hgcRLY_H-iEnrHUqXt9zum7Y6WHwI3MAWxBmkClW99ZLUoYI9gG1BwQXm6SperLkBgTgY5pIomdNE6OphVXq-dWHmFn4sfh91_8BbUYRYcnalVRyUcnO)

En la siguiente pantalla establecemos el tiempo en el que un equipo puede hacer uso de una dirección IP.

![](https://lh3.googleusercontent.com/jV-ETSJQ5zQwRPmSAAy2OGv01WHCxL3AgamHMjPYfdgthr32CKTcyvPj-hIme7iX4MY_DM6kzdaX7kZdV023tNCJZZYRqa8D3qAPzmgYYV1TeWqqbqhe3wtbaFaPqAhWCZLYgCrW)

En la siguiente pantalla se pregunta si se desea realizar la configuración de la dirección del Gateway, DNS y WINS provista a los clientes por el servicio de DHCP; indicamos que sí deseamos configurarlo en este momento.

![](https://lh6.googleusercontent.com/-X6hTEovZciDKYjWq2AkvFUipwR2zP9dk4GvxNLUB4rcbgQvxYCHZOj1gTJTuSRF2l69s89M79MFdGZFBSiUuj5whQZpaaTQFl8113w2NrqFBJfsDFep9pj2PzwZXmtj0roRwI6M)

Se nos pedirá ingresar las direcciones del Gateway. En nuestro caso sólo es la dirección 10.10.10.1.

![](https://lh4.googleusercontent.com/W7PUFRtiDrDxsp5qHIfPZXchzNqoVq6v-RIvyVDFzl5tQa69Jp-z3JVh5lmso3eiSpDXBZPIP9V8Xbsy8AK7-HL6jaR9Ykf4DPSfghY1ave_hCZkFzMgCtuf55lTz1MIWvCEmzMV)

Posteriormente se podrán ingresar las direcciones y nombres de los servidores DNS disponibles para el rango de direcciones de nuestro scope.

![](https://lh6.googleusercontent.com/QbFTrdnLR1fKl3IxPSxOiNQBELbTUE43rfzbe48diNGjfyTl2EIPvtX9Nk-pNQTnFFC-Bm-95TBEXbwawP7Guseog8cHGZckOnUlbWesyNH3qZF_vPMNmCYoL6mYI8vncaiyLzCh)

Adicionalmente podemos establecer direcciones IP y nombres de servidores WINS para la traducción de NetBIOS a direcciones IP. En nuestro caso lo dejamos en blanco.

![](https://lh6.googleusercontent.com/37ESIoD4sBBtC65jrb5CKk-ldYU0J74Lb1EzrhszWUhs05CopRWX1z6KbCaxoLZ9jmTGJbjaE4hC0Z9KFHIDsEk4h3qS19DF5OsLT85rmIyAbzKmeIGFAJlh6XkSQ-J14GUQ_1vX)

Luego indicamos que deseamos activar el nuevo scope en este momento.

![](https://lh6.googleusercontent.com/zGbECgnpTH5gN4rFVO3ZqqPr3lxKUM2Ss2L605eG9eRAaVLPt3E-QhMLezdxvBpODrXv0McjXcEHt9GOlOJBO7zGvCwO9xIBREWXjGb8S3XngwS4atA4Vlkh3u_E4NPKEA1s_6oC)

Finalmente cerramos la ventana de configuración.

![](https://lh3.googleusercontent.com/ErIMM6DBg9wOw6o5845GAS8eV8pJZ-rZo41cA9xn1V-IubUoLA-80ojY5Uih6b8_Fe5GWg-LwQUXTSi4B5HIOWehTZ5aNS6vbZGYg4ddIZoQJujiJDTyOYCehk7UmRzRcv-5RzCU)

Como se puede observar, nuestro scope ya se encuentra listado en la sección de IPv4.

![](https://lh3.googleusercontent.com/4m_EQQ4OHALJ8nhp4IG2F3pVoqMmnHjMlReRiRrkVdlmX5IJRP8lS3wJxmZvrXdiqvA7R0RBsr28YcGwTq7qruFLHaA0E9N-t6enTlF65CUKcohuJ8g8k4fi97UZIk8G49t-yTgY)

Habilitar logs

Especificamos la ruta para la generación de logs. Además como powershell advierte, se debe reiniciar el servidor para que los cambios tomen efecto

  

![](https://lh6.googleusercontent.com/LsT3TSa-jzxPKiLYhlZmgYYn9pOairIslKEzPj-F_VzOhKAFbgzroIxAjkkH70AYO5eyQ7HZ49XNX43e3ptyF8u-sfJ52RSmFAidO_BUEZHPzjZALyd1lvHHEzf-nH50M00BQFPX)

  
  

### SQL Server.

La instalación de SQL Server 2019 se llevó a cabo en el mismo servidor utilizado para el servicio de DHCP y DNS. En este caso se instaló la versión Express, la cual puede ser descargada en el siguiente enlace: [SQL Server Downloads | Microsoft](https://www.microsoft.com/en-us/sql-server/sql-server-downloads)

![](https://lh5.googleusercontent.com/gqN5NGWS7SmTRMA-d83IE9Om7gncquQPWn-0ijMKMXhPXwr8CaqVDzh6MZFhcSSBVM9Sp-t4w0FcijvyraTv_zJjA7jKQP-GhPXJT3rws-FQrRzPwnqaUQ-JtmUcER2Jpnws4C1o)

Una vez descargado el archivo de instalación, procedemos a ejecutarlo con permisos de administrador. Se abrirá una nueva ventana en la cual deberemos seleccionar el tipo de instalación a realizar; en nuestro caso seleccionamos la opción Basic ya que no requerimos algo en específico.

![](https://lh6.googleusercontent.com/6tO2FNAhM5pkbwrMlUzWaP-luy3-W017LHp8lP-ys5Du1VGUbOrAw636kC0BN7o9FcYHUhlOONeBjsBNu8UWbVhUlkOaDEWBn4A1amMQESZV18PC9L791hXJMlhWONcGkEf70H-w)

En caso de que haya algún problema de idioma se mostrará el siguiente cuadro de diálogo. Se deberá indicar que deseamos continuar la instalación en el lenguaje de Inglés.

![](https://lh3.googleusercontent.com/mtmlpP8erC-pG7b6qNSKY4ji39ZnuJLFzCsdIM_oiodAUyu553AEKuHXeW2q4MeDJFCFw-f9vZNOjTQpBq3zkyvXRdIjNADf4QhL1yQvulJZMk-aFBZkCZg64Xfo1_wdTnZmSgnS)

Posteriormente aceptamos los términos de licencia.

![](https://lh3.googleusercontent.com/da6OAF0gPSmT2nfmU5NNNuwbyll0LVqBoRCkmQNxSg_G9tjtL8QbHSvqnZioK-vWw78ZfTlJsAloS8HREg27cfYTkXzSZMjP0j21s9_UttKvjFF99odz7gc-FuxcT2lnJzubRVdn)

En la siguiente pantalla indicamos la ruta de instalación la cual podemos dejar por defecto. Y procedemos a iniciar la instalación del servicio.

![](https://lh5.googleusercontent.com/zn-egQeIGx5pXJX6TdQyVAkfzcwjq1nnOtvDrODFCmnJaI9zsuX53y1tIptfMZ-S7Sn5MBsGtcii0ltLoHKK-DQMlFwwnhsfkxDTkXdr9NjqztEinyxB5On-qT1EfCMM0r8jj9m0)

Una vez que termine la instalación se mostrará la configuración de instalación final. Ahora procedemos a descargar e instalar SQL Server Management Studio (SSMS) 18.7.

![](https://lh3.googleusercontent.com/PfBuIlSKxM2kqA7XWdcgQC178NABVlHTYYqHzKBSf29fNqJRt8S--l8NWHbd6oegLARN_Sr_5gAGTzgbXnGGLImhlf4eJxLJcP0Suen77itEplBOMcPopJYC1WTmoSJyaoe9Raxa)

Se abrirá una ventana del navegador en la cual deberemos hacer click en el enlace de descarga del SSMS.

![](https://lh5.googleusercontent.com/q8LbyBXpMDzlDJkBwhhyW2ZwINu82noBjSca09PeBtCu50clMmIbBf_6daU57UuxrgMATD7wTr1jIMOYcf00CSEJHCHuhxM9qp_W8kOw9lBhXp9KA-YbVzkDQFtiw8rzLUXRQ5aR)

Una vez descargado procederemos a ejecutar el instalador con permisos de administrador. Esto abrirá una nueva ventana en la cual se deberá indicar la ruta de instalación. Posteriormente se inicia la instalación haciendo click en Install.

![](https://lh3.googleusercontent.com/cGoEbGa5kwlcpomL20REOAhvCFIwbaERiOnt8lomC0S9kkxTRgsAlC_61Z4_oEk1qhctfmCYzNvS8k8j_NjpbgUZZse-y_9ijTbvQQaPPtBrqxcNnEsmZt_PIXKO0lAl0NZW-qL-)

Esperamos a que la instalación termine y una vez finalizada, cerramos la ventana de instalación.

![](https://lh3.googleusercontent.com/m0Mo_gblhC-hIKIx2oKbvU3PVXKHVVjcTNe6rrJe9yEGEMUT6ZqxOeS0uiEOnN8CHJZFuPk-6Eosa8QsSV8lTn0pnAuLunKRaEeeAIr4gcRZxjRCHVZECeYcPfK8wvfpLHpKHclU)

Podemos probar la conexión a la instancia de SQL Server a través del comando sqlcmd -S WIN2\SQLEXPRESS -E.

![](https://lh3.googleusercontent.com/SNNLr3d4HhOQp4oVtquGliyDBJd7xSWigrsirB8opML3gCqRirxL9_9XN2ENWRqm7gr7kPDOzw4XyRSloQCwz4t3PleaZtvs9OSOx-cA5EuKUvLvm4wNJSHIZrrAp7AcWIKLJCjD)

Adicionalmente verificamos la conexión a través de SSMS, en el cual deberemos ingresar las credenciales de acceso.

![](https://lh3.googleusercontent.com/H-HeE9ahGL_DnLHjxNM6b5hRtIwdUf0kOIa4zE4SNe87LHVBudIQWrh28TZ1JMb-mzwEMoQgyJJ-fOFPioRVE38BtK3CwitL8FPwzY4RdskYjTFPoqwc24JGqWdU7W_LQq_6_H7-)

En el panel izquierdo podemos observar toda la estructura de la instancia de SQL Server que acabamos de crear, así como las bases de datos asociadas.

![](https://lh4.googleusercontent.com/_-V6jqj3jcpcnF4v_cwiJCEuEX7dwGpKIn7l6AbfkUZrmMw0SyKzLkBCMMc6Mk3BjHMQYXs6SDX1a5qmiqjZ6d3d4zbEilBvtJnGbw37CWYouOBo1VLb6FZu4JZAga94Uq98KseE)

## Linux.

### Correo electrónico.

Se instaló y configuró un servidor de correo electrónico sobre el sistema operativo Debian 10.7.0. Este servidor cuenta con los servicios de correo a través de SMTP, SMTPS, IMAP, IMAPS, POP3 y POP3S. Además, se configuraron e instalaron los servicios de Amavis y Spamassassin para el procesamiento y manejo de spam.

  

#### SMTP, SMTPS

La instalación del servicio comienza con la instalación del paquete postfix.

![](https://lh3.googleusercontent.com/laeSFe0jTZStaoa_X2lXnkmI2edZ6buz1RI2KybbaQlRBYkODFm9HqLOtLPE5y_iZUZkjmbyVyxEDmKbyKOAjl2vlX8ouoyc7Zo-WsZtXpRLnqTeIIbPwzfoTOp1TCntCKvLCp8S)

Se comenzará a realizar la descarga e instalación del servicio. Una vez que comienza el proceso de configuración se mostrará una ventana de configuración del servicio en la cual se solicita el tipo de servicio a utilizar. En nuestro caso seleccionamos la opción Internet Site, la cual permite recibir y enviar correo electrónico a través de SMTP.

![](https://lh6.googleusercontent.com/SoombItAmydNbHDzOadkbnjnBP5GymnxgiWc42cQ7gl7qO3SSULG2mjr3yEZdYP3WQUGum8ZL_OadpE3HDL7nzlu0O4MY7QoD2DTK5rjtu5pVI710mrvdOE2iJB6xOftb_v-gYhx)

En el siguiente cuadro de configuración se deberá ingresar el nombre del servicio de mail a utilizar. Nosotros ingresamos mail.aafa.local.

![](https://lh6.googleusercontent.com/0zpJFxsBMtkTTdblQRtwOph3d5jRu0s9iMLdcH6r-ymv8JkAu8KdHAIU5g9aDMBzMAFLVQxS53BxnBYaP4coLTs0Cgrg0XweQ8hovwZv94IM4l0q_k-oXDJ2KJciM2NNH5DG9rzz)

Una vez realizada la configuración inicial, se deberá realizar una configuración general del servicio de correo.

Antes de realizar la configuración general, primero generamos un respaldo del archivo de configuración /etc/postfix/main.cf. Luego de realizar lo anterior, ahora sí comenzamos con la edición del archivo.

![](https://lh6.googleusercontent.com/Mp7CBPZhaWtT0InLDHqCyYBGNTBUIsG1y1-CXyq_md1FzkM3fQGvhoQ7YijyM5C26qlIk10kqWxGA1kCDsWarG3N70lKrhOGTyh_Z05MM0zU724Y06IiIjbC8WSTDj6M6hv3Wdec)

El archivo de configuración ya contiene información generada durante el proceso de instalación, en este caso debemos modificar sólo lo siguiente:

-   mydomain: El nombre de dominio.
    
-   myorigin: El nombre de dominio a utilizar en los mails enviados por cuentas locales.
    
-   home_mailbox: Directorio en el cual se guardarán los correos. En este caso se guardan en “~/Maildir”.
    
-   mynetworks: Redes locales o permitidas.
    
-   inet_protocols: Protocolos de internet soportados.
    

![](https://lh4.googleusercontent.com/sc8TJdfgZ9S4zFIQ0jjKN9zsPcN2cuWBa8k8eemMeRRgcbu6PHezx6l5GhoqIM_TwpUzHJRhQkmproJuGtnjmJ_fA4uu9oJigyXDqF-Bnsgnkg5bZIi8DdSwi4Y_9Aa1pKEiKaii)

Posteriormente debemos indicar la ruta en la cual se encuentran el certificado y llave SSL.

![](https://lh4.googleusercontent.com/kk46xemMT9qBOCnq436mIWwmvtxFGQXWt1-O24QZSC2DpkFHTomB9PRH-H7hwM-kov8sKevYHhm4Ld8muW_ET8mTRqQ3ws-cwf1k-NVcS0qUSPM6VneuIKR6NaXCGyZM0VOMYKJR)

Ahora se agregan las siguientes líneas para indicar el uso opcional de SSL, las versiones soportadas (> TLSv1) y el nivel de bitácora a emplear.

![](https://lh4.googleusercontent.com/Ldbg6Wz9Ioon0c23vyHp97fFUy7hVYVCbZh0p8vXjvVWFn-yyZ8O13zWtYoTgzCIc0_zXBhk6_n5VTEvUEySB95XpYJJzx_fXCyAtmYat2muiyKuJQYai4C4d_ZNfFnDcyBb6qsN)

Posteriormente se habilita SMTPS en el archivo de configuración /etc/postfix/master.cf.

![](https://lh3.googleusercontent.com/xxwWrSM5MS3IB9omtLmrIcuFuR6RhqNZ8H5JUHUvdmW9eudxHhC-DVdXqaGmYhdnlPlB_Nr2kSzm-o1r4tL2l1PafdzEdoTiDkIVsf5zk2mH-G04QuO4EqTm7ja346QKEFocKEdw)

![](https://lh5.googleusercontent.com/BnZUirGuHiWx4lBDBHrCrqXqdvU1OxBrJDHYH_qQyydnyGhkCSl99Gjm7kK8RPW9zUVTGLE5zcnGUZs37ENjzYvofW3OtLjqDB3sjmGf5v83PNku2no0hho-lUQlWt-LzHReXE6T)

Reiniciamos el servicio de Postfix.

![](https://lh3.googleusercontent.com/eEEG1VhmP8mQ58YVT3AYOqHd0v-83G3YNj3nx48KTHKG-OaTkiri-t3SKKY8y0SjDgzIt-Wz6uoiZaNeHKG5EwJa4ZtCPvh6r1UeFzKMBRAokFD9fedZmbASQdbp_7Uni8vWTeHq)

Ahora probamos el funcionamiento de SMTP a través del servicio de telnet. Lo que se hace es generar un correo de prueba con origen y destino aafa@mail.aafa.local.

![](https://lh3.googleusercontent.com/Qi-d203OzhJXOnU4uy3F4h3R-UmVjNoV8mUBx0ibUymkjgFKxPnbGv4VSDjZc4EV8pXKrU1iqxpbBd5THWJh7gkr4172Y55-arEgrZwFZLvmtY-I7LqA137Tn9NL_HDXChEukGY-)

Verificamos que el mensaje se encuentra en el directorio de correo del usuario.

![](https://lh5.googleusercontent.com/NQ0ezaun46QcNLgqDBBJZMsotW3v4qhDFHMyENU-_J7E6cIYpJD7Meupw1d2LIX55ePuX0t38ODxR5Dt_uCFdVBe8ztMI3TxbZEnHyDPkpVK1uG49x2ys0TLsCuTBjpm2V_vMk4I)

Ahora probamos SMTPS utilizando el cliente de Openssl.

![](https://lh6.googleusercontent.com/sBuC-dFnWkwq2_2wO7qX42Ng9UJS_7_qoXoGPObBycN9Zj5E_EQd-ynqNBGEUlay0DrhiTRl7izhHmvLo54casBCh1A2awo3N0Gvl7eQR9dvVEVcojzqddO-ef3rpoIn-u23lool)

![](https://lh6.googleusercontent.com/OIU-afyQ5EbpY2B2Yh-A8VKsvHB7Op5knYLlDO4k5iBOXw1sV32DHDMYXHYQNl1EY_kJ0gCJc1PfLdbVeqJ1P1tXPqwxS8K5D1MDbZ4mq0M60i3BBZT2S0iMDkj0u3GLDlBVimhy)

Volvemos a verificar que el correo se encuentra en el directorio correspondiente.

![](https://lh5.googleusercontent.com/V1ugi-gDVai3NsMpO9tMSgat6hiyynIHO4SXS9SBzEnSHTkXAcd2yFbF-oLvBGEyoCCHFmrTRG9sp-sf6CD9dr4KO10LUXuJZjVeC0DRfVD_P2FItuxD6Kff3rRAUVbNtlLDtTOc)

#### POP3, POP3S, IMAP, IMAPS

Lo siguiente consiste en instalar y configurar los servicios para la consulta de correo. Comenzamos instalando los paquetes correspondientes.

![](https://lh3.googleusercontent.com/BG4LVj86z3Pzl0qrc6hk2oi5sENjb2IR-2YeLryw-uJWn2NYsorpN75ILR0wXg05V4v5cvmxsd_X9nOl4Em6plChWiKWkMx5M4tf54_eGEhbCdeo3SEcfycqE5NT4lWDHEG_bLYS)

Posteriormente volvemos a editar el archivo de configuración de Postfix.

![](https://lh6.googleusercontent.com/FvnJs2wp8rqZuIy2teO3D9QouVHvhzjeiJ2Uz5XrZz38mtS8zNyTc3RHRs55lPNlmQQHshDX8F-bpDsOLPmfF_sPDgMx42YszC4R7sAEyEKjh2G3lxWAbZfMhfDidELtYYOZeMbg)

Agregamos las siguientes líneas para establecer el método de autenticación y reglas de recepción y filtrado de correo.

![](https://lh4.googleusercontent.com/U8C3jFSzewbMkuoGaDwgHxUFgeME32j7XeCgdDSBeI0uQw8mQbGogemUfzdRPlYXLZhfWu1_L09E2aLIBAc0xUqCywe6V3rthgAsaBts7-YPGF24UBtE95Xjqzum-VDhK5FJgDwo)

Ahora editamos el archivo /etc/dovecot/dovecot.conf.

![](https://lh5.googleusercontent.com/C-_lkMkRkE-TQcyz8prQct9cLnqNs_akobkVagNS4UaiSBIzHi_iuImwNePKqQaqDn7XIwSKmuwAjHK2uTfe387i6sKvJIuV9ufb7-2aAoBqjRPNtxwZoKanNTU9ZuvJtnEyKATv)

Indicamos que sólo utilizaremos el servicio a través de IPv4.

![](https://lh5.googleusercontent.com/JY3fITlPtGic0fDApQ1l7HIfMB2nFBHtH30cWllS54toIWBI5AhoNrK4nVaTMDJNux0t2n2efMW4TRH0tXcrD0dgipUyEebzYCvFB6puaSv5YTICrayl8ETF4xBw_gc6sIy62jJU)

Editamos el archivo /etc/dovecot/10-auth.conf

![](https://lh4.googleusercontent.com/VpVj0-fHB-edHTAwoXUIaobfrNgPkZQ9VBnKpy3kNku18D9DdOdlaqv3Lzd6j1Go2ycabGUNt5HJOm3Qo2qGEBBJsIsZqA1EgFkc8Xzc1CahyN47lnIqRnEJoTQKRaTQ5mFeCH9Z)

Permitimos la autenticación en texto plano.

![](https://lh3.googleusercontent.com/V0BksFqmJzaTJOYncdOQe4zzr8RhNa045rmRBn2rDRR6NTleCw3EIClLfluN9E0Zu1606PBlb3Xrc6_kTKJCe48OWa6DUNbVeqHxdR4rdYUQkZpz3Ydmfi5U8I_VpLCZ52v4qp0O)

Agregamos soporte para la autenticación de texto plano y mediante Login.

![](https://lh4.googleusercontent.com/CWOnP6pF4UDnAei-a0Jc6XluHGPeaLPJpHw8jqUIK02gBQUZmXvoMTXjkjxki0pl8H2uOPzAv2U-pSwa6ZDdttZikdj4-QBQpZYI3lrMPDN6iFAdcrxw4XplfpZFzuGVtLSP-2Hn)

Lo siguiente es editar el archivo /etc/dovecot/conf.d/10-mail.conf para indicar el mismo directorio de correo utilizando por cada usuario.

![](https://lh4.googleusercontent.com/Bbc_HODQz-N9qahy-LLTUkihtc9xYl_WblZ-KMMFT-7GOqpkGzsx--IKfkj-Ax0p_ybTnKEDkmlDjEej2y_Tt93Md0jEOLo_OYUSdb7tpq-i4py_8Lv5BDl9xy5DrrQKw2WHQPZh)

![](https://lh6.googleusercontent.com/2B7IReGfcrhyy1JeOc6FfzUkcWc-FatWeUU0aH8UuU20L97dqoKRYx4hdbAoZIW_3SXp-PwdyhtIKncI6cC0gfGm8lwfMyy4XCbZM1O8Fw1rXAzcjdLyYZpXYxazWh-bYgEDtkbJ)

Ahora se agrega el siguiente contenido en el archivo /etc/dovecot/conf.d/10-master.conf para indicar la autenticación SMTP de Postfix.

![](https://lh6.googleusercontent.com/NV0KRgj0uJulOU3-IcmWZPNi5N8qkfXznQtAuUu9BU0lyZmL4cQUHz8aiZj7SH_Rp4pWXrEAvPJcTyXYGvY9VZIdcdDL-qQA6QlmcLoca4iJZ0WYuFNaCo9yoNywNmnUGeTfbYtB)

![](https://lh3.googleusercontent.com/8yGwfpLuAHO2kHthcaQnNN1d9WWRMQwsNFs0LA5nMm4Dtk2dBRui0Yu7IbeNCRz8mEWwCltYyT7-XSPFakgxQMeW_SmSi1Pcit1cP7QWggthk3-0B4uTSIvoxnIUR0gGbWsuAaRz)

Finalmente modificamos el archivo /etc/dovecot/conf.d/10-ssl.conf  para indicar la ruta de los certificados SSL.

![](https://lh5.googleusercontent.com/lq5jWYDsdIH8c8z053q4s1KVnUb7OCoAa3HWaKSRBrOw0IcU2hU_NpSzM4IsbPnaABWZ3pVheHJmdw9wvbPh_u85W0zaxidjVBxMcG-icshEU1YV5fbIx2Gh7-9vOHmXTQ1ZWArK)

![](https://lh6.googleusercontent.com/dqP9D7vTGWEeTa31Y06eoq60hrsNxVch8eEqtfczm0DJH2x7OsHa8vgAPuvy9X62tRZNHmG9mefWwFgXYa_4XyHSPlRg5fVTkCCLseITruhadyx38wogh5itN4ilaIbfSIFgT9DW)

Reiniciamos los servicios de Postfix y Dovecot.

![](https://lh6.googleusercontent.com/Kr3zDL4t9Q8xMtQ5bnt81uR0kezI0fH65Hc7404IPIz68MUYUnYbLlDGmN1b-kmlyXttX0SPwAdMudDnbaYQMPM9oqXJnuEW2ZIw8yRysQjYnoe4QE9aAySmF_JkwBo4ntVNGxHV)

Podemos probar el funcionamiento del servicio IMAP a través de la consulta de la bandeja de entrada mediante Telnet.

![](https://lh3.googleusercontent.com/o_Fz6I212f7FolSa1JjKQWo02OH47KJMKR24s0shsb1vMrhungN3CPuru2LHRLUDKPWOvAdT1OLP2ZlI7IOdhSJkXLFFLNV81Z8IZXwpNu7UmUfPzHm3Mesq2uzavGns1LuCgfyN)

De la misma forma, consultamos la bandeja de mensajes a través IMAPS y telnet.

![](https://lh3.googleusercontent.com/VULn7sLfg6czAQeSM2rM_ymt2Xszrsf-Az6FNrkAvKBJGYadZ_PakLkJdtV4_7QqjrMCxzS14PGh7R6-UwW4SMyPlkCzr8byOZvsnAbrDLQxq1qNbHmnX28n_UQhzBogLwTQu2u5)

![](https://lh3.googleusercontent.com/YiQxRX1K4oWLuWA4RgJ_xsr5kW2cZnnzT8adk-jH1QUbhEkGbrhh243OSRQInbUD5pgu-yI8sLp13o-GrMd51NwMmxHfx8JWEAY5qp8U0LIjraCt653XgtE8MxCPma9y0DdQfD0P)

En este caso consultamos el funcionamiento de POP3.

![](https://lh3.googleusercontent.com/VM1CAV32Men-90bivdydk5rgi_koBbgs39vOIOHOF6m-7nmjjlHxZ43_bSlkVhIGYEG2U7mHeNTWLPXmtkKy0kzDKVhQ9KjhDoZwUKr49AWO71p1TT7v5YPNfLoH6Uz4PgN7S7C_)

Y finalmente corroboramos el funcionamiento de POP3S.

![](https://lh4.googleusercontent.com/bZqcpirOSn0vsS-u8kWrYflRX5MbgXfluli2Ev7Dypizs1S7t6Q5Qh6cT3llzP1EOjZ6wOnTdqVsZeKt_YTQCVwmG_z1zpJ7dqL18oDyy-GgVNKXSOUVX7D5az0e8azem_aMaomY)

![](https://lh4.googleusercontent.com/1okPo45ZOKcs-XsvFJz55V4ADUNrf6xCv3xDcQeZnCW9gtlhujormyIAXFvjOm_D11LND-64d3ealQQmiyKIJtz3so2HWv-bEC3GVwFIakeDiGvWAq-cdg-slhuw8g6AMR1FipSL)

#### Amavis y Spamassassin

Instalamos el paquete de amavisd-new para Amavis, el cual es una interfaz entre el MTA y los filtros de mail. Adicionalmente instalamos los paquetes spamassassin y spamc para el filtrado de spam.

![](https://lh5.googleusercontent.com/18khNNzy4Z8aYU91CGxVayGNPA4PSoB1nIaXziNd17K8hUw09V9LtlebZryROtNWUahLOF67WjgjT3TgclftbQk4eQjfmrOORUIcrmXae_fGxU6IsL4OCvPkFgp_7B4Zh-IEFG5i)

De forma opcional podemos instalar los siguientes paquetes para lograr una mejor inspección de archivos adjuntos.

![](https://lh5.googleusercontent.com/nwOXNXgWUCVjOLdrKbDBUkrNZE5Xi9TUDSHqUEW6Wsu_7WwmKUmieRlL35bW0hdKP332E4lNmxiGwHXSc3Q3bGXRc9_OfvbTt-JWaf_XTrG4hNhX-RMpF5w8JsMhWwVHrAqZDbZz)

Posteriormente integramos el filtrado de Amavis a Postfix a través del archivo de configuración /etc/postfix/main.cf.

![](https://lh5.googleusercontent.com/2U2ghsIHEcLunorrgxZjZrWVisxXnjw-P-Gjtnq2ORu5K9PpfBQQV0rFAlKKOtWqixV3TsEVjziFcn7zzV7O3lYWfi374jHP3YumbQkvyxtU95rePUrWaFboeY3O54A2ecDRxMDR)

![](https://lh6.googleusercontent.com/Dgj04-ZOPaY88qx8bceHv-y7QGdbYirpiuUa_av2MC6INIkJ7ICvi4-ZsfcjLiq8YBoVEmFuIZLtouMep_rjPpUM2CxKTjt71EMdzaKo0clJGS8POQeAaQ89REZrYPMgzjLrIpzg)

Luego agregamos las siguientes líneas al final del archivo de configuración /etc/postfix/master.cf para habilitar el servicio de Amavis en Postfix.

![](https://lh4.googleusercontent.com/GUfHe_HV6TVZFWDlYdsafBXk3zRmuiO2_aKAoP893GjiEvmCM7TLQLMYkca5HJXUjCuLby5QH2hE0E-w8UJrrcJA9mEW9oePh1-ac-ZX1H20EFhzkdnmNMIISEoe0t8q1fsGFqyg)

![](https://lh3.googleusercontent.com/ezK_2QaimDcfIpSsLUAaxqPFFyqqURcV5ETw3Hsx__WMK1Dfh8AGTmLcBeOPluwgwvdpKlWL7MuFY9JjUpcH_17Ty41RgVoY0sn_17TiLX5u2VNrIrjKv6aWKTtoXjYs0W6sMLTx)

Lo siguiente es agregar las siguientes líneas en el archivo /etc/default/spamassassin  para habilitar el inicio automático del sistema y la actualización de reglas.

![](https://lh6.googleusercontent.com/QYeMQEmXryvnjfsnDzLwNk1Amv-rFbaCjPDuKzgXvtQ6WhDiLThfWWzIzuoCb50MNcOF3uLqSn5P5Ab-rjESyXy9OZ8FKB7IxY29iO7bYyLfGAK9Izn8e4LzrJuIjIGyHo1U4K3Z)

![](https://lh5.googleusercontent.com/W2vVJGQbe_6sqC19fLrjpeQ9FLwjXTyRZI1JCkMf5KukEmugL8X21Z3MeJE0AOLfjZUwefpeiNTxWwpQfJmNVhI9aapCSpLE4zgRPSoqDqkgdE8GY7Tucwo4rnw0ybBuLpt2wdxn)

Luego deberemos activar el filtro de spam en Amavis a través del archivo /etc/amavis/conf.d/15-content_filter_mode. Debemos remover los comentarios de las siguientes líneas.

![](https://lh3.googleusercontent.com/HfPXAdXLk2gplQ0Oa0vwQJpy1Z-0FOFaKd5fYPdwg95EwMvCbxXJVrWgrJQIPE60bp6-5oYH75xIokIvnVpAujWLwAMmYdTv3TEAmyqHe2lu74te7NE5-oOQeRL1BliOHirFyOUh)

![](https://lh4.googleusercontent.com/0H1o-lBGQXFBkm0YVcaZe8oGeK0s4bdHd3ibKDmW8wzn9dtrkanXQfcC2S1tTJ-W9tJzIKNTUt7awKL1q9yonAhGIrWuyjkVq-4JFDQR9wBURX8WhPjIO30hT8BpSIJz_fEfqNTU)

Ahora agregamos el siguiente contenido al archivo /etc/amavis/conf.d/50-user para indicar el tag utilizado en los correos identificados como spam, el puntaje mínimo para agregar los headers de Spamassassin, el puntaje mínimo para considerar un correo como spam, así como los dominios a los cuales agregar los headers; en este caso se agregan en todos.

![](https://lh3.googleusercontent.com/x_Pz6z1ijyC4cC4p2G_87WfljmBAATj46KX70tCnnhRCKP6ho_5fRh0XgS1CEhuQDCnfFYWFcyHGmeq98JZ1Wi1n7JBcCmG9tzdDrOPChu4M9lhBE_2fcXLNVrny5c_TNZk7YYNs)

Posteriormente reiniciamos los servicios.

![](https://lh3.googleusercontent.com/hjWK62MDS2OOVBpJNci9-oyU8EWsEi9l5HGc4mJY2QHmCWfE7W1J2qFNMxLDHZlWtrnt-4sPilpxGsek9BfeafhlBk4qM4o9mpH9lbuF5JAVFrzl04AiUyQbk0KRAPxZijG7VLSz)

Finalmente podemos probar el funcionamiento de Amavis y Spamassassin.

![](https://lh3.googleusercontent.com/ZDaHxgQCKHtGuwCJ8Wk2JY12JmYWqvWFs5j9HzSNSTc7hfgK8ZJLAsn-OwMPQnjlw4Yq5hFfwYCkh_GBNinTki487Qz8dhDPOYARS5D4J11oKCYWpOf6L2xugHIs-Wm6eYVl6FFK)

Verificamos que el correo se encuentra en el directorio del usuario y que ha sido procesado por Spamassassin.

![](https://lh5.googleusercontent.com/hefFuGKiu14D-hBcZWHLdA6lh4DFnARS2Mt__AjPUqpu3L0BVCMaco7MVIobGwvFSZ0WJ5QJXU1-B4Dh5Jo-VJPejc1LUx_P66TknlWW5rEISgpNpD1bhb4bYaRALTfRHb6_WAVG)

Como se puede observar, el correo contiene las cabeceras generadas por Spamassassin y en las cuales se indica el puntaje obtenido, así como una bandera que indica si el correo se considera como spam o no.

### LDAP

Debemos instalar los paquetes necesarios para tener el servidor LDAP. Estos se instalan con la siguiente línea:

apt -y install slapd ldap-utils ldapscripts

Durante la instalación, se le solicitará que se configure la contraseña de administrador LDAP

![](https://lh6.googleusercontent.com/bDNCr9DZt0gOo7tY3rTN6lMsZjeIZHfYtXYK0wYV24cxLpSFelW4jBa0EuJOz9cLnAIxsd2bYDK1UK32aUkYf9JNEIdFZdmXcSyWvsSCnrrdg--BDsz7Rg7bi0anTqAglzv8ZoiI)

Ahora debemos configurar el demonio slapd para añadir los datos pertinentes a la base de datos de LDAP. Así que usamos

dpkg-reconfigure slapd

Cuando se ejecuta el comando, se pregunta si debe omitir la configuración del servidor OpenLDAP. Seleccionamos “No” para que se cree la configuración.

![](https://lh3.googleusercontent.com/fwMYIxQr8iiWvMZzgl-ozfMOKL1QJg9iRHXmn03wRdE8lA1KiE5EpPbTKmGhzSNY0gAn-6yYpRxSW5oNfKOU6ksInL3J29u0abIAZDoffZCfmBf-2Clq_PqIxdt2e1oxBoR7SoGU)

A continuación, configuramos el nombre de dominio completo del servidor OpenLDAP que se utilizará para crear el DN base.

![](https://lh4.googleusercontent.com/FpdwEDhsebTvAiabaTJTgX46P-aWf4HEO9-Uo83Uh6LUOsh86VS52D8_Bsa5LXb2NZ0G6Fr9v88DnDC2eazRB4SxQ59r0CgJ1H6lUxMbKQyjlXmfK1a3Z1jGgfPMKfXaPUGUxF6v)

Establecemos el nombre de la organización

![](https://lh6.googleusercontent.com/RFdpqVbb_d-QJS8932R0IVjPYRf_h1YSKfbiRLQigDDfzgq21zwLHv83-Cr78T9CWqVWLdsll8kHsm5Zkex0BWH4A2fl5tfMpsCv6jm1XeNRVw3qQi8WM3OZm3fqkF3mR0eP58g6)

Configuramos y verificamos el password de administrador

![](https://lh4.googleusercontent.com/PNljBKf2ZnHPa53ekRTdPp7-A5gSMIQXRm58ykdvHGxCGkJruDUE9xD0AjMpR8jgLs2kDzv5-FTej-_mlRpZwvsrkO4Zb_Z0m135jj4N32WEpIcnVCQXSW3qWNtx9FKHQDzKDiLo)

Seleccionamos el tipo de base de la base de datos OpenLDAP. MDB es el tipo recomendado

![](https://lh4.googleusercontent.com/fDT7SF3B7pYtH3JFrMQjYj_tltTi_5quOWRE3syxg5xyEcrQ-TbkWEeOmbFWURN_NO4Wu2_G6o9XVDaqghwmFwMY-uam90aW4mnGszPJB32xaaXExSIk-W4CQ12v4072CgYoMoFk)

Removemos alguna base existente

![](https://lh6.googleusercontent.com/tFqujjIGmJf09VHttmr7GwUCyTdmap8aT-glXveRwwJHQf3lgPL-o7z2RkTOVlHgu9OZjCofZPXHofeVeQfcZICY8giOjrb68s12wtJAZWvh4msTaXq6zYgVWdg1zMXyAzz81NrJ)

Aceptamos la opción para evitar problemas en la configuración

![](https://lh5.googleusercontent.com/P7x54NDTKclpi-2HNsVKhdXBLSgbaKUO2HJCtWXTaNSpvavFGvbB-aUo155RxOY-cf5RTp3VEBLvTG7HDmStAeXFdZ4Y5PAYGI0DeAsMHV7q9gu0MkWiQOlm_eRU2ANJjiEwowH6)

Ahora que tenemos el servidor ldap configurado, podemos verificar los datos con slapcat

![](https://lh5.googleusercontent.com/Rp89JKNo3vBGS4TQwAXVJwNnTaZejKjO8UJVduhv3G9D5DVXT6IYsTpdsLAk5uG3GAdBMGLpxQ1DbtIghEs15qLmBPCNrZH_Y3PaSoPw0O8t1z2TiNhN3rP8-E5thnU48YxhKsC8)

En este punto ya se tiene un servidor LDAP funcional.

### LDAPS.

Para configurar el servidor OpenLDAP con certificado SSL / TLS, necesita un certificado CA, un certificado de servidor y un archivo de clave de certificado de servidor. Creamos directorios para almacenar dichos certificados.

mkdir -p /etc/ssl/openldap/{private,certs,newcerts}

Una vez creados los directorios anteriores, editamos el archivo de configuración /usr/lib/ssl/openssl.cnf y configuramos el directorio para almacenar certificados y claves SSL / TLS en la sección [CA default].

![](https://lh4.googleusercontent.com/7JAI8Vc3oGcN_KPiybxyWTAQoIxZKOVSyFvhGHL9DM2Fa52IXm3XZciI5ojXoW4qQRtEmsLWdZRZR6eFlytl0aTEu03YEWQWVLI6YT5ilE0U0Wmho4JNt2NWFghPbH8MMscilTXl)

Podemos notar en este archivo que se especifican rutas donde se guardará el index de la base de datos de los certificados así como otro archivo para el serial. Debemos crear esos archivos

echo ”1001” > /etc/ssl/openldap/serial

touch /etc/ssl/openldap/index.txt

Una vez tenemos los archivos y certificados necesarios para LDAPS, procederemos a crear un archivo .ldif donde indicaremos la ruta de estos. Este archivo lo llamaremos ldap-tls.ldif

  

![](https://lh5.googleusercontent.com/QD4DINu1AG4UYRMhKeLaeE3IHyDX1a_-4XD_bKfq8CeQu9Kcg-QIaYFeIeC4rfcFDBOdLpcRxdLMebflV9cRk4hiNjTtv1syF7ku6am6MpX6A_4JO7Ts75LomABGI69TdSSNmrNq)

Y añadimos esto a LDAP

ldapmodify -Y EXTERNAL -H ldapi:/// -f ldap-tls.ldif

Por último editamos el archivo de configuración /etc/ldap/ldap.conf para cambiar la ubicación del certificado CA y añadir una línea que permite este tipo de comunicación

![](https://lh3.googleusercontent.com/R75V6zNuUOcpSeJoPFmFw4pv6WLd0hIRM5bl34c-by-4xv0sbUz6GBMxunEwagjvJ8KMD5eKhAI80pTVpwtuKGoDJh9Bz-2BxOhTDX0JT04AoSSnOuwo2CckVb5DfbNlGUgnbitb)

Reiniciamos el servicio y el servidor LDAPS ya está listo

systemctl restart slapd

#### Habilitar logs

Para habilitar los logs del servidor ldap, debemos crear un archivo .ldif (al cual nosotros llamamos “logs.ldif”)con el siguiente contenido, el cual habilitará un nivel de logeo de estadísticas de conexiones / operaciones / resultados

![](https://lh4.googleusercontent.com/2owsuiX1JpI9K8W8zBP0kKcP23Ug27QIUIoiuEGUl2Q0WXAoBCsxcpCTKdNCpKo9JfAE0QXIfIX-GbdODLHaxkAZjiPewncnSBuN53is22AnH990CdysmJ9YldvgPSo0QnBOu1pw)

Posteriormente lo añadiremos a ldap con el siguiente comando y reiniciamos el servicio

ldapmodify -Y EXTERNAL -H ldapi:/// -f logs.ldif

Ahora los logs de ldap están siendo creados y mandados a /var/log/syslog

![](https://lh4.googleusercontent.com/RCdktaTanai8JrFmwngPnLy9h8FJUL1VmdnHuVg7w4exLVs0eBeZzJ8-uyQeN37bd7nhf9x_eSwu3M-D5YtJ2WEWOD0n_Jvz7XlxRn5AHP2WHChFRK2Kt4JR5GdjAsJc2H2U7F5W)

Para finalizar, deshabilitamos la autenticación anónima por medio de otro archivo .ldif que deberá tener el siguiente contenido

![](https://lh4.googleusercontent.com/tc6SpftQgkcPK6GNpLxz5GcKvGXYIMndWHPv4Ilj_Kjmb_QSNaizoyFgNxULzAPYDubtUBJLIogL5jtFHcajLqC6vZWPjV1JSsSQ9tBKeA3eYFpiOEJ_4fwdv4905UstDi-O3C-C)

Lo cargamos a ldap con el comando usado para cargar el archivo logs.ldif,solo que hay que adaptar el nombre del archivo que se carga.

  

### Apache HTTPD (HTTP, HTTPS).

Servidor Web (Apache NGINX)

Creación de usuarios para los servidores

![](https://lh4.googleusercontent.com/4gOcesvwv08m_myjAblXfvfSKB07uLqMblE6CYMWbr0_zn-DE2TvFkszxfJvi2L3trkweWmgOgYV3HN0fQoINIDhpyCmlnVgwwxu4EEf6UlZG1DOMReKyuCWN3B5RlP16g3UEpA0)

Le damos permisos a este usuario para la instalación de los servicios.

![](https://lh5.googleusercontent.com/BX7IIBbpRnt3dLFw34B-kMMz9YZsCQbfGf7StKrs9zHm8trT-4LLdFO2h-K8lsynCRA97RkykaS75AgaiyoupBsb9y5lX-0vu8le9gDbmJzMWDu2BNgm01YZWPfvDPdOwzQBAbpP)

Configuramos la IP estática

![](https://lh4.googleusercontent.com/EK7G8SZ5Z8FTbSrfAhYr0FDbKxOo3UVhXKIHldShH1zomcnU8PSM_Vtgcw_sj2bykqAVWDDDMGsZY4XRuCR_qcGZeM0j2I2puotWsMzdx5ZbLWbH1FQsclOHC-0KxteVJ3mXIKGw)

Reiniciamos la máquina y revisamos que la información de red sea la que se agregó al archivo.

![](https://lh4.googleusercontent.com/F-V0oEsObJnhTLm5gsTAIW8C-LtH5Ov-3Wg12PZR_fa3oILiJiMbRcogmI5csv7D1P-cxYOIJDiMe2_B0PGv7_SBcmhRfeA6P2k6m6ESggm3o5FoVAWtTyTfuFvsFkkvcDHhSU4o)

Se ejecuta el comando sudo apt-get update

![](https://lh3.googleusercontent.com/fhc-v0z6J0Km5-c_vrWrqrzfqJZqRte2ZbEcHU26lEi-FYFMwXh9YgpHlUu5DAf3yahQhKlCCbCZ79B2Sd7OB-vBzlfZSI82Do8Wzzk3ww80yq21rJLeW2CBLYpA87BqLDiccfJp)

Se ejecuta el comando para la instalación de los paquetes para ssh tanto servidor como cliente.

![](https://lh4.googleusercontent.com/aZFj67GtwGxxs5MDSCmd49nqiHWF6H7evA0KOcmKJirUWZhFJk_T2c4wRZjbX5QHBsHMWQdfciMw6CgksoxPnwy7-t8HClcf8HRzHDKGFQiUiIedajbe63dmveE51kDcANdu54Pj)

Verificamos que el puerto 22 está en escucha.

![](https://lh6.googleusercontent.com/R2JpeT-isTm-_jxug2uUtTZvuiRJJhywEYiVBTVBJLjbh3NkJ4PsSV5BPFVt9sUBpMKUvmQrIgsZozowkOSaXsHSvjmi8MVF9izUzBQLPnA30gyzusGwZTNQJO044Psp2rqBdHX7)

Ejecutamos el comando sudo apt-get install apache2 para la instalación del servicio.

![](https://lh3.googleusercontent.com/YYECsARQgjbEl4SLOTkGYKgtqjN-EBQvBoHiUARBnHcQpEh3VS_1iJNtZ2wGZt33j9g79UW7yivlIM7iu2Efd65Ni8X3tBUQbFfDtimHuYPrr6NlLCpqrC0-A6nrCBXY2JOhCgvA)

Revisamos el estado del servicio, para corroborar que este se está ejecutando de manera correcta.

![](https://lh6.googleusercontent.com/yrrvU63s3EEWjHt5Ra69cpsqagSPnBj3YZ1tnYARelHemIiN2vgMGavGUF4SPFTZwRJ3puRMh3xiZI6Ci5wm1RN0w-e02FkJMLzEjSSLxQQ5FKUfx4gKCjFEcUYyZU9BH4SxfrNZ)

Habilitamos el inicio automático de apache..

![](https://lh6.googleusercontent.com/qHamtGA2nYS0oxoQoKFQXCu0DTsKO6U_Od3Plw5cyV5FLdChidX7OE0dOT-t3FGjw6xuSHXQg9cJhVmyS10d0UBf1j06J5B-5l1YJ3PUD-vnZLD5kAVJo5eyy1-X8DO7tlYJgx1m)

Abrimos el navegador en un cliente y revisamos que responda el servicio.

![](https://lh5.googleusercontent.com/nxTD2FP2uf9_bFg_K0wRwPHwlGXbYiUWHE-E9rg6U4r9bidHzkZztyeTU13m46yZqpeC2RX6VOkN4SS3mvcI5t5iCCtDNsOVG8fUrlO32uKcG83O9ZTMntoExaaP7hQXBXi8pigj)

Descargamos los certificados Wildcard. Posteriormente se pasan a la máquina, en este caso se hace uso de scp.

![](https://lh4.googleusercontent.com/FrVrWty8M5Ga58hXr_zBkCmuMQ29QqYeN8VktIs4qM4QlxV9PPBk7X15GrxfwjccSgAr2KIYwtLmUTYcg4CeHM9Kk77M8oan05kvP1BPq5UxMYpY--U1G6lkUwlulWQ5YAOtj5zG)

Comprobamos que el archivo está en el servidor web.

![](https://lh6.googleusercontent.com/aq0GMxIhdhuvo3b60uBFrw_eAfNBbVzYVVkI5U_MH8rhiRiC7P7limjRMKhjxCCcpa6Q7pmuvCPwMQGakzw2fZz5SHR58Plih-fvapfWYzPAyCnmGzOdWDGOBbPLXPlkPZfzcj6w)

Descomprimimos el archivo y revisamos que se ha creado la nueva carpeta

![](https://lh3.googleusercontent.com/cEDlhsXWqskdeC39O-DmoH8F7rFGAkLLKMXUYxIXZZipP-keMh9MsBPecsuVfKHwvW08uxdVf5omUOzn5Y5w5FbSsTST3KTZnhI-68BbAU-jlX7Rf75lV6ClDZ856j0LCMJJP8DF)

Copiamos los archivos a sus carpetas respectivas.

![](https://lh5.googleusercontent.com/CeS7lDhLunQYSMzawfLseCp7L3HTtzlEJ3Eq_pupZVbYl491cDb-iSCoDsC2lebtM0GIjQqnMlDbfR6PBiOdVPSWx95F4KzS52Wck2JX4dvyQ9EufFXBGrPhGoxtf2_GBCgwi2NW)

Editamos el archivo de configuración del sitio, el cual se encuentra en la ruta /etc/apache2/sites-available/default-ssl.conf

![](https://lh5.googleusercontent.com/QsnH0Dr7aDkzaC7uY87tAiW4cMiqTgdQWRbgK56PK3xVnRRM8v5ur0ubnZDeoZljg7_XSFJ315u4JR1iQKo_ceaeKJzbi9c8Q1HmP5Qg3OF0iEFdJ4ZYuUUyt_1kdFtjbPIYLx36)

Creamos la carpeta correspondiente y agregamos un archivo index.html, a éste le hacemos un cambio para notar la diferencia entre ambas páginas

![](https://lh6.googleusercontent.com/LK13cJ4arBpUgshVSmkUAvITC0kbDc8036FAOdyEFZgGHuASbBtV3bJQGT5TlmEipDM2fFGktrhIjC0L8BDjev5BUExvWaME_25pU2IcOaURxOHPw3f0_4rNKwmk8yWJWdBz8rS-)

![](https://lh4.googleusercontent.com/JimQxWZGLaPPF8DSDvSlEC1_T23eST6XGsd3ASK1_Jx8DGANZWxkEsFNqMygAMfsbSCYCWmsFZx9QEVocNswMdlBbnm7ugukz2BCqw0F2Kg9ND8GKjsY4OXITts-ud5kcjk-atxo)

Habilitamos el módulo correspondiente.

![](https://lh6.googleusercontent.com/hUzBziXya-tClzi7ADaoEoW6XpDDE2B2I44laTaVRwMguh0lwSUn7pqG5aQxD_UK720VlI3We4B5XLKViHmml8BBAIc6EVdsENYsySkSKvxRP1bxMk9XCMTkGW52SPeDTnfXftU5)

Habilitamos el sitio web

![](https://lh6.googleusercontent.com/aoUK_FmntnISzdZeDcP3axWaDoabKw5yNEn76oBg3ElB7URBBOdavz85vX4OLm_ZKg6BdwrvXhWF8Q8XHzrUhJ-WQhRGB1DLNSE3jgTzFCbYn96kZIrY8-eb0IjtcvKR0wXXOYzS)

Reiniciamos y revisamos el estatus del servicio

![](https://lh5.googleusercontent.com/1R2lbyZR1G7RyKgLsSZV4iYZbiquhLnQeVz0T2wL-1oSQpnzBqSDX9Mp1-1F5FW7sP5nT06PXsvv8srqGHXvzQHsA8IW8xBN8W-wH8Kz2LdbE2qoElzsTcEwu2ujdjvEbFN2nhaA)

Ahora en el navegador visitamos la página, con el fin de revisar si esta responde con https.

![](https://lh4.googleusercontent.com/regWV7kdnah5QUGQSByi8R0MoiIS5fbJWeFbPRbo00Xbqp0RhdJ_9YnzPGF3kslxHWlzTgIbpSwC4Of5paDK1kOYYV3AJSiqxCSCH0U61vzQFbEvyVtf_ZL2ei2kp6ukwfnN7qAi)

Damos click en Configuracion avanzada y, posteriormente, a Continuar a 10.10.10.9

![](https://lh5.googleusercontent.com/KbWyMt48ZsOIEeHuMkVVSnqenDej_UPi0xRDeTRUG4_k4XqJixWYhZjqUoJ7ZwAFHgx0jFsD5UpJg0NXojTiNU84MMjHRcG24ptxsfwNYpTaQZa7sJKSTppHLa0pwciBFKGUv1EY)

![](https://lh3.googleusercontent.com/bH7oqqcxPam8MVLPBlGjGEvbBn_LeiwV6VBoevrkHdNCTegpb_fcW8FzsLARsKy7Al0NHqWKem0ERzTq90OzraurEOPuDuY20Pt36lfhpUZzagsvfmAn2E2W1WNi1TQxfC523dI9)

Configuración de nombres de dominio, para este caso, editamos los archivos de configuración, donde la Directiva ServerName es editada por el dominio al que responderá la página.

![](https://lh4.googleusercontent.com/JaUz5-T1wdNfwjl6hjoImQnIxRbfRCWbBeNyzUqgcGD41M64ivfCCHM5u6IUlxHwcaw2oyb1XUTOIb95f__HxrFegIxF4DG5NZl1TEWIsEhNyiESzwHFzpQyq-_qj4L1VRJkL6H3)

![](https://lh4.googleusercontent.com/qSUSSe6PRqCTpqhV7BE3D213Te0n_VVZXhsLQoF1pvHpQHDYKtOVEE4OfKXUBzrf0lcXSquZDz-9XZdv6zG9ytkkW040VZ8zmPVH4EBDFoaFLhVzYZaj9Da3nh-VNjvupeLqSa3p)

Deshabilitamos y habilitamos ambas páginas, además reiniciamos el servicio de apache.

![](https://lh6.googleusercontent.com/9AiSNkWHlV72qwJUyHlKw4oV5Vt-Gdgon0mOkTuvMzLqI1Ywlu-0SSH1jD8Q5r3NRiKaY2QjBTTqyLhwMYZk091nMFEvK8VJvAdg3foSD9v_1CKcmrLXsOfqePB-5IUDFW_6oaHn)

Ahora se pueden visitar ambos dominios

![](https://lh4.googleusercontent.com/_j4GXv_jUYD1JigLWSak4eFdVQKg_Wpc5Hjdix1DAB4RFBpUYH5I_lTR6CHd-m8-a36tAtFswHaR8ULDUxZ_beWPoW-p3foiw21r3aGJaxJ4Kh6Mjq728vfQArxw3CQYk7ydMbZ1)

![](https://lh3.googleusercontent.com/GPta6VXTeBTgQg_YMKQYIVn8iyyok5a_hSJbFj_T0tYQ8QI4dTRd-ljoWm2D3rrxFOUU5HgvIjcKCVTvkow5KBo_TlgeAj3RCU9ayZ1AXPcSfb4rEN60gVle5dL4TWWOiepFKHeF)

Para que nginx funcione cambiamos los puertos de apache, para esto editamos el archivo de los virtual host, de manera que http responde por el puerto 8080

![](https://lh6.googleusercontent.com/DAK5TDNc2fwLUjKY7-0Wd7QbE-b-5OEZWjHWfkgE4O-_0YwUaiIJSOd9ia2OzxzWcaN6x5wYUNIFpHVZJUCMvQJXqMxnrxywfzHQt15BHU-ODRXr6reQ8BzHkX2Hmllb6b5oKG9R)

Mientras que https responde por 4433

![](https://lh5.googleusercontent.com/fVQYeP7pdQUlwZKV0vWECfpsB7p72pWh6Xg7S3sZ-f-XzZnjio630RKH0KXTq2eOCaFD0b0OGn6k1SjjjfP9NO_h2bN8Qk70Xu-sT0I4floSAcZ-xkmMiBZwjy5V2cGNONKcTKtm)

También editamos el archivo /etc/apache2/port.conf, donde se especifica que está en escucha por el puerto 8080 y si el modulo ssl esta activo, por el 4433.

![](https://lh3.googleusercontent.com/YGFXymT1zrniniWBGGfD1uzFBplApnjaxdQ09N5Az6WKiSOgEeHC-i0yWMV_DEldtlPc3RetnnvAUfFgfC9o-J09-Dw5sfcpr6KQOYFhgMW5x6fdxo73jA3VofyRVCzIlnZ5r7Bg)

Finalmente se hace la petición a la página, especificando el puerto.

![](https://lh5.googleusercontent.com/sbAhnWBE9BXgaWpsM2uKVhv973ir1MBQyleiiDjq1hf1I862NPzLM6qVnB07fvrdNPGBxvK9VKg-m97rEueyArJllWJltfiPNte6gAN8HXVpef343CDnQwg1gAEcDlpG90ITZVJ6)

![](https://lh4.googleusercontent.com/gC8gawAro2hS_MM8LiwvuxXtLh1YD3AsGZyqio123TYzCWL_n-osQNbak7hoU3McVkynqWqpYUh5aIO9pGPsdPj_Fm91KXWw6N8dgdVHdO-_kb0UoLtB8JwSG9YCPpHpMZo9CKHt)

### NginX (HTTP, HTTPS).

Instalación de NGINX

Ejecutamos el comando sudo apt-get install nginx

![](https://lh6.googleusercontent.com/NyjnrOonj5dvCK6Lus-My6yhmjbCQvVoOdZSucCQ63HfsteIYK0stu0xLKN_6xsoZIRu13Ew_RfNhuT_vQ_BcE3md3mRjYbEkXay8ZLCYHuYFZYH5y0KNjy-tG8KAMDjJNYCtsof)

Se procede a la configuración de los bloques del servidor, similares a los virtual hosts de apache. Para esto, inicialmente se crea una carpeta en /var/www dedicada a nginx.

![](https://lh5.googleusercontent.com/vP0lI1Ur8icMYmqsHfoXc4b-g3ykbkR8l77VulfOPICS9bnS3VsqBm8M8IioRLnAln7vPUUcfNehH2fWP0DDPfVN7-XKcrlPy0O_z2eNt-KPwnveuNh8ezI9Uf1LubNNT6VHYx3h)

Copiamos el archivo index.html que se tiene para la página en http.

![](https://lh5.googleusercontent.com/LFOPOI2huphIO0jfw6K4m28kAJwjwo0_-8wLQYVInW39OPF7Hd9qzu0yauctOCQ8thleLaq10LxcUoXmV1OMz-lxRlmX9Uv8tZfZh6IPIvXSJHARrlEJuvOZ7Vu85i8OgrQqsUAu)

Modificamos este archivo para diferenciarlo de la página http.

![](https://lh4.googleusercontent.com/-M_ATQFFo75XjIOnGyGfNa0ztu-r-FrNilNGtHL1Q0E5H-YWhFu5rUN8km7eSTxPbPEuzHj1Jn1tDIRXaD9lxcyztwR7lxgnVWUfV8sFQJzh4gr0FGeahMe19Dm34vZDodNta64o)

Creamos el archivo html para http

![](https://lh5.googleusercontent.com/vWfBzuvCZ3WvfpIcKbMTIreWI6itbYedRwXIsMRxkwWPjpt8W_M13fbq6cIpa6H8Qtuu8xZVdVdRr5t35VJAOY2kGTGzk-McJg5yv_TEhqYaJnp814g2k1KAokedUp5g2PLFgdR8)

Creamos el archivo para la configuración del sitio web.

![](https://lh3.googleusercontent.com/m7xqPCgu0D7IPGJOWZgX_-14QRJD3bZe8FxoJrRnzTZK0VaiTcwMiRt79KzwO_rKhY1TGun-Ekn3GltY8_oZWPSJdAghPtEAKLYd9S7Us3q4103VRpbQu0KpHt2YCzLaTu6g3HfR)

Habilitamos el sitio web creando un link simbólico al archivo de configuración del sitio.

![](https://lh4.googleusercontent.com/efta4fof0bqHuImQVG6DohYOSK6B5yKBnIxCFF02uAfE-8w3kfPPC0Y_pD17dbb7fKEkaFcurIHxwlFAvIqBZIXkJDMH2tn8hfR1D-LMwepXGZBV_QI-7tBpIKUJHzdcFQCD-tcc)

Para evitar problemas posteriores se descomenta la línea server_names_hash_bucket_size en el archivo de configuración de nginx.conf

![](https://lh6.googleusercontent.com/ptql5pHnjOHYP5GadntOQgs-ycGMaf7trzrH6hZU4cE2zrW7SgBKowvaP-bIk17qaDErZ4UGzP6AICHTXIW4gPy3-sncIpWuqr0WgC8K8vf4731gQK0PY1eb0ZFG9M7WyTrCeSbf)

Comprobamos que no existen errores en los archivos de configuración

![](https://lh3.googleusercontent.com/D6qhZHFD8ZjLjetr6VfyhkfUB0zox1FD8pt5Qdt2XyVF9qiLpvcxtaLZWQazcp_WacTRPj9Eol0cfA8Y9xc7tPYXubjNTZWgaefTVNDjam2Aec5tbUXR49wj8VmFA-a9-48VeYkE)

Creamos un archivo que apunte a los certificados obtenidos para la página https de apache2 pues estos son wildcard.

![](https://lh4.googleusercontent.com/_PEXh3V_jRcIcokn0i2YwxjdCcNeC5SsfKexnqdrN7uGszFapCwNfPNfXa4uGGC3rXmGpHHoB0TEZoAmAdGVh7TH3jJndgyg7foGRcS8Q4eSW8fFPVpA93vo5-S3e1WOoR3T7ZNQ)

Creamos un archivo que define la configuración de SSL.

![](https://lh6.googleusercontent.com/Ro9RXz5_cfW8O6G4itxEUWYQdBiuof_uyA5AuoKqvAPwro0gVrMWUbsQT2c6peounfeu__W-r0a36KFfT4DaX8uuASrDUSe6uOyfUl9jraOVHjQuI1-_RSSkuUTCs7Qx5Vd-3Qvw)

Creamos un archivo de configuración del sitio web, para esto se copia el archivo de configuración que se tiene por default y se modifica.

![](https://lh4.googleusercontent.com/4s8s6FuQVkgEqgh60XZZjMV52ZFh_ClNQSessSqHopM0tSDEdhfzb_3Y876XySHt9afE0MCoe6KQQj4QXhDRuYQnrDv_i4tmk8zW3Vd19f0BLX6Eh5OM9VYujcmSt_fOY1e0Jp3g)

Creamos el link simbólico de la página para los sitios habilitados.

![](https://lh4.googleusercontent.com/pzyzqh5Cw6FMsz8ZKm-pvh0Ytm-oo4WqEhnDb4IMa2bjCBuBOOYnnY8aXBWOk4sdZ6prASXfMzcaVN6hn_HP5m8PCDnoW_2UgXBdphR23FXpirx3Sx30C4eGMr4ROYSv77goi2CY)

Revisamos que toda la configuración de nginx sea correcta

![](https://lh3.googleusercontent.com/ytnrObl5bijD5ECmDYagvxQuqJmw6k3EDkyS51NDpkE0FtauMPy_mptPeEZcuZgs1f3XXT02R-eYelKuxBJTYD7ZEUxAwnX86Ldz2zJimy2qs0uFJDaNNKVSn9i6AXt_i_BxpHoK)

Reiniciamos el servicio nginx y revisamos el estatus de este.

![](https://lh6.googleusercontent.com/gRAO6cvsa71w0cUklWJKfs6YinpAguhD1KRX3fBbIgo1z9InN7uyH5s77M4T6rWe3gpFVhFeDB6DrX4zpCFyUs1Wtklejtf6wxb3wDNJfU_ynwAnUDjQhdJXxGCdoNQQYtETArCT)

Ahora abrimos el navegador para visitar la página, donde se da click en configuración avanzada.

![](https://lh3.googleusercontent.com/nRog0A93_VYzUCgT_ZjwQrtVdO_CGd4VjAEtk2QoCnWDWHQOtsg5zQZu0uDzKx1apQppjolELhboO8gAN0h-qddDav87ChQAVSrhzWL5353BOFWdYpNbsuMP-tZnIW1JCeEc1LEZ)

Donde se da click en continuar a 10.10.10.9

![](https://lh3.googleusercontent.com/CojCmPMpo8ZkcbwrMXr8jWLQLe-Iwuq5IwgQMZs4d5GEUBJo_Oh3YpUaaYW8YokUdEFPavZi1aUzSQ-dgdmgYBHfAcpNlCHDNJHrUtxtGURYGRNgbSemS4klyNSIKlEf1DfCsA7Z)

![](https://lh3.googleusercontent.com/7RAEkHXeVkPzJvk21yK57rQzCnxLL24BqjT0qgBxukXZo3z1BxyR6Zt_u-qMvuNEV3ePVT2XALme1c7z01KDyJeRy5_5vLhnFfkIAWGoIVQ4dvgdcq8Vv14mNW-Nj_aFHqm2qIS3)

### SSH

Debemos ingresar el comando

sudo apt install openssh-server -y

![](https://lh5.googleusercontent.com/OYTz6h2vnZ0-UVoJ0CkKV2cuzSB562WTnLhqzlKxMJ-QdNNJKUJfzeX6xK_6GtF3ZG1e8xnN1Xamx62G7yhg_17bxX9y7uQ3_LI3kimoe2EIQqTLOgsFxMTbz-wwCsAxfuBdGrxe)

Notemos que el servicio ahora está instalado y funcionando

systemctl status sshd

![](https://lh3.googleusercontent.com/F5wiXn1wAoXOjHdLs5SLdLTKk8b0vWBy-SZcC_xNwcfK06DryT3Sc_PfXK0ORs6xTIkWJ14iUmoSgM776VUV0PnefPCwkt8FoeJDnNR6owiUrZYvNjT1qtJVKVQC9xCEU59LrCfA)

En este punto ya tenemos el servicio funcional,pero para generar los logs necesarios que necesita el proyecto, debemos hacer un pequeño ajuste al archivo de configuración /etc/ssh/sshd_config.

En la sección de Logging, descomentamos la linea SyslogFacility AUTH y comentamos SyslogFacility AUTHPRIV. También debemos cambiar el LogLevel a VERBOSE

![](https://lh6.googleusercontent.com/PuCsDKsg-SzQwWngeME5Tz8Gh3WFCXno3asr6qMdzu2zBNiq9oNxHm6v4_hHD_VEeYtrvoEQru5K9tXg_7wzlEHtztPrvLEgwkH0b339S3NXZhvaMkVPHbLIYly0uMDdvytwTsNt)

Ahora los logs estarán llegando a /var/log/messages

  

### Firewall (Netfilter, fail2ban).

Creamos el usuario para la administración del firewall

![](https://lh3.googleusercontent.com/Wwces-cMaXNcQCBnhOkKgsJIvd_d0VxSyQKCd4bZqbkrEdi-V7yEBh4LMQELXRovWbjX_04QqO5mL8D3ZYroM_jq16KDFGz3UTgERA-M629GTGuBOdt6ocgytl7n9Y5cE_GziH90)

  
  
  
  
  
  

Le damos permisos al usuario firewalladmin

![](https://lh6.googleusercontent.com/KDk86U5Jdf3o08IxWNheh1_PRgp7_5AbZxC_nLM3P1Lrk2VwVmvJRhFvJlOyvZZOd-Gj4oqsC4WpDfdSf_BEC4uSUC4ml-ypRTnfo_vuXtqb2MXz2uvjCT6xYYoea8FOrGyvRMEJ)

Cambiamos al usuario creado.

![](https://lh5.googleusercontent.com/AP-xu-pI0YhE6jMY1Lf4sim73zPXksX83-zNZIZ3V4tgQAMEwHkq2_GpGYTmG7EBJueN1xwgSMJAFBIcWtAORHohmc-oMSDRyl4r8wn8JbMKRDLYo3WjU5ncG60OiR-xfBu1JlkZ)

Instalación de SSH, ejecutamos el comando para la instalación de SSH server y cliente.

![](https://lh4.googleusercontent.com/v83TGE7przKXFPZ96uV5HtdXgPywI9W4BUj8lr926zH_7z5reThZEz-tEraUgP29EMe1411oIPogE3Rr6x3HnHUMtJs0HJKYmaEHB9n50jPaTUNX8tEeZeGtHUaLxU7eczxWwq_X)

Configuramos la IP estática.

![](https://lh3.googleusercontent.com/YzoASXxNETXFcCuf1o5e4So8QV7NHH5umLgjEcCdExjv8YN8fbTjUh7oZdZRJu7q7DCzrSV1bmY0aX5pZtuZMtc03f9yZwKcRguV-cP4GdM7pmcRTSzzhIGvNhIMw1_PQWCqO3hH)

Instalamos fail2ban

![](https://lh3.googleusercontent.com/h8WaTl5x9cj8NTglSQCH0m0hrv2dKHgC7sgtfazeMUSz5cPb1E-u2N06NmbNCcj4mhHDhBWyKSvIjMLHbJI6KdWDit5KpEM-nv4iHFqL5sMDu9ar2bduvyGQMwaKPKzax_jqPjcx)

  

Iniciamos el servicio y revisamos el estatus de este.

![](https://lh6.googleusercontent.com/AIO6cOpHYW1BUlf1Oaquyssp5-hjB77eUUn4B2-sbEfkHfzn9ucnKtj1jb2RVZlagXMNmNTpfH7MH6g1FbrGU6LK0uKEFB4t6QLrlouV27mHrDI4towpxJvE5kJMzrp7sAe_hKia)

Habilitamos el servicio para iniciarse sin intervención humana después de un reinicio del equipo.

![](https://lh3.googleusercontent.com/TxhrsQIhUHJQnFGidJzkIRHKJ49Xp-htKHeExTrR8jkGRMT0nhCQqGKTVLfugxNx3yEBAIcXJSxNLLr6wXU_07jYa_neSS43blEhCTyTqxXuwSUSEBaxqjqO0JFTs2B0hJlrtEca)

Para la configuración de fail2ban el archivo jail.conf en la ruta de /etc/fail2ban, el cual contiene la configuración predeterminada. Para evitar problemas posteriores copiamos el contenido del archivo jail.conf a jail.local

![](https://lh4.googleusercontent.com/e92TB9TMkxuvCrGP5gjsUCmasjypqLM9T99pAR6IUefJUMCjnFl3cLpN4RzfehU9pdZS5QFPhPG53vTwhnf9BVm6MT677W0JqNH2KQDzmuQYH6S0N4BesiMRxB7Cxcd59A6Hm6WH)

En este archivo podemos definir los servicios que serán protegidos por fail2ban, en este caso se define ssh.

![](https://lh3.googleusercontent.com/kWzj81Je31-m_hWecEot-Vr8krYNoRqI02J1DR7-aJA9Gaw9lWr2ZOjpPli6F3YCW1DDzHPhef-sHZydKS8oJcKsSJf8aWzEMlpVIIu319q-KvebL6cqdr2K0l6_LQ2xWSP9L--K)

Reiniciamos el servicio para que tome los cambios y revisamos el estatus de este.

![](https://lh5.googleusercontent.com/Ajo9HeZdOxdbxONQgNjOf6O_D3rygwvHaunF6Cj6E0UPQmepsdvcuMX3fxF0xWdkwAdAQMAM7nfoig8csligLbC-gpZ3X7ISmSPTF9XDB4RBlDvq5oBir3EIlhZn5-roOTTytx72)

Para comprobar que está funcionando, intentamos 4 veces ingresar con credenciales incorrectas al servidor, el cual bloquea la conexión al intento número 4.

![](https://lh4.googleusercontent.com/y4cb4rYlFB3OorFfU3mfVnGFzVYWMPXDNJn_-MxL6tSPSfmjSlyRitwnhjm7bTEOjsg_Ml2hqpK_vwX9S_myQJ6KK6fOzS78QHtHwFXZO3lUxrxJV-W232bL8oKtvG-Jqm8UE8un)

Firewall en modo bridge.

NOTA: Esta máquina cuenta con dos tarjetas de red, en este caso una en NAT y otra en una red Custom,

Instalamos bridge-utils

![](https://lh3.googleusercontent.com/aHfoGy5QXCFKZgy9Z4PIYqwGVT3zML0MNd17YTRWvfXF3SScAZi4UizTP2Y0nwz3vIpHLOwWSouj4nqRIVVyL7-KhkImOeiVMxNqnNVS0XgeoIBAYTuud1hPJhWegPD0-JBqkXF3)

Creamos la interfaz del túnel y vemos las configuraciones para asegurarnos que se ha creado la interfaz.

![](https://lh4.googleusercontent.com/qubUu8UP9zn0flljrK99MtUnUuKCg0KyV-6abyYkwWg9KSOL4EtgY_AkkHykPKAs5miLb1qGXvM412t8ViBtwNy54lNgOHsBiD6fFnzTLjSgRs-Dr6ng_n_Yr0JuYVzWjvTsP3PZ)

Editamos el archivo de configuración, para que el puente reciba una IP estática, en este caso 10.10.10.10

![](https://lh6.googleusercontent.com/nVYONZl3_kAPa_7GHphn_KgS0cbYNdGtYlFE4hcVG6JBS6aCJwf8dkjyjGjY11Xz3q09-2tz1QNMNDnrjPM2T1bHElduU8PekX0CcDRlF4NlImncwyahfl2HUZe7ZT3xirFVtxU5)

Reiniciamos el servicio de red para probar los nuevos valores

![](https://lh6.googleusercontent.com/Iy_WmsLy31WHjCoRik7DO0KiOQgCZcjfJQ3ZQc7aBxBUpi9QQI30_xfHpunBkM_uoZ81aBFE6B3YccqzYTcHEGESCkXMMTtg1RtEF04MSeQv6IQYPPKK1mY998kkE4sN3KZhObUR)

Para probar que está funcionando el puente conectamos un cliente, donde conectamos la interfaz de red del cliente en la Custom donde está una de las interfaces de red del puente. Lanzamos un ping a google y podemos observar que este funciona.

![](https://lh4.googleusercontent.com/PWXCLi0qKe1gvnmIORsZsmuxZZ7zKCZUaoNt08nSgz-mxzF4a80gUBcnGj4IKcXwAAsklxboaCGfyyRuUvBSUo9-ep7A1EWDSjAkceSy_ie2ayoF0jVvRvMBuhqOGRNUNvzgw2Af)

Ahora apagamos el servicio de red del puente y volvemos a lanzar el ping, observamos que no está saliendo.

![](https://lh3.googleusercontent.com/lYVjWIQbaZDxBrBcMQDsiXpWBN1K4PZXkOx7WVb1C61KyJ92G8jAXrfPE_80VWIedDxOcigRUiItHmR_9N0nbII27xrS_JsKBuCjihp-kH-KAhE5YU2XMzw-_xL_gKladwDVj0Nx)

Una vez se prende el servicio de red del puente, se alcanza google.

![](https://lh6.googleusercontent.com/6rPYwCAs8lkFMcYlthiI9trh20ato1HSRE9DbJv2sXgUZKDsQf72Yr_01uJtEWxM1MG8y7XDMnoqGlpT06TfHax8KMZ9G26AGEGpOcfvH-5kwm55PZQqckH732OgfLLiBnynTV1v)

Netfilter

Para que todo el tráfico del puente pase por las reglas de iptables antes de pasar a su destino, agregamos las siguientes líneas al archivo /etc/sysctl.conf y se reinicia el equipo

![](https://lh3.googleusercontent.com/Vg4TwjGiKGUm655uETtIc5RsiK8Y7s1Wbu3L6GLWnGseQBUA12e8KT6qtvFAP0yKEfXE3Y1npX8-nlKk76TCbJ7O9Vki3aa7swefYe8puX30GVXRhTtDdBfo-jqXmhhcPZWAIFit)

Habilitamos br_netfilter

![](https://lh5.googleusercontent.com/d4VPzUHO6IMLBXguLCck22_sD1LexJ1kUBTa1IqpgXo4soynEna2L9RCD-t3dtr2t2mOT6KHZ3w-eJRRhEOGReuEvhznaddytpJOzB-aXbMAvd2XjSwtSSY2VvY58tlOQxij3uB4)

Agregamos las reglas restrictivas para no permitir ninguna conexión, para partir de esta a crear reglas que permitan el tráfico http y https para el servidor web

![](https://lh5.googleusercontent.com/0CEboCcZRtL-RKU42PvI-_RN9tsLu2ZV9EP5-JnD9bNZ3MQfB3_jBldBRfL557y0Bb4WdYQcbDdDODuLS8dVUMzDfH3E2P7pHoCAbOR4BRKx66-rR8_HNjG1copeLfILB6_SrGn4)

Probamos que esto funcione lanzando una petición a la página web, donde podemos observar que ya no permite el paso del tráfico por el puente.

![](https://lh3.googleusercontent.com/d4Q6iHWBxBx09S3RRGqhfyEwc6l4jghbVNZatGcnDjGZLLQxFSM6FiXWjLy3W-ZT0Q3ILOAmOyZGhPQHIY9MCfIPZSyMMvA0rAan7nfvdA0-dEcRCBiGsfKXtasmhJmVcsTPQFnm)

Agregamos las reglas que permiten el tráfico http y https para apache y nginx, además de permitir el tráfico ssh

![](https://lh3.googleusercontent.com/kNgCLKYPx-3pCF0KdjMiOUCg0Z837AmmFeljVy1l-_eoV01cf8471f_HBzsWGCXdAfhdO5EBgXCFRGhYW0ZasfM0-tEqILLpkBotw0KlstiX8xojTrknJi7S13tozSU3GhQDTqUe)

Para comprobar que el tráfico está siendo revisado, hacemos una petición a las páginas, donde la tarjeta de red de este cliente se encuentra conectado a la red de la tarjeta de red externa del puente.

![](https://lh3.googleusercontent.com/QfKrxclAj5aLl4KqCuaJHWDWLzX59yk1lfCDxx4UJVAJ_AK29G-n_pPpbOccivddo36iME-VmZ4jHkvSk8FKog6eRTeu7bWJ5QRxrosgxvkGRncZrKHVJ8hT3oERU-lcKgQ_g3M7)

  

![](https://lh4.googleusercontent.com/oO1CO20nzheU4fKVUe094fCoJ4SGQytNRzUWMwzgkG4sfBQ16ce75zheaVhE8N0uSO9ih1NxZokvkWmXDmoos2xwd7HErkY7GIf2PVcMdGw9upCewe_U7ARJvLCIaVGYONMRnpxj)

Para guardar las reglas instalamos iptables-persistent

![](https://lh5.googleusercontent.com/ytdk98nxlWDk2wr-NbFn6pIwr8ZLUM3WvJ_mYXuugui4nAokrbg2NoCS5Fgt_idPgHNwg0uK4ymbqaK5Ol05bLF8I4NQwKiLQfr29UMDNo9k0VrM9zsKYnjzCzXBxOfkn0dEdjAt)

Revisamos las reglas y las guardamos.

![](https://lh3.googleusercontent.com/Qqc92pEDKz14VsJC3zO7yk3ujq4LchVJRQMSJW6wW_TCMfZIMv2hHJdlrkD0end5kYYZDm2pWFse0sTC-tOvVd7_CAoIg-Zw3x5b7w2kVj2hm1GtYq9mMMGJA1tmWEmpPrYDX04H)

### WAF (modSecurity para Apache HTTPD y NginX).

Creación del usuario para el servidor

![](https://lh6.googleusercontent.com/em7MMx-8mHg-8j8NVljYDaXjL2FhlUVP4C-gIlHoD1_zVL_8iWn2TLqP-1J0pIJUMRCkdIybZOEvodygTH7ST1BAaymW7bpvVTJPcJS5nlCzDALjQqKx5Xvd_mZ2sNY4E81L9ymb)

  

Damos al usuario permisos para la instalación de los servicios

![](https://lh5.googleusercontent.com/Q5yG1DexnA4FoF7wwMZcdloj5JOGNfnXDg30bD9S8EXzsocokS1MVKC48gFWneDkAWDOZmQ0aH7B9UIko9DLDsT-YfVjGVu7poCHTf85OvKIMn9Vq4nRom-i2ic4HAO1Ii3tVFkA)

Configuramos la ip estática, para esto se edita el archivo /etc/network/interfaces.

![](https://lh6.googleusercontent.com/We0P1DMUorG48NcQ-NENOs6LktflaD7oIW1bWIBsmFnHFLFdQXYQ5SG9emy1-ilz-GOdEXUFMCc7QHcbHEoUAg6VFS2dzUNWg7tcL0ktF3Ucv3Ug6t7l2vsT6tbg624er39e1bnF)

Instalación de ssh

![](https://lh4.googleusercontent.com/_SlOoT_hmMj3N4rF9aukBv9vPPSwICnQPERe_XXUhUWo1a7IPPSV9PxJIWmZp8AYHMpD2GMYhjKVtwgNVP0s_Ye_jfK_NmvAYURmcqwx-JgjhskfadjrPn03ySb0TeQvbvXXiazK)

Revisamos que se esté escuchando por el puerto 22

![](https://lh6.googleusercontent.com/q_jcKiRNbe5XUcL2rwMbwt_AoIF7vBbshuAwSjzXO-NaBfOvOv_qEN_-eGTOVhW7N3ZVfsHlnK-rD0yQt1QjeVeKM9cvDQWi3Jsz-xhGDZ9J2XTw-KhzA2vhxQ-Q1ghyNDxSK3-i)

Instalación de apache

![](https://lh6.googleusercontent.com/AmsvZHdeTmwQVlOVWOTq69buUfLHUxZXjv6S3W6CY-M5gdvyGLGGmsOG7LKx90R-eW3J-MXmgmJexPvS8i0nbi_ZwThOHJArkP9lhE4Mhtd9HBEz100ZNlccAkLsQCkXqjTGnvDh)

Iniciamos el servicio y lo habilitamos para que este inicie sin intervención humana después de un reinicio.

![](https://lh6.googleusercontent.com/IA-88jyVO7YmSFKJ-Ct8u2g5OpP2cImA7nRwhoJ-rfzDNeKK6T6gfM9DkMDo9NOgqQJkrGuB0CP4jYHRrnGMztQ1kQW11zy3n4ToJ9AqaUEH2m31LiNqOcSaZG4aR1cny3foLJMY)

  
  

Instalación de ModSecurity

![](https://lh4.googleusercontent.com/GT77tTX9U5cgou96AedZpusnXA-SVvTp0QVX5knYyKTH7wkSCmMop3Z27Uk4nXFEIXf4GCiHav-4zbIQInyMxRBIa6pnz-C_qJVqiiiP3jGKyVe21AZUT8wffD-k3joqnPvrjePS)

Habilitamos el módulo unique_id y reiniciamos apache.

![](https://lh5.googleusercontent.com/rVCUlxvIr-XjN0XWF8svE2GYmPypkYIHM-Zen5GJOg6bxiS0nDM3y1w1wmin0FHXg_AcwIhzY1SLy3fno05iCqQC2bzS3ZhZxhitjEZUvtAz8eTFj8IOtt5cBoh3BAOGEkYkzrv2)

ModSecurity trabaja utilizando reglas para detección y filtrado de ataques, por lo que por defecto incluye un conjunto de reglas genéricas mantenidas por OWASP, pero de igual manera existen reglas comerciales. Por esto ahora configuramos el set de reglas de OWASP.

Inicialmente ingresamos a la carpeta de modsecurity y movemos la configuración recomendada al archivo de configuración.

![](https://lh4.googleusercontent.com/Ar3N_gI-gEOu-WH4v-xmNLqbfGUsKUbE25d3LhCm00bhTbHXefu-ZfDDAUEJAAJ46DBqwYeNMBlPL1l491_w_Y6AQdU5DuSuI5E4IXViUcyIScusCyBDqd137Q8j_rT2_sGmCV9p)

Descargamos el set de reglas con git, por eso se instala git seguido de la clonación del git con el set de reglas.

![](https://lh5.googleusercontent.com/zrSwaewCVoKSjE7iQXLaSDdRM8ukBFDb7pz9XO-hY9KhpG74zpLKORWZMpStB65X0YitLe6c3VfQXzOBXQvOTovsaZdu8FCJAYsw0I4FlxvyHWwqXpaELZbDPJhAOMlXqrFJBbJc)

  

![](https://lh6.googleusercontent.com/tkxAkA-6cqOwgTSIVlAvY1Ccl6CZWufDBVzF8muqLmVV0benCUmvH97HGidJS7UiQMU-weFL0iKqbT2UpBaEzfJ_eokCG3DpiSiDbAzQ_nqQimGRBG5yc9rI5owVO1yR-E-MVLl2)

Ingresamos a la carpeta y movemos los archivos crs-setup.conf.example y aquellos contenidos en rules.

![](https://lh4.googleusercontent.com/BaAGfXQneQbIYwfgVfNo0PCur7et0Q-ODVrlcSdKGKcjuRKLvcqVvQIKSuBe-mt5iAaIne5GogzbK4vaSLYaX9CAgY3uIulJclkfiFnrAKP9qiCls7BePMkjnl7YXZaRj2al0bO1)

Para aplicar el set de reglas editamos el archivo /etc/apache2/mods-available/security2.conf

![](https://lh3.googleusercontent.com/y9LSd3vwEU7Jrd-3CFkvtOC1PL6Pe8BuHD5jVxJFZpfbbeR1HLOYXuhJXIC8ZXVMgr0UXuBVZ2MPO0jWn8jVTz4EhsEDcD4f67MxmAQVZDli1132ISZM-WGl7ligqtlmZ78Y0VWh)

Probamos que modSecurity está trabajando, para esto editamos el archivo de configuración de la página web.

![](https://lh5.googleusercontent.com/iY4fHsz5yiI5RUo357qPMQoE9p6NeXtTslspQtMYS9V2dppmircd2Ju_IoWY-YrJ-mrnQ1VuZrLazMriGlqDris7uJ690q-sLq8676ISu84yobwjuUpVLsDz1RSskru_tbvPnaSi)

Habilitamos el sitio web.

![](https://lh3.googleusercontent.com/GQrnKw6IJfrctpebUczyjfQ19SAMlyZyeN9Uvs-FaIU3w6nWvTB5qYJb86oNzH5ehVNhTPu7tZiZbEoLiK5R68669_diB6FfPaXUbOExlOW6VzN61z3Ak9ZHpU2bwlEdXjTm_e7F)

  
  

Reiniciamos el servicio

![](https://lh5.googleusercontent.com/NvZ5TQ_ZsHfyN3ZhXNde0ay_aK9LlhCLDInQJjElcOa0ydvzX8AdFFIfr50lAC-An72iSSNJ52DDgPYXv3qf2TAeIuoYNJu-879BtYu8HD93SI1DdMCmGGcu4UEDLBgTOCBRTS3V)

En otra máquina que alcance el WAF confirmamos que se tiene instalado curl.

![](https://lh3.googleusercontent.com/4nSPtX-DkGJAxSOcoif_X669Q6OZ9alGVHAzg3Grd1eiCykwrwPBlLPuE2ywdlgv2fNZ_bWxDuXPPLFvgLAlkb5KMbnUzWCktDqdNYb5xXIugmDR0WdtNcYxsCFSVedWgM28Pheg)

Lanzamos una petición

![](https://lh3.googleusercontent.com/HH5QLoSKdKcg1ySwUWJCvgsHAcZNMFRZwRHALlBWeDZnmTx-tnNesw2J2irB506vT3gUMXF0jhHlwIFQbXoMnPq8C2iqSL5x-8eITyIRP8uyzH7v9tBKA9mwzBClQp-By2nBLRAt)

Revisamos los logs de apache, donde se puede observar que modSecurity ha detectado un ataque.

![](https://lh4.googleusercontent.com/KPL27yfyMchjNaQCEDRB35MeQZK8wCmdUxX0nPcENLs0ItaNtD4dk1E71EdKKmjv0kodFPlo2l8GLh2xXuX24VPTc5t74kijLhelxuvQoIRb0RBuMIshWu1SndnZaoPY2wJ6z0WL)

Proxy Inverso

Instalamos la librería.

![](https://lh3.googleusercontent.com/kDv64RXYqDdUpsV3JhwerP3rp7D8jYOtANSAOeHxvu5UsfsbfBsS7DOPSpphDUcJVLGUSwWz4iZOWd1FjbPZRJJJFS_0rHx6ZgnnUelWWyAOohIrrugfw-iJo6YZ3yADH8FUIrZx)

Configuramos apache para conexiones al proxy, listamos los módulos disponibles.

![](https://lh3.googleusercontent.com/G9Ny_b8c1wFiLeK6PdgFXpSc5BCVGg_Mqi_HoeiRiU3-IT1PSDi4JxOz54Ue5tPcSQChJry_7oUHyp50XS-12Vb9pn7P06rCdVED0FLb4lczm4qjfhcPxCeIYZSaePvBPV6XklCx)

Posteriormente escribimos los módulos que queremos habilitar.

![](https://lh3.googleusercontent.com/6QhOe-iAD3OV0LEeU8Lu9Ld0sQ0c-1Gq6hNg1CwA0bjynIHCF8stOJlIIxm04l6ai9sfGWQ7IYkkgAqgPEJAyV-xQ9TzOTkkwVjw8UjmAgQVLu4gNXCRPWA_4R-iMUkjqsESHfmK)

Por cada página, ya sea por IP o dominio (dependiendo de la configuración) creamos un virtual host en nuestro servidor proxy, que redirige al servidor donde se encuentra la aplicación web.

Apache HTTP

![](https://lh5.googleusercontent.com/otnDm7CgUgNof5PLji_lwO9T7cYD01E7fpydJE9oCQ3Zw4z5Icbs6tqRl41fCwI6PKD5ArSVYLXb8wFvXgzOSUbTtz0REuxIxz264m75PGIftT7BkYKc_KJjHxiNvn5DQJuUWAgM)

Apache HTTPS

![](https://lh6.googleusercontent.com/gwJXeaCMDUhXSY8NLpEuCZiTaM5r3Y5E5jA7JUMU0xuE4XbpFs4tL2e-GS6mzhIJf35veSfYOZPspvCHwZ6dEIeJ81Y62AO8Oa8BtrmDJEEsfuGl90tSGfP3FXlH1pfxv_u9rUop)

Nginx HTTP

![](https://lh5.googleusercontent.com/lebQuAk1qjjV6OjcHbPl3D4h3Rx8RLcu3H72Zj_QeqCqQOPjJPnanUAdfPYfkiaSGLKwWU1Y--lOVRGUr9Ltvc6yk4XLawO1-hRXDXqgVThT3BCdBJvmUi4S9-gSkG0doFwHqbW7)

Nginx HTTPS

![](https://lh5.googleusercontent.com/iphdVdTZtuf30hJZxZWk3HwlOK4540WUrtPq2rhgIFpD_0FzaFaFBidh7VlCFi-GICYxCQMNCReN2PZa21BT5-A23kdKbsJMstgmLxqLR7Y1nx2xvJliE1ipvBMQrPp08TEk_99h)

Habilitamos el módulo ssl

![](https://lh5.googleusercontent.com/v1ql_XcrskTyQWUsK2aLk8Se7PysxD0CPw_5FVD1uaZIyED5O6I_klGGl5mnYqEB8vezIRtkrylo6-0eYxhIXTenx-Wea6Ku-DWNKyh64aQRYtfsSHlcF8edLgEO8J6g6LJoIWms)

Habilitamos las páginas

![](https://lh6.googleusercontent.com/4rLIx5LaDGZ5HpVROK-JMIbMXjtj-I2pLhQwfVyM6COgw4X4BJBhb4NOe08jXD6n_X-O06OKMH9JMeI9LUFXrLQSQ3kPzGtc__gn3rleq0jYn2wEc-lJJfv7RUCPuJJjM3Ty4xkv)

Una vez hemos pasado los certificados a la máquina, descomprimimos el archivo

![](https://lh5.googleusercontent.com/rsecJpxenRfbHaUqjip4-0zzW34lzo4UPla1oemLE_4bqPmDT-HEmLG-2vcD14B3LBxDSDm4ZOi3C6mdYfrDwatY_VHfjOwVxC-UpDE_GRr2psw1EHeRsNaUUxF5TZOG_qS1Kk7K)

Copiamos el archivo a las rutas /etc/ssl/*

![](https://lh6.googleusercontent.com/hsTuU61LZ51_X1m6NqyxIkzjLJOH4VkpUlVZbZrGOUyAh1Ol2tHh6vSHS0S6u5dkVOOQbhfpV1NkcULxIZseR2UcgOhiBtWWhhqMldRkIy_pyC_WNtqv3XuLIHX2W6pTl1yYxrBz)

  
  
  

Agregamos todos los puertos por los que estará escuchando apache en el archivo de /etc/apache2/ports.conf

![](https://lh4.googleusercontent.com/pf6JkbXmwGtAkKs9NJvkGiV5840HeXhu0Lb43lVdz4XoHiMSrRu-PD4vJKP8RX-tJ-cQVfNswqxbYibrk22hGvEUfRb_Ik5MurJr_XC0-RsGYFAvqtjXl5tq6Nxgjs5_9e5AFHts)

Con el navegador visitamos las páginas

![](https://lh3.googleusercontent.com/i24luZbX1J3eV0hT72ApeQEqlos2ES-fSuQu6tH_fJmDmTi_f02Ou727mw9F7DvUe-dxthSznTDzgEEO3sOxy55eLrexW0d5T1E8Ex9U3ypfCOk_QQ_N-AdlXB8YE7QMqK0dXAPd)

  

![](https://lh4.googleusercontent.com/5hToedHSI0T1T49FrYNYiPTELTG0k-MjwPCOZsduaJrGwUs9Igr98G3tMB8jPdp8A47fGaVceSH44y8dsdkMPpgbyd_l6SbPKohKzJHivEj25rwo75T-3vQ3Ci9ToSQ6q9_YgNrx)

![](https://lh3.googleusercontent.com/__tH7aVlE0haFKMOYBMLhrm1tMJB_oCZ_Sv7PxPXbwejdCuK7zHgh3iJSD0wq3qRWr5rDuHFtYoHfpHUOyjg6YdksQkMBbnzdVeDlgZcD-d6M447-Rk8XU-gJxlNwV6nEdFhCseH)

![](https://lh5.googleusercontent.com/-sHKdRvsgOO6Z_i9EK8h-Vk_mHzmde0rqOLLhrfEV-VZnypEEkKzk61IZc2CgBhpsGARObwXQgvAmW02SbjAG3boOs1Rq1opqsV-ZiApBR7MwBcYxFYMV-c1NY4eEvURJZQkKKmA)

Para comprobar que efectivamente el WAF está funcionando como proxy inverso, paramos el servicio de apache y mandamos una petición a cualquiera de las páginas, por la cual no contestarán.

![](https://lh3.googleusercontent.com/DvJMFehMG9V8Sd4_YhFC9oZ4UTI1u2xeKU_oYKARsNwSsEO0UU0FWOlhlIIrBrcG_mC4VXnZZZ4ezcGkc6s8QBR5r9o6G2jGDJwc3xOGGLV6s98tueQYGIR369GMslrJFDMYHhu6)

Al encender el servicio, la página responde de nuevo.

![](https://lh6.googleusercontent.com/JQaT_KfPayZ1pe_KJvEraEcPYZL90KQoLY8u47NX7JOW6XA_yf-dmadYY3m4qtqH80okBzsoh9WwQK5I3rKbGK5sWvJLaxyyw_qOl3TmOa7x8Rx5Zq8_fYeVgZIe1WbRPXYpw2Q_)

Para probar que las páginas son protegidas por modSecurity generamos una petición maliciosa con curl y revisamos los logs de la página atacada.

![](https://lh3.googleusercontent.com/I8wdfBF370Q6_LJ6vG8JX-wHNS1Vp6VGbcz4fo_PoydXnLnPWNfQEjpZTBYUbtFm_9TqD4p_86cxWm9DSizmIcTAikxjPS7kRonQquJViQgK5W7OeD5gmL5W3SQSf9YF1bv-0syB)

### PostgreSQL.

Comenzamos por instalar el paquete. Para instalar PostgresSQL 12 y todas sus dependencias usamos

dnf install postgresql-server

Con esto el software queda instalado y ahora solo debemos hacer algunas configuraciones.

El paquete Postgres que instalamos en el paso anterior cuenta con una secuencia de comandos llamada postgresql-setup que ayuda con la administración de clúster de base de datos de nivel bajo. Para crear un clúster de la base de datos ejecutamos

postgresql-setup --initdb

  

También habilitamos el servicio para iniciar junto con la máquina y lo iniciamos

systemctl enable postgresql

systemctl start postgresql

Ahora que PostgreSQL está activo y en ejecución procederemos a crear una base de datos de prueba y un usuario que se podrá conectar de manera remota.

Entramos a la base de datos como el usuario psql y creamos nuestra base de datos de prueba con

create database database_name;

![](https://lh6.googleusercontent.com/y0QTg3ip-3lEk5jA9vXEwu8tQx_UCrGbvaD8QfyF8SD2kD2LP8EtKJqbBIAHI4arf9IrNBjGxoHYHVeULubD7UE_Gk4y4_JNqlxUvahpxbwRiwnTVfBI4O1KQ59wOHf4hZbI6Q61)

Ahora debemos crear un usuario y darle privilegios sobre esta base con

create user user_name with encrypted password ‘password’;

grant all privileges on database database_name to user_name;

![](https://lh5.googleusercontent.com/GLVkf9Uaf7MhV4PI0nSsISVlQg9lzeyfBX_BSFJrIeYbkvV-igO4A6KsoPIG9zWvoBPeAvaI4heeuuDWBG8diqq0e4u0qIMoXSl6ORxqXkFPKKWNFfVV3jyC2kfRoUTZTuLZo3xy)

Salimos de la base y ahora vamos al archivo de configuración /var/lib/pgsql/data/postgresql.conf para permitir que el servicio esté a la escucha de conexiones. Cambiamos “listen_addresses” a * recibir conexiones de cualquier ip e indicamos el puerto sobre el que escuchará

  

![](https://lh5.googleusercontent.com/nLw4YBKMk3u0cpTxz5ieLs1vD_HrmDH04GJtFYXd6G7e9fx7arFcMCCI5UiZgRSll1rUj28_mgSVcE9BgJEjU4T5brsA5mCew_XB9qcEIZt1npm1VbSiurwbqtHfpfwHowUcoY12)

Ahora se edita el archivo /var/lib/pgsql/data/pg_hba.conf para indicar el tipo de autenticación que se usará, si es local o remoto, dirección ip o segmento y la base de datos a la que permitiremos la conexión. Deberá verse como la última línea de este archivo

![](https://lh6.googleusercontent.com/MKdmWEGFfbDCC-A_skV80tJvqmTqYCK2ZAE2KUNdIlHQb5mBJCDxKbsz3yfI7myogj1Osanx40qY-EMs49FhuskT0jQx-tbw1dw7Q2nHqlGJ5l7urOrRqghsVy7CrjfYw9Ga-yD-)

Por último, debemos permitir el tráfico del puerto de postgres en el firewall de la misma máquina

![](https://lh6.googleusercontent.com/dRyF9-lLi_rW-Df6evSDk4eYWrxBF2DXFM-jO-fc5N8tWih8FdiJO1hipHHrDL8lXiiMtM-Ydq6GW_LE6WBGgoyqlBMzbGoJ5xuZQfPqcff6aG7PVGq9MCLd5liLnPnSSr5PTYcy)

Probando la conexión desde otra máquina con el comando

psql -h ip_del_servidor -d base_de_datos -U usuario

![](https://lh6.googleusercontent.com/uoKumxfGLkSUWfAR52lzNm3ox6Yv16AKpYtjfet4ALnxuw2V9Z7DM08Ci1uvK_IxEyq9MJc7AP2tfeLzyf0_w8IYJzYY8eU8Tei8fsPQHhmdQ7cn-CBkTvm3HXcAys58ffsiFBWz)

Notaremos que el servicio es funcional y acepta conexiones.

### MySQL/MariaDB.

Comenzamos por instalar el paquete. Para instalar Mariadb y todas sus dependencias usamos

dnf install mariadb-server

También habilitamos el servicio para iniciar junto con la máquina y lo iniciamos

systemctl enable mariadb

systemctl start mariadb

MariaDB incluye una secuencia de comandos de seguridad para cambiar algunas de las opciones predeterminadas menos seguras para aspectos como inicios de sesión de root remotos y usuarios de muestra. Utilizaremos el siguiente comando para cambiar estas opciones

mysql_secure_installation

Se solicita la contraseña root, que no se ha configurado. Pulsamos enter como de indica y luego establecemos la contraseña. Luego se nos preguntará si deseamos remover el usuario anónimo, le pondrémos que si.

![](https://lh3.googleusercontent.com/rHCOihlteK7Wt-0-HOqpy7jVWwpuJ5YdjK9YDB6LA2Q5reIBtLuLIpnsTGFGGFWvdl3fy7k3yq4bRwNnlwWXolF8hmfH8Uge2hC61FYvb2WvmdwNfSx8lhGwLkf78Zwo3p1ZQnvt)

La preguntas que siguen durante este proceso son si deseamos remover el acceso root de manera remota, remover la base de datos de prueba, y recargar la tabla de privilegios para que los cambios surtan efecto.

![](https://lh4.googleusercontent.com/1JHWrOTI4AOdAnF0Yj5b4vx9MqftV9MYdqvo0supDVyZLbw1yt0dcBcw1oXw-DK8aPD1ilX8AyQ4h9ZqxThdfYGR_j-c7Od61f7k8gfMDpth5mC1de1QXRTIYngLSZ84zqQnK-wh)

Ahora que tenemos el servicio funcional, crearemos un usuario y una base de datos para hacer pruebas de conexión remotas.

Ingresamos como administrador a la base de datos y usamos los comandos siguientes para crear una base de datos y un usuario

create database database_name;

create user username@host identified by ‘password’;

Ahora le daremos privilegios al usuario recién creado sobre la base de datos que también se acaba de crear

grant privilege on database_name.table_name to user_name@host;

![](https://lh3.googleusercontent.com/tN-5yhqmUg22GRlDAwiSOnA8HqDzCkflTuDb2I9jgfrsld0TGpiwfJI0htd4Zi-8NN0g-5gWUVd0fkqvJ5Wi3MkSuCgcB73BLX4Ys75PtI6MnwofqmkWTe3z0nUlppBqmTzkSofx)

Por último, debemos permitir el tráfico del puerto de postgres en el firewall de la misma máquina

![](https://lh4.googleusercontent.com/DuhkWITYY4RKMHB7bsiST2gSKO-3mPqEYdr57PXB7bqTC_bRuA7_2aSYMjGJizwEHsTys8QFKGG__hVHCuN8wIVyrVkQeVwVcs93CqYtGbKq-QinzNdvUJcd-ZSDvcGsOAAHpo5H)

Probando la conexión desde otra máquina con el comando

mysql -h ip_del_servidor -D base_de_datos -u usuario -p

![](https://lh4.googleusercontent.com/z-f-qwxqVS1xmr92zUjNZYRM9G4ysnjLS9IJqK0YpvgY4uEe3inXiE3rx4tqeYr_W73hZ2XudVyk6ok2h3E_CaUlMsV-wvK_eKHLQKEjmdNPiGfWDGHB2H3tou7SHAM-9c7INCC6)

Notaremos que el servicio es funcional y acepta conexiones.

### ProFTPD.

Comenzamos por instalar el paquete necesario para tener el servidor ftp funcional con

[dnf](https://www.server-world.info/en/command/html/dnf.html) install proftpd

Ahora modificamos las reglas de firewall de la misma máquina para que permita el servicio

firewall-cmd --add-service=ftp --permanent

firewall-cmd --reload

![](https://lh3.googleusercontent.com/Gxw_tcJ-BcG1hEPFQp5eqjmHqqSfPyeMe4urTMZIfU6f2li0TIxrkoAYoy_Fw4Y6SBpdNx27I-2oteYSRO1EF_Dnwg76hlYGUhnpSv1nBx9l7wSbyxiGL3f1n782SHKB344AAS6i)

Notemos que el servicio está listo

![](https://lh4.googleusercontent.com/elBN2E8cBUBqnzf2q2ue8XdvnI7npRjnclg2jVSBXIE0hKWFF0NBoEwiZcLcuAQO3Sau7yFylwThL5olXxRvmI9sus7YJzeMG7BS2XvWF1YZ02PhYpL278mHyelTqKrqERsTXtlW)

Ahora probaremos el acceso al servicio desde otra máquina. Debemos descargar un cliente ftp y después, mediante el siguiente comando, ingresar.

ftp host

![](https://lh3.googleusercontent.com/5BWwjMTh1XCFE0UT0_hqLlbxytqhKb83yk5BbzoJfiEegorpt9D_GK35flnOZm9A8TW-ik8utV0jY-UB9tp9-cxOoWERDdDZUWcs0FpdvB3VkIutTQ0zWvWoe0o5_7uUriu2-pqh)

## Dispositivos de red.

Para los dispositivos de red se optó por utilizar GNS3 debido a que este servidor nos permite emular distintos tipos de dispositivos de red así como utilizar máquinas virtuales de VMWare.

En la siguiente imagen podemos observar la topología resultante.

![](https://lh6.googleusercontent.com/IbghapYG2iIgIdNrSOJ4rZDcPcFqQcTEMRgiLD7Yov5Hn9MUZVgxTajLLvB49JEo25Cb0bqGx4E_5sQyXASJm9JyaCABFrM48ugsMGhHbwoVjhzAHeFO8OjFZTOu3y4K7u_l9iCO)

Se realizó una importación de las plantillas de los dispositivos de switch, router y fortigate que son ofrecidos en su página.

![](https://lh4.googleusercontent.com/fwddoljbbya81tfKufHrrj46MZxk58MC_9H522__TmVhwlGKjwdaYRE0kA44_Lb1bqDMsVKoR4rf4p5DVvVodkcfsMzgHJI3D2Xl3lVibLZS_d5pkrF-isUEf9Y34W6uG099VEC-)

Una vez instalados las plantillas es posible crear estas instancias y configurarlas. En nuestro caso se configuro el router y Fortigate

En el caso del router se asignó una ip para realizar conexiones con el fortigate. Se utilizaron los siguientes comandos:

![](https://lh3.googleusercontent.com/THPf2l4NnRGxML27lTuT9rbba9W8dryUvxCnm2jQX68Qg99bLpAoUDR__Ja14ptJmJZ3XVEXMRSMXzEG9uEAtSGqhV9acacdRkXEpk4PuOHrwMGh296iOda28uA0aGznfbpc0o9d)

Posteriormente pasamos al fortigate para configurar un puerto por el cual será administrado.

![](https://lh6.googleusercontent.com/w8Gb78bCGz9qUYuv3tZnPlvPBKJYtObgZJSaCMMSpl0gelqiT5foOdc28mPpTaEG46i7sU3mYpSRrMiSOFfsn2lLZkhilq_raUkmM4D-ikXOtXLMqVT9Tv6rdy4sM_UeRzr--tfN)

Con esta configuración es posible realizar cambios mediante una conexión por https y utilizar la GUI de Fortigate para simplificar su configuración.

![](https://lh3.googleusercontent.com/HJQdOHTmWLgZID4WIbTk9UzlLpGLLIfD7xBAS5vb7QPeTbnwLYRQeEicjgeSz-64JUM0dxAJ1O5gIElcY86tzd7MJgyEYkBZZXEUMh3AqPiQYCX3fkkhzdmJXvtyDCjP2dJ-CcSY)

Lo siguiente que se realizó fue la configuración del resto de de los puertos para permitir la conexión de los servidores con el router.

![](https://lh5.googleusercontent.com/rLa48-FQShm_CZfbVXgzrEOLerzHTpvJvhC-O1HxhcKxiWwmQ-TgGJIU3_vSsg3LIhiTQV7CQLz28qtFrS7AgIbOjZT_cKfGdlqsPd0V20bRaQkeYGLxXvAhpjbss2uBaAkfNrZD)

Posteriormente se cambió el modo del NGFW para que esté basado en políticas.

![](https://lh4.googleusercontent.com/mQhTkqqtR_LH2gcYgXSlreLwVu5LiHZV7Psz9zHLR9UKpAHgJ2x9kiKpVCYUnOCf_l6Rht7RKjzhNeFV4hp7n3jL37dMc8sJfsqPxkJW8EXt09NIa_8pcwTJbQ1g9Oket5uip5pV)

Después creamos una política en la cual permite el acceso total de los servidores hacia el router.

![](https://lh3.googleusercontent.com/8xyxguyCCrXCrLZfFOJNGdOmOHcMFTm-_nU-_UbLiQeDXA9mZYjoS-jMvjMCbc62T-r0VlPlrqqqh9lK0uqBL-AbPGf5TL6QQjtAZfZn4uqNAqfURaoHvuGcHiWyT4zC7ItEFI7s)

Se implementa una regla de SNAT para que se haga la traducción y pueda contactar con el router.

![](https://lh4.googleusercontent.com/GppHDjjhc8jAPbB7YPZ2nitgtZSm1VNugxqA7HNHfC9pspgvVByD41pkAa1AeoxXpVzwevBBg_j9znmTHUcWmu8h8tS6ejcXdLga9zN2OtqPG_nDRHRUdzlGH58eatqt8DYOyUfo)

  

# Instalación de BELK Stack

En esta sección se describe el proceso de instalación y configuración de cada uno de los componentes de la pila BELK.

## Beats

### CentOS

En CentOS debemos descargar el siguiente paquete.

![](https://lh6.googleusercontent.com/1itH1dbQ8JxHPfSe4C0hRkQ9HFVIU8_k1FpzFURvb0JUBxrHC4O-Xvo98xsu_qkLVLxvuRBiH1V3RxAkGgjATdhTPhh-FhIvJmzYNt016AMbIFuEdFpO7CboFV7cS6A3PBlt8jhp)

Posteriormente podemos instalarlo con el siguiente comando.

![](https://lh5.googleusercontent.com/VegZ6NtmTkgSONSO7ECmO8sjlZ0Ob_l42VvyDAiKgJdQjMGbGCixW2ji9LsuvzR-gCNJQ1ecxu78Ps0M5ZSf_L3bmbxE1lRtmb6axrBr5RukMc4eclI_-dTDVdOkyfAPZHWsGBBt)

Ahora debemos de cambiar la configuración ubicada en /etc/filebeat/filebeat.yml. Cambiamos a True el valor de enable para que mande los logs del sistema.

![](https://lh4.googleusercontent.com/e0sG6QquxSr4B8rxrkpCrddz7H0eL1w-Qu0hsSb0tXhAxLl2TsYDPh86Lwcn-TJ8qEQL0qauY2cyWhPTMvFF3bsHOG9agENeMS18hsC3dQGMcCoFpqmUWWT_PjymMgeonPGI1Jne)

Después comentamos la salida para que no se dirija a Elasticsearch comentando las líneas de “output.elasticsearch” y la línea de hosts.

![](https://lh4.googleusercontent.com/aG-N6BqUOpSFI1inX4UzROZPFnEYhzR6JgUMAc3eNnoQ5w1vLgCstbO1ectZdzXj1MjziyIzNXgnz19S0-DSWBWZVJB6cLaxH9U5g8kUC4qSHIFDZeMtaIVp9sVFhCYpxmrSra90)

Y descomentamos la línea de output.logstash y en el de hosts colocamos la ip de nuestro servidor de logstash.

![](https://lh4.googleusercontent.com/ALHjc1e4l7hN7Bzl91TFY-bkVBgp2twKUUWScyEKFuPEaClrYOXnbMBEiwhOHIeJiw0PMas015VZBcN2rsjyqmasqiQOhISsJCB7H-Dj6Bdwhi2Ck9uYBQsZoVqbN08JdUdJIr57)

Después de eso podemos iniciar el servicio con el comando.

systemctl start filebeat

Y para habilitarlo ejecutamos el siguiente comando.

systemctl enable filebeat

### Debian

En Debian debemos de descargar el siguiente paquete.

![](https://lh5.googleusercontent.com/mSlt_3GsPxQ3W9qaYPeEa28a7obZZ2yH3V0QvfZb_onKhkJ6YJHOjrIcE4kUYt5MUm25x5Kv_KIAVwAdaL71FWhIWvYQ5XNuYkwQ7iKsZ4vWIytgYQxOF4uuXJqwArvC3-z9WvbN)

Una vez descargado debemos de instalarlo con el siguiente comando.

![](https://lh4.googleusercontent.com/kHBMjQ-9jf-wybyAfOVsJNMC-vzOCtb7cV7C-BitvHYx8ptI-Xnd52b2Sc9W5iBJsyF6oYi1bEKnMpG1OWV3QZtnTGjitG3wleOYIPZUaUptoEpYtm_EbMDgrp8J8_GmlXDxIQLb)

La configuración de Debian es exactamente la misma que la de CentOS por lo cual no lo colocamos debido a que sería redundante.

### Windows.

Es necesario descargar el siguiente zip desde la página oficial de elastic.

![](https://lh3.googleusercontent.com/AEVi82ON7Xj6rNLVDNjjdTmQXO51VjTRoafiZZCEcO55iLbgVNDOtm7Xct1EgE8DHqor2WJGxchVSCQ-5kZOHNBjcS0hbfYHi6lb8FOA5NDEXXnffflTWIFghOYJR0z0PNa7ENrZ)

Se descomprime en la ruta C:\Program Files

![](https://lh5.googleusercontent.com/2qaWn0HqWfpp419EW2SgV3oQc4tTOhOx9URPCmdzT02dXH8ysdj-VCHZjoF5ZVRK7Z_r2qnC5lVJcTT-uamr-2iBOjfW9J2KENbvr3MhR58ogh8HarXvHZRfWBxEZnlmBiCueBy9)

Después cambiamos el nombre de la carpeta.

![](https://lh6.googleusercontent.com/JwtIfAvOu73xuH8b0dZlyOCNhcXLPgPVp_G5_Xqqki_gtVbeGlx8nqvZl9kyKfg8ledNstk-l1fAcrHwI4EhOZpxkXabkMIhGddn6_4coo8Qmg9Nh_iduDCC47NRhg_bRy68Nniz)

Después lo instalamos mediante powershell.

![](https://lh6.googleusercontent.com/zYoflNDO_1g1oWnTv1ZmT_FrRX4iSmGWPcUQyTZTGXWS37wW-oy0uQZfnUfnoDpDPQnAejhXZg64RaZflC0KGrdN_WBESBQ4FXBqN4KlicpRhb8uAxmjMgBXsQenEJAqh9ttG961)

Después realizamos la configuración en el archivo winlogbeat.yml de manera similar que en windows.

![](https://lh6.googleusercontent.com/yiI6UrLyGl6lp6gS4AyJHB45NKnC6OKsdJwkMXmC0AwtniQs2z6oEbqhFiOKDThORCrZkJnjDZL3lGUHwWjsaVdsmSgzq_4Gdbhd7kckRu9OybscljhdhHjnLq6RRY6zkl8CGopW)

Después en services activamos el servicio.

![](https://lh6.googleusercontent.com/51pgqLXx81qSCKdOoP7a9QkRIHxRbQs6S98W7T7IMhoYZw6E1PQz_1TkdQU-PDxSlDUFF6pyiK_sN9YvJmxP9-nS0qrnkDLLFCm2X4Klt60_4qd80PE2gBVp87tA2yqaZn3f0Y_r)

### Dispositivos de red.

Como en los dispositivos no es posible instalar un beat es necesario mandar los logs a un equipo que sea capaz de procesarlos mediante syslog. En el caso de el router y el switch es necesario. Escribir los siguientes comandos.

![](https://lh5.googleusercontent.com/FlUDmsQZ3E0YJB9fZq3Xsst0JohepaHITB2GL6nMdKh75XS2gWBidJy1lfku7xAEifDHyjfAC_jUNdMDj2eOSaO1r7LcuNDQ-PuQjuLwYa0rshD7kKsF0Zc1Zm9J7aEOKCpNsTWh)

Podemos comprobar el funcionamiento con el comando sh logg.

![](https://lh6.googleusercontent.com/VIHFLfohmnMKR7LVUqYnS1JGMkRc0noV-a08ua3BxlF4-P62sWjEJ4IeZkyKxuEcu_mKiLjTek9WoDKf_doTRiVtnGkxi2TmmjwIOaeWTJdyOO-8q5HnjHypf7FM8ix62p1YhsJW)

En el caso de fortigate también activamos syslog mediante los siguientes comandos.

![](https://lh3.googleusercontent.com/q-xATCVW99UfMcjsu9fFv7JyT-Ps2NW9AnYlDhELKsqcMftfPs6zj4nQ6q3AZUme_YJu0UwCsZmWfjdFN4Hy7bzmtf2k17LL-xyZ_xb_fbj_QjuU1b5VKhk6ogEK3Q-R51Tf_Gqr)

![](https://lh3.googleusercontent.com/d17PTpkbTH1UnLnlPidHb2uT1_AckCjSskhDDj9rprVDV8C2skmB3i3OoksZWs-G1JmeZlxeHpB3XdiE3U6fbuwXGFhOr72bMIlZ_yuvnM2VVLIK_2iZAfIwCpRWfzx2THeGJGQ_)

Una vez terminada la configuración en el servidor que recibirá los logs es necesario instalar filebeat y activar el módulo de cisco. Para activar el módulo de cisco es necesario teclear el siguiente comando.

sudo filebeat modules enable fortinet

Una vez activado el módulo debemos de configurarlo mediante el archivo /etc/filebeat/modules.d/cisco.yml

En el caso de fortigate se hace uso de un filtro de logstash para recibir los logs y procesarlos.

## Elasticsearch

Lo primero que debemos hacer es instalar el paquete gnupg, el cual es una herramienta de cifrado y administración de firmas, este paquete nos será de utilidad para poder agregar la llave GPG de Elasticsearch.

![](https://lh6.googleusercontent.com/t3bSj8yN_efYCu6t-d2dAgWJ9AIUrmYdVOVAy1rFcnL59pRivkR3Wtva6kyF8Ax_LG9rHeV1aXA1b1vRWg6FbpiqvpoIrC3F6DPdNCgqKGXKON30SUZqv5CWLcq9PBO-BqUit3Z3)

Una vez instalado, descargamos y agregamos la llave de elasticsearch,

![](https://lh6.googleusercontent.com/PhQpMCX8Vep7ETEFaijxyLeygCf6ZQu8KCgrAS2BPExmHgvvnsJXYvQ0N2F737hjFT6ug1OnqD3X4OmAq9Dg9TBvKsaEI9yv3F3EaMRebiShV-9Z7ohT6SKcrs2SuyyEkrESnWIy)

Posteriormente instalamos apt-transport-https para habilitar el soporte de HTTPS de nuestro administrador de paquetes apt.

![](https://lh5.googleusercontent.com/kylDOAOrd_-kzrhixnqSaO26064U1aWs3VAq5Xis6Fct9fjaiJU7l9OWKEzI64HbjT-VEghWZZItcz4L-fslhdiQVloREfhmQeeK2hUZaT1n0rsI_G0df0EE_rzpP1mai9MeB5A7)

Ahora se agregan los repositorios de elastic en el archivo /etc/apt/sources.list.d/elastic-7.x.list.

![](https://lh6.googleusercontent.com/pEt-DTYoTURq_RegPsjncGvTQ2ebiA7hA7GwuhDhqBfvG4_62hdO9sDd4taf4waNDH81uYvfRoJXIlmL9RpHrUo6gw4zqZ4NkNZYkTfqZ3uORbMPlEkCctlAhORwnq_TYnct5waU)

Luego actualizamos la base de datos del administrador de paquetes y procedemos a instalar elasticsearch.

![](https://lh4.googleusercontent.com/PaGVhzeqVgiMjLm0vVeFf6O46JQShKJZ8OkRhyPdUEu4N0xBKEYyMB0RjLq4Dv-i7HkHX2wQDjtKZo7ovy4elCb0z7RGJ66JlSSuut0qUvhpngFe6oFl5ZDa0ICWEPC3tOoQGanI)

Una vez instalado ejecutamos systemctl daemon-reload para recargar los archivos de configuración de systemd y generar nuevos unidades de servicio, y luego habilitamos el inicio automático de elasticsearch.

![](https://lh3.googleusercontent.com/mySDJ2fW9ukTgqOFkiDfK_UvSFDvPzAUckLkhKCCBj5Y5G_5c2UHvEDDZdA8p_2ijvCPpWVJsaO5NNAIj6eTWMAmU-fiL__dtfJeA46E1ssoZd8t0EcuP1Hn3-dWjPDyoP2RWdb7)

Ahora abrimos el archivo de configuración /etc/elasticsearch/elasticsearch.yml con algún editor de texto.

![](https://lh5.googleusercontent.com/3ckIyvhvHrEs6Wy2P1VFOFmvCnFhMLPPLfpqVJqedEMd8bXe9GcSlhZp1MU6Q0KStaP7nYRKvDR_f8tKxECApoKUkW9e2kdySTa1yTxmQiVVOJxaR_idEfomi_LR_twnym_S_7iW)

Asignamos un nombre de cluster nuevo o alguno ya existente al cual deseamos unirnos. En este caso es un nuevo cluster. Además, asignamos un nombre al nodo de elasticsearch.

![](https://lh5.googleusercontent.com/ezhauOmLUCM1QjE1mrNE_MY_nUhf8S-U-O-Y0p2P0OSngrSe6dyFr7AgKhJ-jTW_iS4xdBkZb6ySvhh8M_0khetJCrsk_Ks1oCZkv15Q4po7JeAV38UopRK51_fox6MSDVQSZpqD)

Luego establecemos una dirección IP que identifique a nuestra instancia de elasticsearch.

![](https://lh5.googleusercontent.com/nAp_43zDVVHCT9KZAkYtJYL4ojOiMrcChI0e9PirB6oFVVATAYIdHR7qaeDzga-7kpheeADnUblMR5V51taopfwxI6yu5OA6-obY2jcc9tWevzrKsTGzwvkJIX8QGI8Q9rWKRRUZ)

Lo siguiente es indicar la lista de hosts que pertenecen al cluster y que tendrán comunicación con nuestra instancia de elasticsearch. Debido a que se creará una segunda instancia con la dirección 10.10.10.25, debemos indicar su dirección IP.

![](https://lh3.googleusercontent.com/uthYWEB3kCI-RMgTEhqcAxMkED5ThvuzbxUwI-lNCZPLvF31xssXVROgOkNb-Aqgp1-Ud-LK0WktFIQdCUJK0gmA4IPGXo8wA0UbaHQLWtoBoYDg8nMR68PmGhFxyj07jVJCZNDs)

Ahora debemos indicar un listado de nodos que estarán disponibles para asumir el rol de nodo master. En este listado pueden indicarse sólo un subconjunto de nodos pertenecientes al cluster.

![](https://lh6.googleusercontent.com/59V8pVUEURi2wNWmy_BRh-fV335sP1Hm25fNzkb7iof5lZdfS78GfD1urOy8RqtDfTERwTznmOCTbQYqwXABQLb9HnU7dqCu1sz7NDWsheEMAYFrzXK0INZw4WqJ7CuqTNwpgf2R)

Posteriormente iniciamos el servicio de elasticsearch.

![](https://lh6.googleusercontent.com/dG7oYncPPFHIC48NsemDa4e4sDEG_KsCsyhN1PkKgogBskn4Q6GrN_Snt8rvgBW39ncrNavz82zCo6xNh-KbFL4_oWnjP46bEyU5tYHcTXq9hnncpE-sKJVN2MXD6cxSd0Tm_n36)

Finalmente verificamos que nuestra instancia se encuentra en funcionamiento.

![](https://lh3.googleusercontent.com/Z4fi3DRmFxv7F9FzdG6IE-X5xVJQ76DqLGrKWChZn2h9ComhK0Knc_5fP4wNavq8cHcGtO746lS4a1WLg22Oy8XC8sUVfrhNluPfnYv0AqEEKA7YR6p-Xb9jBL_ytwrPgiKYj_jv)

El proceso de instalación y configuración para la segunda instancia de elasticsearch es el mismo, simplemente se debe indicar un nombre de nodo distinto (es02.aafa.local) y su correspondiente dirección de host (10.10.10.25), además, indicamos que deseamos comunicarnos con la primera instancia (10.10.10.24).

## Logstash

Iniciamos por descargar gnupg con

sudo apt install gnupg

Los componentes de Elastic Stack no están disponibles en los repositorios de paquetes predeterminados, pero pueden instalarse con apt una vez que se agregue la lista de fuentes de paquetes de Elastic.

Todos los paquetes de Elastic Stack están firmados con la clave de firma de Elasticsearch. Así que agregaremos la lista de fuentes de paquetes de Elastic y la firma.

Importamos la clave de GPG pública de Elasticsearch en APT:

wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -

Ahora agregamos la lista de fuentes de Elastic al directorio sources.list.d

echo "deb https://artifacts.elastic.co/packages/7.x/apt stable main" | sudo tee -a /etc/apt/sources.list.d/elastic-7.x.list

Usamos

apt update

para que se pueda usar el repositorio recién añadido

![](https://lh3.googleusercontent.com/j24PAZtVaYR2WJP9vN_1Degiks5fgZG6arZWbsYkMhDA7vQGa_5AzV4aSqSLBWZPOB6Gi86WmdBwPFeNqDuIogrYjU6azMWHshMRczk35Na1PwG36ymZttiOu_sz-A47JOgzwtpe)

Ahora podemos instalar logstash con apt

sudo apt install logstash

En este momento ya se tiene logstash instalado,pero debemos configur de donde recibirá logs, cómo será el filtrado y a donde los mandará, así que creamos el archivo de configuración /etc/logstash/conf.d/test.conf donde definiremos los siguientes parámetros

Con input se definirá el plugin que alimentará a logstash, en este caso será beats. Posteriormente, para este plugin, definimos el puerto sobre el que escuchará y a que host(0.0.0.0 es “todos”)

![](https://lh3.googleusercontent.com/kkoUEwdmMxRvO6dpbS4rnFcMTgWDroETLVPTDiLeHuiR_kjFSknXPp0XxKAl8PXdK5pfEhx4Wf5dGfLNJ1PGogTxoUhF4zueWX-piZwTfr23Sgi5TPf-2eA5ZOOlY1N2zRb80KPe)

Ahora definimos un filtro

![](https://lh5.googleusercontent.com/bLQEoTW8YJ-buPl8YOPOLivKxipi_t4wpNyPh_rC5Ym8Wn9spp5OdLbwZtyFJ34UeJvuCcWCaPlZNzTl2FCodjwjLAIrelvoxr_o3IkPgRjdaNiZF8wB-aVVYiapgfXi5Je1tOSX)

Este filtro toma los eventos auth y error de los logs de apache y los manda a donde le especifiquemos en la siguiente etiqueta.

![](https://lh5.googleusercontent.com/oM-WWglxq8GAxSQ4pxcyAdMMKoyF6F4GSIhpPCnzzhoO_QGkEjdHYA3FRQpf276QZbvi3ontkOyA6o1JWUEcZV25qZq2v_W56zRZmqIHyLimXAJ62amF0leKrNJNJn_qiL71BhcN)

Aquí definimos que mandaremos los logs a una instancia de elasticsearch donde el hosts el “localhost” , aunque aquí podría ir la ip de un host remoto y cuyo nombre será la versión de apache y la fecha.

Una vez guardado el archivo, probamos que no haya errores de sintaxis o de parámetros inexistentes con

sudo -u logstash /usr/share/logstash/bin/logstash --path.settings /etc/logstash -t

Lo cual debería regresar un “ok” como señal de que no hay errores, así como el directorio sobre el que va a escribir

![](https://lh6.googleusercontent.com/CeRI12EJCr_rAUA9QsGmhtCwMwSEegsC_2W-41VyvbEwU30IaY2c7aHNVBdnVGXp-xHV-bQzph9iYkQaIV1IdSvc-N8xb8sPK9bb2n_2P1ijiN9wdX7xWMMWCiERhxCCmaqpgjAo)

En este momento tenemos un logstash funcional.

## Kibana

Es una aplicación gratuita y abierta que permite a los usuarios buscar datos en índices de Elasticsearch y luego visualizar los resultados a través de opciones de gráficos estándar o apps integradas. Los usuarios pueden elegir entre diferentes gráficos y filtrar segmentos específicos de datos. Una vista de dashboard combina estos elementos visuales para compartirlos a través del navegador y brindar vistas analíticas en tiempo real de grandes volúmenes de datos.

Primero descargamos gnupg

![](https://lh5.googleusercontent.com/nhuos2n-GGK7TkIbuIHICBoKJmwpmyOGbwNbvjnJJiJWPlQU9n4XVY_3kzm7EPg6Z5MgA6o0128vq5J2kQOlWEz6dPJlQECteRyvcUuZCIdo-oVZOorLoivo88GUTjSXp2GU4G8o)

Después descargamos la llave PGP de Elastic.

![](https://lh4.googleusercontent.com/qJEkiNLnJ4-olbH6menbKrXmt47V15oyVPX2YKij0Pz1Vxx2_X1ngBnrVolAE5iBkHvjxcRDbzNGuTb8YHsqQ_P3S-T2pu4tr4QfFwl2i5lsUndU387cDLiucBH5KD6k2ZQdWoF9)

Antes de proceder la instalación del servicio, se debe instalar el paquete apt-transport-http

![](https://lh6.googleusercontent.com/XV8K7in2TEtyjKWdzxbi4HnB__Pzk0RAsgI_ju66JppgiHRv_vECyPKghgQG1hHwAWuARIaYOwvFBsDetVRE8OUELGc_1PubgAXeruN8vo2oeGoV9dMgVM6e_6MSOZmtT9fWbxA5)

![](https://lh4.googleusercontent.com/tcB-e1gO03TG2ObYL7Nhwt-KHGTWUCfB_MOVJEvq93ebpx37gq4ZgOFe9rj-RKsmDxDjAz0PGcsKybD5Wd4Ctu9XKYHD4IJ_Dxd4106KE4nUjKdAX_NgJuRAODRpYxwEFBONe3wq)

Se actualizan los paquetes del manejador.

![](https://lh4.googleusercontent.com/MhLsk4IoYvBdG2_Eu0zLJ1jXe_ulf1scDWsxBrfW9Mfb3boGUY_nSxxA13nVkKEaZqgWoarcQHk_3P8GHDqwBuHme8wX1Wo-9yJDrolN44HvT1-0ImAJ5YkigW3etepwzpBoPh9w)

Instalamos Kibana.

![](https://lh6.googleusercontent.com/o25tpvsDlUR0RrOyHqL9byql5GitfJtsCgqP1lPVr7dZDodr5-sW_iBxaMOfgJA22RjAPngqt0nSD09--ZihaQbjLcZ9isQXAzMiWaRUyPLuD0_lqT6zXyyPlALVUaSrNqBeRcMh)

Para configurar que Kibana inicie sin intervención después de un reinicio, se ejecutan los siguientes comandos.

![](https://lh6.googleusercontent.com/tu631k6_7hHVb9k9vmexirl5P4z-vtPXujBmYe4WJDlY4Ze-Vvjl9A5dkFphPwS5D5bUvXLFuaAz71ZpXPkUGCrXwW-dx_EZPfSl2uxXetQEwQAXC-hOcX1t9lffXrB24IuL8Xkp)

Revisamos el estatus del servicio, donde se puede observar que está apagado, se inicia y se checa nuevamente el estado de este.

![](https://lh6.googleusercontent.com/_WKJqgF0uSNyjtEcG62WQkio9uxhlCWjVAMdf_fe8bvebxvVvYhsshxD1PIjrSUzezo8EWUdliPi9-7WMsOt7yx5fzFt8sMxYyQVXlRgylVg7gmCdQ3__JpkusaeHpRlTXm-tJFn)

Revisamos el archivo de configuración, ubicado en /etc/kibana/kibana.yml. Para permitir conexiones remotas, editamos la línea server.host, en este caso ponemos 0.0.0.0. En cuanto al servidor Elasticsearch, la línea a editar es elasticsearch.hosts, donde se agregan las IP de los servidores.

![](https://lh5.googleusercontent.com/_xeiaFAgVj2949UlA-9hYOk26JlTkS-Uu1yr-KA_J_hblzZQgYbYXrUTcIpyjC2pPYmum85wEubXk4DwYpjd-9P4dRFrtsK7q9AMGyKhZXAD8CxDnGNPDvY_X2IBXE143A-_WDL1)

Reiniciamos el servicio una vez se ha configurado.

![](https://lh6.googleusercontent.com/pM8snQviMPtIO5vfLP6gQX9Fm0IJrCw8jr1s-_mpKqGFmdHXO4EFyTLEJiDO50Bt7U8Z8ll5AvgBqwxE_mZATtEdOpY35h0eSQyi4w4mmB8j5fHuOMXD9JY_Bc5lS7HYiHJfiF62)

Ahora se revisa en el navegador, donde se visita [IPKibana:5601](http://ipkibana:5601).

![](https://lh5.googleusercontent.com/1IuLlQfmVnxI6_EduCp3WLMVl16e4Pvmq8ZLdsCZ9X8OEdMHBMSyl2tlVAOrUHUcFTrWl2MVvJbhkYEBtFWj4vH-DwaDu_UdRdm0bqZdVsy7zMj-LhZzJFu2I50Bam2FBYlwmZio)

Al dar click en Add data, podemos observar el dashboard.

![](https://lh5.googleusercontent.com/6PtpR9GX_2dLu3ryxo6fXAN56bljm8SBV64O_QLtr3TrXekNrx_7o5yUVbZ9ag9U7XwGXmf2BB7VRKPd3VBo6yBktkweMEDvXiudlUS-Joja67M5RyKSNXX70bS1-JFP4CLVGi9G)

## Configuración de TLS-HTTPS

Kibana tiene como requisito poseer una conexión segura a través de TLS y HTTPS para poder hacer uso del servicio de reportes, de modo que en la siguiente sección se aborda el proceso de configuración requerido.

Lo primero que debemos hacer es configurar nuestras estancias de Elasticsearch. Ingresamos a la instancia principal y nos cambiarnos a modo superusuario.

![](https://lh5.googleusercontent.com/jAzJJ324p2PpA4c21cvog7GeFut2LdcmAbmQ9vG24lpXvA_FNoqX2lwdpRn1RVe2Pn3Wlfo_VTrMydQTNBvdFd-PrcHLhXp7-XNCRrTuSswN0Wce2HlMG7U-_m0N-2zcKKEEoc2N)

Posteriormente instalamos curl en caso de que no contemos con dicha herramienta.

![](https://lh3.googleusercontent.com/DeoRMSRdvDiK28p03nzgHnLKmVgu0OwVaNoISh0g-obobo82S5aS32_jexNRJoXsm8IrZ_OouT_BWc8e_BletC3d24U66hyLN1eGmH9nf6c5DMkVrpPGQRwo_uzQ_wD3M0P87urn)

Una vez instalada procedemos a verificar el estado de elasticsearch mediante curl.

![](https://lh5.googleusercontent.com/TyhcPnuLjih8jf7QbVCB8Sno_Nw4y0vj4oOG7hewwVB2wwePclv-m1dvatT2vimG5muJ3g1m4XFGGIMzDJk9pP3u_cwA2MW3sSI48xzkjIAzUwTXajWoPdAjx-58Q-UdhexjwGSF)

Ya que estamos seguros de poder acceder a nuestro servicio de elasticsearch a través de peticiones HTTP, nos cambiamos al directorio /usr/share/elasticsearch.

![](https://lh5.googleusercontent.com/jo0LNua5Lg__iNNLkb1PY11teOlIn5C671uXd41l_xF_dI3y1UrnEdfkQ7d7Iw-aTjCN8LHlAGktZI_0FGLbU-DkYZe6Qk7eGlNt1IGtjXLlA8WTnU_pJXiA5aL1gLWNUv3nFYaQ)

Ahora generamos nuestro archivo CA a través de la utilería elasticsearch-certutil de elasticsearch.

![](https://lh6.googleusercontent.com/vOwIx7wZngp90Efj9rVoJ9RkfczW4fYS7K51AVN5ZNFfiVbPWpElH4O2j8V4Cn1Hzs7h1ibJunKEa6qz9_Ecv0DfBEMoq8R86jyvaToUITDpW5c0G76OkXeeeUYg5AgNL4N9Ai77)

Ingresamos la ruta de salida del archivo, así como la contraseña asociada. Ambos campos son opcionales y pueden dejarse en blanco.

![](https://lh6.googleusercontent.com/chjP6BGIaD5c-AY1cVMPG2n3CB7FK3PFo3ggoE8VomhsVjd4ZFnWwYNPQu1vhIYexRvk7JSwIXj33T--Lcc7YrcSao_Lpfd5pY5biFipZMuOGkbgWh_CGfFTVgrfrr78AGad0uAM)

De la misma forma generamos un certificado a partir de nuestro archivo CA que acabamos de crear.

![](https://lh5.googleusercontent.com/XPkzOtUMEso-Q90Hu0t5ncX6PlpNAWZf209_1-zwuzewrL-ppTxwYc_cEv38Ymv9__ns2F4yzmkfnN1uZ_DTAxMS1DWHpGV7XOoOOJoWSp49aj0NPuuqGdGRLiVCd0XvEv12ZHUM)

Ingresamos la contraseña del archivo CA (en caso de que la tenga), y nuevamente la ruta y contraseña de archivo de salida, los cuales también son opcionales.

![](https://lh4.googleusercontent.com/UwxiFFYeqvUXPaFIF9QGdAjsQw3Y40SYos9U35N1sAHVTZdCfypjPkfL8OW2ukZmDBcJjvKuNJAnj48_eVZUcsAvhhf2_zWXqjIur_5R7ZzJe60y5s3lE-E6tyHM5y7jwbqfUvLJ)

Ahora movemos el certificado generado a la ruta /etc/elasticsearch/.

![](https://lh5.googleusercontent.com/4gZBaVFetlflXD26F749zLh1i_8WDgra9mRF5gs5kvj1ED9XwpPKQFfT6q-J4OTLcySpFRb1dVdr6Iw_bvSDGy3gy6SaKilb-eY543_YwlP_fvJ6j9KC0twknxIO5gpYqR3kTCTu)

Editamos el archivo de configuración del servicio de Elasticsearch ubicado en /etc/elasticsearch/elasticsearch.yml.

![](https://lh6.googleusercontent.com/EFQuKu4JYNfk22Eh-GGrrqZZx1SziJq71FFIBOb2yc7Vr6z8AQnHKHhJhDGI-R4bFnzxIOj1LXc3dUhHbvK03Y_w8bX2jZBolmgSAtMgn4taqXsIFwW4NcJgTdrsYENfZs1tFT_-)

Al final del archivo ingresamos el siguiente contenido, el cual habilita TLS e indica la ruta al certificado que acabamos de generar.

![](https://lh4.googleusercontent.com/KTYbf9GEnFDbuiX_48LB0zpuVnlKk3V0wo5BwcVTMuQB0cHF-WYqHr6RTBlPOuRKB_Se0vjR1uMr5Rj1-GNVWUc-Cc2Xno4HDHpOrvlaCq5E2MbsturFHFF_hz7roYz010ld_3NJ)

Posteriormente cambiamos el propietario del certificado de modo que pueda ser leído por el servicio de Elasticsearch.

![](https://lh5.googleusercontent.com/ISv5q0-jjJVCDipz07UFxCq3WvVFtVTYS2CmST8fNpuMydnNhevKE3bqJt_ZXGaaGaviAeIU_WmUrob35VNIT_5hrXD6oRuBnb1bvvK_m3HthlSbLCZ9d8-tx-TaU4IC_Kzxodec)

De igual manera cambiamos los permisos de acceso del certificado.

![](https://lh5.googleusercontent.com/uLhkLVx8_CpSkHlmRxxudGE6OMhiP7aFgiFIVV8wiLB8AhmYjvbIsAZgOzrJCYzl9o6nFIYRikbPzP3bGYWJQm2w-MwqCJ2ta2SpNgx-sWwGIKPNdZf--gX08Ei8MRsFma3n6ytR)

Reiniciamos el servicio.

![](https://lh3.googleusercontent.com/lsqa0rUWnNZxl57QQhlt2x1yPEyrotm5eXFVMOs8XzQ0KiB2Vx4etGhuF6pQS59ZFXsFt1XnRW7zFnTD9Ioo_C6hmDPSglMRkzUQoaSPuCZNO9O0W_4I01dZ0Jt4-qaXV2BQ5kll)

Una vez que se reinicie el servicio podemos generar las contraseñas para cada uno de los usuarios asociados a los servicios de nuestra pila ELK. Esta tarea se hace a través del comando /usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto, el cual genera de forma automática las contraseñas para cada usuario. También es posible indicar la contraseña de forma manual para cada usuario proporcionando la opción manual en lugar de auto.

![](https://lh5.googleusercontent.com/eMmvLF-xcItCeNSBW07mP2SZ5BTw-94K7zV8iLbStLRgJUu00cZ45KIroFDATh0A-zy5QslcIswij25oQtXjQCFruTZ1yFSmTEv6jP_v_6vNar4c4NxOYT_YzTfoAU8SMLfbSrID)

La utilería desplegará en la salida estándar los usuarios y contraseñas para cada servicio, por lo que se deberán guardar dichas credenciales en un lugar seguro.

![](https://lh5.googleusercontent.com/5U9FChyhRfLbpUBIZI0t4L3ZL2k1I_wFC0OflqL8iVe1U0MrQHWlQ3jZc7WOcf5joYeZF-Jk_htkGusJVNllInhdWjhH6scsl4-gz_W52iVLeDbSWI2C2z7E_s1ZvIRxAKAl_78t)

Ahora podemos verificar la conexión mediante las credenciales a través de curl. El comando es casi el mismo a excepción de que ahora se proporciona la opción -u elastic:<password>.

![](https://lh6.googleusercontent.com/uWsPFd4xluq6KQFUIBTFM0ghi3GeOyTBuO0YJq9U2eOfONMuLLmBq2qSkLsJ9pURZS0Ga1xvgPQ4Hpv93xDImgx7-XtKPKhEf92Yw8iIZWvLzoxIk56UqY9MXmsa98YKgaWlwEeG)

Lo siguiente es habilitar HTTPS ingresando el siguiente contenido al final de archivo /etc/elasticsearch/elasticsearch.yml.

![](https://lh3.googleusercontent.com/eT0_bOer0HI1Rx91mMBry-ASTKlBlUfjAYJBScRBb8IUqUWDr2sYAmG8MJy2mjQyhOkT3tfJmTWj7E4Jn9vBVGr773374iBXhFU45uILNs93SWPvEoPH9SKhUGMrxLBR8DGET5bv)

Posteriormente reiniciamos el servicio.

![](https://lh3.googleusercontent.com/lsqa0rUWnNZxl57QQhlt2x1yPEyrotm5eXFVMOs8XzQ0KiB2Vx4etGhuF6pQS59ZFXsFt1XnRW7zFnTD9Ioo_C6hmDPSglMRkzUQoaSPuCZNO9O0W_4I01dZ0Jt4-qaXV2BQ5kll)

El siguiente paso es generar un certificado en formato PEM para los servicios de Kibana y Logstash. Para ello nos cambiamos a la ubicación de /etc/elasticsearch y ejecutamos el siguiente comando.

![](https://lh3.googleusercontent.com/2Oh-bQYbpi2UXDMmc-EqO2DreFXmsQkdgbRQZiN-pTQhVqsU4mmgoK5vBAU4StFclWC7FihDyPHGpSvMpn02k0A55A2NpUe819j_iwHQSpzvFy60QXYoyHhIQ_XLZ6EZt8ix0YVg)

De la misma manera, ejecutamos lo siguiente para generar una llave en formato PEM.

![](https://lh6.googleusercontent.com/c3JZ0nOTXJG6YWwWWSrnB1GjNaiQHD-AC6OmLUIA-Q8eIVxxOxdlMdd8mKMJpYtPBI5gF8nOlvjDV59J7gTPAPQfcaJcQhzZMydqdiGI3sF2XCmZo9blyQ-o2cmV2wRosBLTWlCN)

Ahora deberemos copiar dichos archivos a la instancia de Kibana, ya sea mediante SCP, una USB o algún otro medio de transferencia. Una vez transferidos, movemos dichos a la ruta /etc/kibana/.

![](https://lh4.googleusercontent.com/wlNTXo9Q9VFp0sjeDbJUVu_JqN2qxyPizQX7WdSbdJ6VNCP6OnE9YeI6Ja8hJzZyoAAfTso-x5nzwRcteYSt5eeHRLW0YLbzs8yvPVDPDPHx55AWJbtfycls1SP0pfi8aLrh2FVb)

Luego cambiamos propietario y permisos de forma que el servicio de Kibana pueda acceder a ellos.

![](https://lh5.googleusercontent.com/SXp9YIDHwKeUvg5Cx8xdhco-V45-D_21gYl8mGkW3zMZzb5HBGStIewagPwbaKYb_qXgtyKp2qBrJ0z9xBj3MqwDuZqHwlwDCkoq5qf13c0FVb95q8Js9fQIcpPwYkfftoNvTzvP)

Abrimos el archivo de configuración de kibana mediante algún editor de texto.

![](https://lh5.googleusercontent.com/_XWa3wAYNIQ1SKrKB1u-UbxPTDEXn0ur4t3ElsGv8KybqMXEakMoR9tZxLsoEQHIm_z9phcbo_FR_4HQSL4eFXhGeTr0ouYQ1Ut_b3EnKpV_4F8Y6m0jR5RrBbSl_gAmi_FU-yte)

Agregamos el prefijo https:// a cada una de las direcciones asociadas a las instancias de Elasticsearch.

![](https://lh3.googleusercontent.com/2qOAAqcWphTeguIJA6pSS0S_oufLqEAyPSnlUqHjSaWepUk5UYjNOJiL7pIfv87x_tf5JZB3EOeMDACgt37JMSFM5wvRRqwQskcSrbrChve3d5zZbzWSEZLJlyAsLNxMLAKslNI1)

Agregamos el siguiente contenido para habilitar las conexiones seguras e indicar las credenciales de acceso, así como la ruta a la llave y certificado que generamos anteriormente.

![](https://lh5.googleusercontent.com/FFmpCcD3GE3PXcsZ8WU-frC4Jri2WVqVQDuEGCEmSa66K6JQhmtNqYK1F4oKBHtHXdzfHHuHDV0Vo-AkyniCqAPPrYltkPqTPuCSANgJ0jpjl5n-RdMj_lvLoR7W-odDNV3hbCWj)

Luego reiniciamos el servicio de Kibana.

![](https://lh4.googleusercontent.com/YT-y2-5gVBOkKiiqlI34IOwiLENUneXkHxPQX3PEaJe_YuxdZh9eVCRCWM7zUsIRp6yvH0Ez2JlnuIHwSpQzvZbaJHp6SdKjNvgLFD9Vx_iv8iN_v2pqsUunWqmfLm50Hgrz4qQ0)

De igual manera, deberemos configurar Logstash para habilitar conexiones seguras. En este caso debemos transferir el certificado en formato PEM a nuestra instancia de Logstash y colocarlo en la ruta /etc/logstash/.

![](https://lh3.googleusercontent.com/9-Mn1Ld0UmitxtbxsyucJaYswL4MC3Q7_VZSRy3-jgjoOxjHtj0vBG6exkQG1eDmixge_qggtVvLyByWApNbUx_79gYU2QTie-4BSsprTTFLiHgpsg3TutYJ97-eJrToBLzl7knb)

Nuevamente cambiamos propietario y permisos de tal manera que sea accesible por el servicio de Logstash.

![](https://lh6.googleusercontent.com/EfpQVZGmuXMRWBToT0XAsKKffHnmTiV00wkdAYreiNtKH3N9ZlnKXaNEU-8fZWjcI94vW-ctqPmhDBySgo0NwSoGpYAnUf_3BrEOEau7cWkXE2OVwGuD4N9D2WAuz3OSl0RBN5TS)

Ahora abrimos el archivo de configuración de Logstash mediante un editor de texto.

![](https://lh6.googleusercontent.com/3sIonNqEe07nOByO8-9SDdIsA6RTmOgPxpg0UwnRx7wZzIQ92TsbDtZhCUv4eZhC2dRWbHxxAJkfqeQsJkC6PdK7tzkMJNqzapNhRNPIapihNNeM-AJYvousVMjO8xt3z3Iypvg4)

En la sección de output debemos agregar el prefijo https:// a cada una de las direcciones asociadas a las instancias de Elasticsearch. Además, mediante los campos user y password indicamos las credenciales de acceso. Por medio del campo cacert indicamos la ruta al certificado y a través de ssl_certificate_verification indicamos que no queremos realizar una verificación del certificado.

![](https://lh3.googleusercontent.com/GGAWInkPm1hicWFqysaszX_zWE1l9rodWnTiHv158qP0t7gevx3YntVyUaNzRFQfDEC04JsI9ncUeh5QCM_rHk4qPPJeEapLgvgQY6-GZW80crlZsHHJ974fIc8p1Ds9yrSZFGrU)

Finalmente reiniciamos el servicio de Logstash.

![](https://lh3.googleusercontent.com/7UyIWjy9Ju-7bH0x2kr0n52_78o1HdK2v-U8X_kWlqCU8_zcQrALktArJ5OFJ8xE0yW3lvTbflrixb-8pnMQm-U6rRKHGfo8TuFpN9GWyy5fiTGmWUZsXS6G6PFjqSG0S53XKUK2)

Por último, ingresamos a Kibana a través de HTTPS y mediante las credenciales del usuario elastic.

![](https://lh6.googleusercontent.com/65OBrzQHdjhqHE6r1KTVGBoDyQYcnrhDamWSqlxOp8TSVlkYteMewLC9NrJndZ-gKGayYvMYW-LRaijmFlWkiFEMe8_E8HM7rXKwulTbXceqYWoqG3X4KUXQVpylhQKpDJtYXrm_)

Nos dirigimos a Management > Security > Users > Create user. En esta nueva ventana ingresamos los datos de un nuevo usuario con rol de superusuario de modo que no tengamos que acceder a través del usuario elastic.

![](https://lh5.googleusercontent.com/IXyXQR5eJpS2voYsqxUDfU1BZuDCewK954i-YGxVTEYM2fQOTopbdcNdUbdRCIM1Dg4x5aUjn3RwGeC02aOu9Qsy6vzf1q0CZkXft4A8P4tBhOrV0i8aNFHvOqTj70cHRU5jghXc)

## Generación de visualizaciones en Kibana

## Dashboards

Kibana posee paneles de visualización llamados Dashboards, los cuales nos permiten observar gráficas, métricas, líneas de tiempo, bitácoras, etc; todo en un mismo lugar.

Para crear un dashboard simplemente seleccionamos la opción Kibana > Dashboard, ubicada en el panel izquierdo. Posteriormente en la nueva ventana hacemos click en Create dashboard.

![](https://lh4.googleusercontent.com/QtQ_x4nrn_KmvTIAJePJ3YVQqdrecKJSwDeQlGMKJRkIS7BXgiX7UKitOzsK3iHJa9rQVOKsEbQJfg16xjgOLMyFvHAmDH1BHYUvN6G4EZLOLEzVCSj-6BsBJ_Rn4Rw0oDW97a08)

En la nueva ventana se mostrará un recuadro que nos permitirá agregar un objeto existente o crear uno nuevo. Al seleccionar la opción Create new, se nos llevará a la ventana de creación de visualizaciones, por lo que se deberá seguir el proceso de creación de visualizaciones descrito anteriormente. En el caso de seleccionar la opción Add an existing, se desplegará un nuevo panel del lado derecho en el cual se podrán seleccionar los elementos que deseamos agregar a nuestro nuevo dashboard.

![](https://lh3.googleusercontent.com/IjtOFCsj3KEuPvwSaaDGpBNfEjvb75YUKreZo4LDrwSGaGl9jRo2_V0Lojqgmy33Np6djVNfTcpl0aptRL_UPW1_iJg5inELer2xfWovXSWWzq4UvkVGzJevZTke6hv2RchkBQYN)

En el panel lateral derecho podemos navegar entre los distintos tipos de objetos creados y seleccionar aquellos que deseamos incorporar al dashboard. También se cuenta con la opción de crear un nuevo objeto.

![](https://lh3.googleusercontent.com/WAWqeyENYTH6y2E-43F6-Urd6zmzirBdVzaZKBF7QC1-acZsJscbTDUfcsjsYiCiHE1a0hJXQU9uVrqMLO8uP7MzEXdhj-jWSPPDgwYeeiJp96QEij8cqL0FmfXEifIePxbBEDg0)

Ya que hemos seleccionado los objetos que nos interesan, podemos reorganizar y redimensionar cada objeto a través de la marca inferior derecha.

Una vez realizados todos los cambios, podemos guardar nuestro dashboard haciendo click en el botón Save.

![](https://lh5.googleusercontent.com/tNr_IbK2iBNrsYtfwr0MNywgV8TbqQnQzR7qpPcHxM0qjpQTYSbcYNCEMDzey2iWwaH5H1wLwMz6BUmqYUvAAIvczSKWuCaBPisgnKsHiphiBVtys1s_0ZwGrklcLOEpp0ElunY4)

Al guardar el dashboard deberemos asignarle un título y una descripción. Una vez ingresados podemos hacer click en Save.

![](https://lh4.googleusercontent.com/D7TDXDrpA8S4lEWNCKmmtVpR6qEE1qjJiYZmPW2VdZwjyw_ATJyhYlpWkWMZhzhSiUmUtV1cvAgxAD9K2jh926L_DdtC3M7EGDrDDnUN76ZuMpM09kEtzN0FMr3XeemcxMnH8cQq)

Si nos dirigimos nuevamente a Kibana > Dashboard desde el panel izquierdo, podremos acceder a los distintos dashboards que hayamos creado.

![](https://lh5.googleusercontent.com/LgpHHbBH0v2q_NlRWNhl8wQSbI_0fmlso29TIlJ6vov9v1CYh2DQCSmnBXPRj-HVbmnsix95VwkX6RUhwJittEv1pUvDZfPXvH_uCTNYb1Nyq6e4gMc4Mxr_v-vfvprWPzEXjNaW)

### Email Dashboard

El dashboard de Email está compuesto por distintas gráficas, métricas, una línea de tiempo y un panel de bitácoras.

La primera sección del dashboard permite observar la cantidad de emails procesados (enviados y recibidos), cuántos de ellos fueron clasificados como Enviados, Rebotados o Diferidos. Además, se cuenta con una gráfica que muestra la distribución de emails, es decir, qué porcentaje de los emails en cuarentena son SPAM o se detectaron como malware; y qué porcentaje de los emails entregados se encuentran limpios, son SPAM o no pudieron ser verificados.

![](https://lh5.googleusercontent.com/rXH1yKnDgaNAwuXSuyuQM3nlAyki9QwhPke4C4Kr-7-pgJ6SJECb2oiXITwdqqJf5XfqzKh-uWQ37jHELmGT1tTfMIdUOit_G63BmU-JJph6T8LNpOI91IpiRMWgukkZ_PN3TlI6)

La segunda parte muestra métricas sobre email enviados y recibidos, así como la cantidad de bytes enviados y recibidos. Además, se cuenta con una línea de tiempo que permite observar los estados de los emails a través del tiempo.

![](https://lh6.googleusercontent.com/3tci7uyNncGFyPbGb4Lnb-Vl6Na1g_FmGfMKAc0e-evh7JcW7T51BwVHz4ss8WMJ8fbgzaLk5oXfGLL6dq90r4WurxsChU6BHIGc7oFCmDjveYg518Td-hMGon00mI8Fk3FSsSdM)

La siguiente sección permite observar un top 5 de direcciones de correo de remitentes y destinatarios, así como un top 5 de países y direcciones IP de clientes de correo electrónico.

![](https://lh4.googleusercontent.com/M1iSXzl_u_K4Aa6LrUQqbQY1WgAkS2XhbG1qn2oULUYwhKfOzR0tFYQ7cHAmYwayTf-y2KgKLghTJ69l1oo4bp_lw_39neT5Pp-qn-GALtzFif-uHPJpfodtETy3eAzvPpOWNoCM)

Posteriormente podemos observar un top 5 de países y direcciones IP que envían más SPAM, así como un top 5 de países y direcciones IP que aquellos que intentan utilizar el servidor de correo como relay.

![](https://lh3.googleusercontent.com/rhaGK651atL5b2j4Z1uEdk7C9HVR2U1RkkNupcXRE3m3NaSF72Hlk5YtyH6QCQfKcRyTQfgq8Bkp_d5JbGDMRMglFu00sDwcwGL04DhueGnpUPDZH7gQEh80thX1wHZesOkXucjR)

También se muestra un top 5 de países y direcciones IP que envían emails con direcciones de remitentes inválidas, así como aquellos que tienen más fallos de autenticación. Esta sección nos permite identificar posibles ataques de enumeración de usuarios o ataques de fuerza bruta.

![](https://lh5.googleusercontent.com/IAuD3UzzR8Tb3VdSl-VAByyk8aP-3mwXW6FjP__3G3znWOcYWeSz_2AXR0sz9RIh__pUT18_m5VpLhuciYFKLK1iL-6QAzVwqh-YwzeUn0CVWWXTNkmVLcxA80BWhDSkiMqyIPQ7)

Finalmente se cuenta con una sección que muestra un top 5 de países y direcciones IP que cuentan con la mayor cantidad de autenticaciones fallidas en los servicios de IMAP y POP3 (Dovecot). Esta sección nos permite identificar posibles ataques de fuerza bruta sobre IMAP y POP3.

Además, se cuenta con un panel que permite observar las bitácoras del servicio email.

![](https://lh3.googleusercontent.com/TMjwkLKS4aDexj5N8jhXAdCL31B8g9ocGER6yVlUfZil3dkx8KUOVNi5yPD0J72q6PsCIFwI-qNZ-SzgHm-bYfMSfp9Ts9WnhqBVc81OKBBXJ3H9CCUM0waPi_BNYQZ6kO9FN1f2)

### Web Dashboard

Para el servicio web obtenemos el total de logs que se han recibido, para esto creamos una visualización tipo Metric, donde incluimos el filtro para que este cuente los logs tanto del servicio![](https://lh4.googleusercontent.com/GjEXamdP1aD-3vWYB8fGDu3OS6WSO9C4_eep1Nsy0F0gVpibUIuq3TSRd7qtITsc65UC11dFypgKxu-7kHL71VZTsaM6RjhZ3Wt4PcPMYTIyNZ6GIOd5UaY8thaq7BESDfFfFh20)![](https://lh6.googleusercontent.com/eMcEDrucOxHi_DR_7-ivVSqYcrYQnRRx6kGeZXz
